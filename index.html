<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>卓タイマー管理 + 控室（スプシ連携）【DEV】</title>
  <link rel="icon" href="data:," />
  <style>
    :root{
      --bg:#f4f6f8; --panel:#fff; --text:#111;
      --red:#e74c3c; --blue:#2e86de; --vip:#9b59b6;
      --ok:#e7ffe7; --warn:#fff3cd; --danger:#ffe0e0; --gold:#ffdd57;
      --staff-on-bg:#e6f4ea; --staff-on-border:#34a853; --staff-on-text:#0b6630;
      --staff-busy-bg:#fff3cd; --staff-busy-border:#f59e0b; --staff-busy-text:#7a4e00;
      --staff-off-bg:#f1f5f9; --staff-off-border:#cbd5e1; --staff-off-text:#94a3b8;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Arial,sans-serif}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px 14px;background:#1f1f23;color:#fff;position:sticky;top:0;z-index:5}
    header h1{margin:0;font-size:18px}
    .toolbar{display:flex;gap:8px;align-items:center}
    .toolbar input{padding:8px;border-radius:8px;border:1px solid #ccc;min-width:220px}
    .now{opacity:.85}

    .top-tabs{display:inline-flex;gap:.5rem;margin-left:1rem}
    .top-tabs .tab{padding:.35rem .8rem;border:1px solid #ddd;border-radius:999px;background:#fff;color:#111!important;text-decoration:none}
    .top-tabs .tab.active{box-shadow:0 1px 4px #0001;font-weight:700}

    main{padding:12px;display:block}
    .page{display:none}
    /* ← JSが落ちても白画面にしない保険 */
    #pageTimer{display:block}

    /* ====== Floor / VIP / Roster（本鯖UI） ====== */
.floor{
  position:relative;background:var(--panel);border:1px solid #ddd;border-radius:12px;
  overflow:hidden;padding:4px;min-height:750px;
}
.legend{position:absolute;left:8px;top:8px;display:flex;gap:10px;flex-wrap:wrap;font-size:12px;opacity:.9;background:#fff9;border-radius:8px;padding:6px}
.dot{width:10px;height:10px;border-radius:50%;display:inline-block;border:1px solid #999}
.dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.danger{background:var(--danger)} .dot.empty{background:#eee}

.seat{
  position:absolute;background:#fff;border:2px solid #bbb;border-radius:10px;
  padding:6px;min-height:64px;min-width:80px;cursor:pointer;
  display:flex;flex-direction:column;gap:4px;transition:transform .05s, box-shadow .1s, background .2s;
  box-shadow:0 1px 0 #0001;
}
.seat:hover{transform:translateY(-1px)}
.seat.red{border-color:var(--red)} .seat.blue{border-color:var(--blue)}
.seat.active{background:var(--ok)} .seat.warn{background:var(--warn)} .seat.danger{background:var(--danger)}
.seat.highlight{box-shadow:0 0 0 3px var(--gold) inset}
.line1{display:flex;justify-content:space-between;align-items:center;font-weight:700}
.line1 .endAt{font-weight:700;font-size:18px;opacity:.8;margin-left:10px;white-space:nowrap}
.timer{font-size:18px;font-weight:800}
.meta{font-size:18px;line-height:1.25;opacity:.95;overflow-wrap:anywhere}

/* VIP row */
.vipRow{position:absolute; left:15%; right:15%; bottom:7%; display:flex; gap:12px; z-index:2;}
.vipSeat{
  background:#fff;border:2px dashed var(--vip);border-radius:12px;
  padding:10px;min-height:100px;flex:1;cursor:pointer;display:flex;flex-direction:column;gap:6px;
}
.vipSeat.active{background:var(--ok)} .vipSeat.warn{background:var(--warn)} .vipSeat.danger{background:var(--danger)}
.vipSeat .timer{font-size:22px}

/* Backstage */
.backstage{background:var(--panel);border:1px solid #ddd;border-radius:12px;padding:10px;margin-top:12px}
.backstage h2{margin:0 0 8px;font-size:16px}
.legend-staff{font-size:12px;opacity:.8;display:flex;gap:12px;align-items:center}
.dotS{width:10px;height:10px;border-radius:50%;display:inline-block}
.dotS.on{background:#145768} .dotS.busy{background:#6b480a} .dotS.off{background:#9ca3af}
.roster{display:flex;flex-wrap:wrap;gap:8px}
.staffChip{padding:6px 10px;border-radius:999px;border:1px solid #cbd5e1;background:#f8fafc;cursor:pointer;font-size:14px}
.staffChip.on{background:var(--staff-on-bg);border:1px solid var(--staff-on-border);color:var(--staff-on-text);box-shadow:0 0 0 1px #0e3d49 inset}
.staffChip.busy{background:var(--staff-busy-bg);border:1px solid var(--staff-busy-border);color:var(--staff-busy-text);box-shadow:0 0 0 1px #3a2706 inset}
.staffChip.off{background:var(--staff-off-bg);border:1px solid var(--staff-off-border);color:var(--staff-off-text)}
.staffChip.selected{box-shadow:0 0 0 2px #111 inset;font-weight:700}
.staffSectionTitle{flex-basis:100%;margin-top:6px;font-size:12px;color:#475569}

/* Modal（本鯖UI） */
.modalWrap{position:fixed;inset:0;background:#0008;display:none;place-items:center;z-index:9}
.modal{background:#fff;border-radius:14px;padding:16px;min-width:300px;max-width:92vw;box-shadow:0 20px 60px #0006}
.modal h3{margin:0 0 10px 0}
.row{display:flex;gap:8px;margin:8px 0}
.row input{flex:1;padding:10px;border-radius:8px;border:1px solid #ccc}
.btns{display:flex;flex-wrap:wrap;gap:8px}
button{border:none;border-radius:10px;padding:10px 14px;cursor:pointer;background:#111;color:#fff}
button.secondary{background:#e5e7eb;color:#111}
button.danger{background:#dc2626}
.chips button{background:#fff;border:1px solid #111;color:#111}
.label{font-weight:700;padding:6px 10px;border-radius:999px;font-size:12px;line-height:1;align-self:center;white-space:nowrap}
.label-extend{color:var(--vip);border:1px solid var(--vip);background:#f7ecff}
.twoCols{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
.suggBlock{display:flex;flex-direction:column;gap:4px;flex:1}
.suggTitle{font-size:12px;color:#6b7280}
.suggList{display:flex;flex-wrap:wrap;gap:6px}
.suggList .staffChip{padding:4px 8px;font-size:12px}

/* 売上入力ピッカー（本鯖UI） */
.pickerField{border:1px solid #dcdfe3;background:#f9fafb;border-radius:12px;padding:8px;min-height:46px;display:flex;gap:6px;align-items:center;flex-wrap:wrap;cursor:pointer}
.pickerField.empty{color:#94a3b8}
.pill{padding:4px 10px;border-radius:999px;border:1px solid #cbd5e1;background:#fff;font-size:12px}
.pickerWrap{position:fixed;inset:0;background:#0008;display:none;place-items:center;z-index:10}
.pickerPanel{background:#fff;border-radius:14px;padding:14px;max-width:92vw;max-height:80vh;overflow:auto;box-shadow:0 20px 60px #0006}
.pickerHead{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px}
.pickerBtns{display:flex;gap:8px;flex-wrap:wrap}

/* 延長回数バッジ（本鯖UI） */
.extBadge{
  display:inline-block;margin-left:8px;padding:2px 6px;border-radius:999px;border:1px solid #6b7280;
  font-size:12px;line-height:1;opacity:.85;background:#fff;
}

/* 売上のボタン文字が薄くなる問題の固定（本鯖と同じ） */
.sales-pill{ color:#111 !important; }
.sales-row .sales-pill{ color:#111 !important; }


    /* === sales-pill を白地・黒字に統一 === */
    button.sales-pill{
      background:#fff !important;
      color:#111 !important;
      border:1px solid #cbd5e1 !important;
    }

    /* 触感ちょいUP（任意） */
    button.sales-pill:hover{
      background:#f8fafc !important;
    }



    @media(max-width:900px){
      .toolbar input{min-width:160px}
      .seat{min-width:72px;min-height:60px}
      .sales-grid{grid-template-columns:1fr}
    }
  </style>
</head>

  
<body>
  <!-- DEVバナー -->
  <div style="position:fixed;right:300px;top:8px;padding:6px 10px;border:1px dashed #888;font-weight:bold;z-index:9999;color:#fff;background:#222;">
    開発用（DEV） / ROOM_ID: dev
  </div>

  <header>
    <h1>卓タイマー管理</h1>
    <div class="toolbar">
      <input id="q" type="search" placeholder="キャスト名で検索（例: あや）" />
      <div class="now" id="now"></div>
    </div>
    <nav class="top-tabs">
      <a id="navTimer" class="tab active" href="#timer">卓タイマー管理</a>
      <a id="navSales" class="tab" href="#sales">売上入力</a>
      <a id="navAdmin" class="tab" href="#admin">幹部</a>
    </nav>
  </header>

  <main>
    <!-- タイマー -->
<section id="pageTimer" class="page">
  <section class="floor" id="floor">
    <div class="legend">
      <span><i class="dot empty"></i>空席</span>
      <span><i class="dot ok"></i>計時中</span>
      <span><i class="dot warn"></i>残り10分未満</span>
      <span><i class="dot danger"></i>残り3分未満</span>
    </div>
    <div class="vipRow" id="vip"></div>
  </section>

    <section class="backstage">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
      <h2>控室（スプレッドシート連携）</h2>
      <div style="display:flex;align-items:center;gap:12px">
        <div class="legend-staff">
          <span><i class="dotS on"></i> 出勤（空き）</span>
          <span><i class="dotS busy"></i> 接客中</span>
          <span><i class="dotS off"></i> 休み/退勤</span>
        </div>
        <label style="font-size:12px"><input type="checkbox" id="editDuty" /> 出勤を編集</label>
        <button id="reloadStaff" class="secondary" type="button">更新</button>
      </div>
    </div>
    <div id="roster" class="roster"></div>
  </section>
</section>

    <!-- 売上 -->
    <section id="pageSales" class="page">
      <section id="salesSection">
        <div class="sales-card">
          <div class="sales-grid">
            <label>ボーイ（1名）<div id="boyField" class="pickerField empty">タップして選択</div></label>
            <label>キャスト（複数可）<div id="castField" class="pickerField empty">タップして選択</div></label>
          </div>
          <div id="salesLines"></div>
          <div class="sales-actions">
            <button id="addSalesLine" type="button" class="sales-pill">＋ 明細行を追加</button>
            <button id="submitSales"  type="button" class="sales-pill">送信</button>
            <button id="reloadSales"  type="button" class="sales-pill">更新（商品・名簿）</button>
          </div>
          <div class="sales-total">合計：<span id="salesTotal">¥0</span></div>
        </div>
      </section>
    </section>

<!-- 幹部 -->
<section id="pageAdmin" class="page">

  <!-- ログインカード -->
  <div class="sales-card" style="margin-top:12px">
    <h2 style="margin:0 0 8px">ログイン</h2>
    <div id="adminLocked">
      <input id="adminCode" type="password" placeholder="幹部用パスコード" style="margin-right:6px">
      <button id="adminEnter" class="sales-pill">入室</button>
      <div style="font-size:12px;color:#64748b;margin-top:6px">* 店舗で共有する1つのパスコードだけで入室します</div>
    </div>
    <div id="adminUnlocked" style="display:none;display:flex;align-items:center;gap:8px">
      <span style="font-size:12px;color:#64748b">幹部モード</span>
      <button id="adminLock" class="sales-pill">ロック</button>
    </div>
    <div id="adminWrong" style="display:none;color:#b91c1c;margin-top:6px">パスコードが違います</div>
  </div>

  <!-- ホーム（4ボタン） -->
  <div id="adminHome" class="sales-card" style="display:none">
    <h2 style="margin:0 0 8px">幹部メニュー</h2>
    <div style="display:flex;flex-wrap:wrap;gap:8px">
      <button type="button" class="sales-pill" onclick="location.hash='#admin-staff-list'">従業員管理（一覧）</button>
      <button type="button" class="sales-pill" onclick="location.hash='#admin-staff-add'">従業員管理（追加）</button>
      <button type="button" class="sales-pill" onclick="location.hash='#admin-prod-list'">商品管理（一覧）</button>
      <button type="button" class="sales-pill" onclick="location.hash='#admin-prod-add'">商品管理（追加）</button>
    </div>
  </div>

  <!-- ===== 従業員：一覧 ===== -->
  <div id="adminStaffList" class="sales-card" style="display:none">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
      <button type="button" class="sales-pill" onclick="location.hash='#admin'">← 戻る</button>
      <h2 style="margin:0">従業員リスト</h2>
      <button type="button" class="sales-pill" style="margin-left:auto" onclick="location.hash='#admin-staff-add'">＋ 追加ページへ</button>
    </div>
    <div id="stList" style="margin-top:8px"></div>
  </div>

  <!-- ===== 従業員：追加 ===== -->
  <div id="adminStaffAdd" class="sales-card" style="display:none">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
      <button type="button" class="sales-pill" onclick="location.hash='#admin-staff-list'">← 一覧へ</button>
      <h2 style="margin:0">従業員追加のページ</h2>
    </div>
    <div style="display:grid;grid-template-columns:2fr 1fr auto;gap:8px;align-items:end;max-width:720px">
      <label>名前
        <input id="stName" placeholder="ここに名前を入力">
      </label>
      <label>役職
        <select id="stRole">
          <option value="boy">ボーイ</option>
          <option value="cast">キャスト</option>
          <option value="staff">スタッフ</option>
        </select>
      </label>
      <button id="stAdd" class="sales-pill" type="button">追加</button>
    </div>
    <div style="font-size:12px;color:#64748b;margin-top:6px">
      * 追加時は「出勤: false / 有効: true」で登録（必要なら一覧で編集できます）
    </div>
  </div>

  <!-- ===== 商品：一覧 ===== -->
  <div id="adminProdList" class="sales-card" style="display:none">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
      <button type="button" class="sales-pill" onclick="location.hash='#admin'">← 戻る</button>
      <h2 style="margin:0">商品リスト</h2>
      <button type="button" class="sales-pill" style="margin-left:auto" onclick="location.hash='#admin-prod-add'">＋ 追加ページへ</button>
    </div>
    <div id="pdList" style="margin-top:8px"></div>
  </div>

  <!-- ===== 商品：追加 ===== -->
  <div id="adminProdAdd" class="sales-card" style="display:none">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
      <button type="button" class="sales-pill" onclick="location.hash='#admin'">← 戻る</button>
      <h2 style="margin:0">商品の追加</h2>
      <button type="button" class="sales-pill" style="margin-left:auto" onclick="location.hash='#admin-prod-list'">一覧へ</button>
    </div>
    <div class="sales-grid">
      <label>商品名<input id="pdName" placeholder="例: 生ビール"></label>
      <label>価格（円）<input id="pdPrice" type="number" min="0" step="1" placeholder="例: 700"></label>
      <label>有効
        <select id="pdActive"><option value="true">true</option><option value="false">false</option></select>
      </label>
    </div>
    <button id="pdAdd" class="sales-pill">＋ 追加</button>
  </div>

</section>


  <!-- 幹部ロジック（Firestore は既存のまま） -->
<script type="module">
  import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import {
    getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  // ==== Firebase init（まず app を作る）====
  const app = getApps().length ? getApps()[0] : initializeApp({
    apiKey:"AIzaSyBru7m0EGNXBgRTzsmQMZknlAAirkTwwpw",
    authDomain:"alexandria-8d142.firebaseapp.com",
    projectId:"alexandria-8d142",
    storageBucket:"alexandria-8d142.firebasestorage.app",
    messagingSenderId:"78904719003",
    appId:"1:78904719003:web:234e7d8b0703bad614f83e",
    measurementId:"G-6TJNLEHJXQ"
  });

  // ==== 認証（app ができてから auth を作る）====
  const auth = getAuth(app);
  try {
    await signInAnonymously(auth);
    console.log('[auth] anonymous signed in');
  } catch (e) {
    console.error('[auth] signInAnonymously failed', e);
  }

  // ==== Firestore ====
  const db = getFirestore(app);

  // ↓↓↓ ここから先はあなたの既存コード（ROOM_ID/パスコード、applyState/showAdminSub、
  //      staff/products の CRUD/onSnapshot、イベントハンドラなど）を
  //      そのまま続けて置いてください。db は上で定義済みです。
  const ROOM_ID = "dev";
  const ADMIN_PASS_PLAIN = "test";
  const LS_PREFIX = window.LS_PREFIX || "tt-dev-";
  const $ = s => document.querySelector(s);
  const esc = s => String(s).replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));
  async function sha256Hex(text){const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(text));return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');}


  const KEY = LS_PREFIX + "admin.unlocked";
  const $locked = $('#adminLocked');
  const $unlocked = $('#adminUnlocked');
  const $wrong = $('#adminWrong');
  const $code = $('#adminCode');

  // ...（この下に、あなたの admin ログイン処理、stCol/pdCol の CRUD などを続ける）





    function applyState(open){
      $locked.style.display=open?'none':'block';
      $unlocked.style.display=open?'flex':'none';
      $wrong.style.display='none';
      // ログイン後はホームへ
      if(open){ showAdminSub(location.hash); }
      else{
        // ログアウト時は全部しまっておく
        ['adminHome','adminStaffList','adminStaffAdd','adminProdList','adminProdAdd'].forEach(id=>{
          const el=document.getElementById(id); if(el) el.style.display='none';
        });
      }
    }

    applyState(sessionStorage.getItem(KEY)==='1');

    document.getElementById('adminEnter').addEventListener('click',async()=>{
      const input=($code.value||'').trim(); if(!input) return;
      const ok=(await sha256Hex(input))===(await sha256Hex(ADMIN_PASS_PLAIN));
      if(ok){ sessionStorage.setItem(KEY,'1'); applyState(true); $code.value=''; if(!location.hash.startsWith('#admin')) location.hash='#admin'; }
      else { $wrong.style.display='block'; }
    });

    document.getElementById('adminLock').addEventListener('click',()=>{
      sessionStorage.removeItem(KEY); applyState(false);
    });

    // Firebase init


    /* ====== staff CRUD（一覧に描画） ====== */
    const stCol=collection(db,'rooms',ROOM_ID,'staff');
    const renderStaffRows = (rows)=>{
      const root = document.getElementById('stList');
      if(!root) return;
      root.innerHTML = rows.map(s=>`
        <div style="display:grid;grid-template-columns:2fr 1fr 1fr auto;gap:8px;align-items:center;border-top:1px dashed #e5e7eb;padding:6px 0">
          <input class="nm" value="${esc(s.name||'')}" placeholder="名前">
          <select class="rl">
            <option value="cast" ${s.role==='cast'?'selected':''}>キャスト</option>
            <option value="boy"  ${s.role==='boy'?'selected':''}>ボーイ</option>
            <option value="staff"${s.role==='staff'?'selected':''}>スタッフ</option>
          </select>

          <div>
            <select class="dt"><option value="false" ${!s.duty?'selected':''}>duty:false</option><option value="true" ${s.duty?'selected':''}>duty:true</option></select>
            <select class="ac"><option value="true" ${s.active!==false?'selected':''}>active:true</option><option value="false" ${s.active===false?'selected':''}>false</option></select>
          </div>
          <div style="text-align:right">
            <button class="sv sales-pill">保存</button>
            <button class="dl sales-pill">削除</button>
          </div>
        </div>`).join('');
      [...root.querySelectorAll(':scope > div')].forEach((row,i)=>{
        const rec=rows[i];
        row.querySelector('.sv').onclick=async()=>{
          const name=row.querySelector('.nm').value.trim();
          const role=row.querySelector('.rl').value;
          const duty=row.querySelector('.dt').value==='true';
          const active=row.querySelector('.ac').value==='true';
          if(!name) return alert('名前は必須');
          const newId=name.replace(/\//g,'／');
          if(newId!==rec.id){
            await setDoc(doc(stCol,newId),{name,role,duty,active,updatedAt:serverTimestamp()},{merge:true});
            await deleteDoc(doc(stCol,rec.id));
          }else{
            await setDoc(doc(stCol,rec.id),{name,role,duty,active,updatedAt:serverTimestamp()},{merge:true});
          }
        };
        row.querySelector('.dl').onclick=async()=>{
          if(confirm('削除しますか？')) await deleteDoc(doc(stCol,rec.id));
        };
      });
    };

// ===== staff: 追加 =====
document.getElementById('stAdd')?.addEventListener('click', async ()=>{
  const nameEl = document.getElementById('stName');
  const roleEl = document.getElementById('stRole');

  const name = (nameEl?.value || '').trim();
  const role = roleEl?.value || 'boy';
  const duty = false;   // 既定
  const active = true;  // 既定

  if(!name){
    alert('名前を入力してください');
    nameEl?.focus();
    return;
  }

  try{
    // Firestore ID に / を入れない
    const id = name.replace(/\//g,'／');
    await setDoc(doc(stCol, id), {
      name, role, duty, active, updatedAt: serverTimestamp()
    }, { merge: true });

    // 入力をリセットして一覧へ
    if(nameEl) nameEl.value = '';
    alert('追加しました');
    location.hash = '#admin-staff-list';   // ← 一覧に遷移
  }catch(e){
    console.error('staff add failed:', e);
    // 失敗理由をユーザーに見せる
    alert('追加に失敗しました: ' + (e?.message || e));
  }
});




    onSnapshot(stCol,(qs)=>{
      const rows=[];
      qs.forEach(d=>rows.push({id:d.id, ...(d.data()||{})}));
      rows.sort((a,b)=>String(a.name||'').localeCompare(String(b.name||''),'ja'));
      renderStaffRows(rows);   // ← 一覧DOMを描画
    });


    /* ====== products CRUD（一覧に描画） ====== */
    const pdCol=collection(db,'rooms',ROOM_ID,'products');
    const renderProdRows = (rows)=>{
      const root = document.getElementById('pdList');
      if(!root) return;
      root.innerHTML = rows.map(p=>`
        <div style="display:grid;grid-template-columns:2fr 1fr 1fr auto;gap:8px;align-items:center;border-top:1px dashed #e5e7eb;padding:6px 0">
          <input class="nm" value="${esc(p.name||'')}" placeholder="商品名">
          <input class="pr" type="number" min="0" step="1" value="${Number(p.price||0)}">
          <select class="ac"><option value="true" ${p.active!==false?'selected':''}>active:true</option><option value="false" ${p.active===false?'selected':''}>false</option></select>
          <div style="text-align:right">
            <button class="sv sales-pill">保存</button>
            <button class="dl sales-pill">削除</button>
          </div>
        </div>`).join('');
      [...root.querySelectorAll(':scope > div')].forEach((row,i)=>{
        const rec=rows[i];
        row.querySelector('.sv').onclick=async()=>{
          const name=row.querySelector('.nm').value.trim();
          const price=Number(row.querySelector('.pr').value||0);
          const active=row.querySelector('.ac').value==='true';
          if(!name) return alert('商品名は必須');
          const newId=name.replace(/\//g,'／');
          if(newId!==rec.id){
            await setDoc(doc(pdCol,newId),{name,price,active,updatedAt:serverTimestamp()},{merge:true});
            await deleteDoc(doc(pdCol,rec.id));
          }else{
            await setDoc(doc(pdCol,rec.id),{name,price,active,updatedAt:serverTimestamp()},{merge:true});
          }
        };
        row.querySelector('.dl').onclick=async()=>{
          if(confirm('削除しますか？')) await deleteDoc(doc(pdCol,rec.id));
        };
      });
    };

    document.getElementById('pdAdd').onclick=async()=>{
      const name=(document.getElementById('pdName').value||'').trim();
      const price=Number(document.getElementById('pdPrice').value||0);
      const active=document.getElementById('pdActive').value==='true';
      if(!name) return alert('商品名を入力');
      const id=name.replace(/\//g,'／');
      await setDoc(doc(pdCol,id),{name,price,active,updatedAt:serverTimestamp()},{merge:true});
      document.getElementById('pdName').value='';
      document.getElementById('pdPrice').value='';
      alert('追加しました');
    };

    onSnapshot(pdCol,(qs)=>{
      const rows=[]; qs.forEach(d=>rows.push({id:d.id,...(d.data()||{})}));
      rows.sort((a,b)=>String(a.name||'').localeCompare(String(b.name||''),'ja'));
      renderProdRows(rows);
    });

    // hash でサブページを切替（ログイン済みのときのみ）
    window.addEventListener('hashchange', ()=>{
      if(sessionStorage.getItem(KEY)==='1' && location.hash.startsWith('#admin')) showAdminSub(location.hash);
    });
    // 初回
    if(sessionStorage.getItem(KEY)==='1' && location.hash.startsWith('#admin')) showAdminSub(location.hash);
  </script>
</section>

  </main>

  <!-- 卓編集モーダル -->
<div class="modalWrap" id="modalWrap" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <h3 id="modalTitle">卓を編集</h3>

    <div class="row">
      <input id="cast" placeholder="キャスト（カンマ区切り）" list="castList" />
      <input id="boy"  placeholder="担当ボーイ"            list="boyList" />
      <datalist id="castList"></datalist>
      <datalist id="boyList"></datalist>
    </div>

    <div class="row chips">
      <span class="label" style="color:#374151;border:1px solid #d1d5db;background:#f9fafb;">時間</span>
      <div class="btns">
        <button class="quick" data-min="15" type="button">15分</button>
        <button class="quick" data-min="30" type="button">30分</button>
        <button class="quick" data-min="45" type="button">45分</button>
        <button class="quick" data-min="60" type="button">60分</button>
      </div>
    </div>

    <div class="row chips">
      <span class="label label-extend">延長</span>
      <div class="btns">
        <button class="extend" data-min="5"  type="button">+5</button>
        <button class="extend" data-min="10" type="button">+10</button>
        <button class="extend" data-min="15" type="button">+15</button>
      </div>
    </div>

    <div class="row" style="gap:12px">
      <div class="suggBlock">
        <div class="suggTitle">出勤キャスト（タップで追加）</div>
        <div id="suggCast" class="suggList"></div>
      </div>
      <div class="suggBlock">
        <div class="suggTitle">出勤ボーイ（タップで設定）</div>
        <div id="suggBoy" class="suggList"></div>
      </div>
    </div>

    <div class="row twoCols">
      <input id="manual" inputmode="numeric" placeholder="分を入力 → 開始" />
      <button id="start" type="button">開始</button>
    </div>

    <div class="row btns" style="justify-content:space-between">
      <button id="saveMeta" class="secondary" type="button">キャスト/ボーイを保存</button>
      <div>
        <button id="clear" class="danger"    type="button">クリア（空席）</button>
        <button id="close" class="secondary" type="button">閉じる</button>
      </div>
    </div>
  </div>
</div>

<!-- ボーイ/キャスト ピッカーモーダル -->
<div class="pickerWrap" id="pickerWrap" aria-hidden="true">
  <div class="pickerPanel" role="dialog" aria-modal="true">
    <div class="pickerHead">
      <h3 id="pickerTitle" style="margin:0;font-size:16px">選択</h3>
      <div class="pickerBtns">
        <button id="pickerClear" class="secondary" type="button">全クリア</button>
        <button id="pickerOk"    type="button">決定</button>
        <button id="pickerClose" class="secondary" type="button">キャンセル</button>
      </div>
    </div>
    <div id="pickerList" class="suggList"></div>
  </div>
</div>


  <!-- ========= タイマー/控室/名簿 & ピッカー ========= -->
  <script>
  /* === 設定 === */
  const STAFF_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRdLnWcNEqCfi4VVuG6k4id4JjbBkg4r9eVnRS1mEqN1XY3jz11bQkCXs9MBOkE0y4SPeMgUhHaH8_e/pub?gid=1348648909&single=true&output=csv';
  const LS_PREFIX = 'tt-dev-';
  window.LS_PREFIX = LS_PREFIX;

  /* === 席データ === */
const seats = (()=>{ 
  const saved=localStorage.getItem(LS_PREFIX+'seats.v2');
  if(saved){
    const arr=JSON.parse(saved);
    arr.forEach(s=>{
      if(s.finished===undefined) s.finished=false;
      if(s.extendCount===undefined) s.extendCount=0;   // ← 追加
    });
    return arr;
  }
  const a=[];
  for(let i=1;i<=8;i++) a.push({id:`R${i}`,group:'red',label:`VIP ${i}`,cast:'',boy:'',end:null,finished:false,extendCount:0});
  for(let i=1;i<=7;i++) a.push({id:`B${i}`,group:'blue',label:`ノーマル ${i}`,cast:'',boy:'',end:null,finished:false,extendCount:0});
  for(let i=1;i<=3;i++) a.push({id:`V${i}`,group:'vip',label:`超VIP ${i}`,cast:'',boy:'',end:null,finished:false,extendCount:0});
  return a;
})();

  const save = () => localStorage.setItem(LS_PREFIX+'seats.v2', JSON.stringify(seats));

  /* === 座標 === */
  const POS={R8:{top:15,left:25,width:13},R7:{top:15,left:39,width:13},R6:{top:15,left:53,width:13},R5:{top:15,left:67,width:13},
    R1:{top:30,left:67,width:13},R2:{top:45,left:67,width:13},R3:{top:30,left:18,width:13},R4:{top:45,left:18,width:13},
    B1:{top:22,left:87,width:10},B2:{top:36,left:87,width:10},B3:{top:50,left:87,width:10},B4:{top:7,left:2,width:10},B5:{top:7,left:12,width:10},B6:{top:65,left:7,width:11},B7:{top:65,left:84,width:11}};

  /* === 要素 === */
  const $=s=>document.querySelector(s);
  const floor=$('#floor'), vipWrap=$('#vip'), nowEl=$('#now');
  const wrap=$('#modalWrap'), title=$('#modalTitle');
  const castI=$('#cast'), boyI=$('#boy'), manI=$('#manual');
  const suggCast=$('#suggCast'), suggBoy=$('#suggBoy');
  let currentId=null, lastFocus=null;
  const pageRoots=document.querySelectorAll('header, main');

  /* === UI生成 === */
  function cardHTML(s){
  const nameByGroup={red:'VIP',blue:'ノーマル',vip:'超VIP'};
  const num=(s.id.match(/\d+/)||[''])[0];
  const label=`${nameByGroup[s.group]||s.label} ${num}`;
  const endAt=s.end?`～ ${formatClock(s.end)}`:'';
  const ext = (s.extendCount||0)>0 ? `<span class="extBadge">延×${s.extendCount}</span>` : '';
  return `
    <div class="line1">
      <span>${label}</span>
      <span class="endAt">${endAt}</span>
    </div>
    <div class="timer"><span class="remain">${
      s.end ? formatRemain(s.end-Date.now()) : (s.finished ? '終了' : '空')
    }</span>${ext}</div>
    <div class="meta">${(s.cast||'')}${s.boy?' ｜ '+s.boy:''}</div>`;
}
    function addVipSeat(s){
  const d=document.createElement('div');
  d.className='vipSeat';
  d.dataset.id=s.id;
  d.innerHTML=cardHTML(s);
  d.addEventListener('click',()=>openModal(s.id));
  vipWrap.appendChild(d);
}
function addSeatToFloor(s){
  const pos=POS[s.id]; if(!pos) return;
  const d=document.createElement('div');
  d.className=`seat ${s.group}`;
  d.dataset.id=s.id;
  d.style.top=pos.top+'%';
  d.style.left=pos.left+'%';
  d.style.width=pos.width+'%';
  d.innerHTML=cardHTML(s);
  d.addEventListener('click',()=>openModal(s.id));
  floor.appendChild(d);
}
function resizeFloor(){
  const pad=12;
  const needed=vipWrap.offsetTop+vipWrap.offsetHeight+pad;
  floor.style.height=needed+'px';
}


function render(){
  floor.querySelectorAll('.seat').forEach(n=>n.remove());
  vipWrap.innerHTML='';
  const q=$('#q').value.trim();

  seats.forEach(s=>{ if(s.group==='vip') addVipSeat(s); else addSeatToFloor(s); });

  floor.querySelectorAll('[data-id]').forEach(el=>{
    const s=seats.find(x=>x.id===el.dataset.id); const t=el.querySelector('.remain');
    el.classList.remove('active','warn','danger','highlight');
    if(s.end){
      const r=s.end-Date.now();
      if(r>0){ t.textContent=formatRemain(r); el.classList.add('active'); if(r<=3*60*1000)el.classList.add('danger'); else if(r<=10*60*1000)el.classList.add('warn'); }
      else { s.end=null; s.finished=true; save(); t.textContent='終了'; }
    }else{ t.textContent=s.finished?'終了':'空'; }
    if(q && s.cast && s.cast.includes(q)) el.classList.add('highlight');
  });
  resizeFloor(); renderRoster();
}

function tick(){
  nowEl.textContent=new Date().toLocaleString('ja-JP',{hour12:false});
  floor.querySelectorAll('[data-id]').forEach(el=>{
    const s=seats.find(x=>x.id===el.dataset.id); const t=el.querySelector('.remain');
    el.classList.remove('active','warn','danger');
    const endAtEl=el.querySelector('.endAt'); if(endAtEl) endAtEl.textContent=s.end?`～ ${formatClock(s.end)}`:'';
    if(!s.end){ t.textContent=s.finished?'終了':'空'; return; }
    const r=s.end-Date.now(); if(r<=0){ s.end=null; s.finished=true; save(); t.textContent='終了'; return; }
    t.textContent=formatRemain(r); el.classList.add('active');
    if(r<=3*60*1000) el.classList.add('danger'); else if(r<=10*60*1000) el.classList.add('warn');
  });
  if(staff.length) renderRoster();
}

  function formatRemain(ms){const s=Math.floor(ms/1000),h=Math.floor(s/3600),m=Math.floor((s%3600)/60),ss=s%60;return (h?String(h).padStart(2,'0')+':':'')+String(m).padStart(2,'0')+':'+String(ss).padStart(2,'0');}
  function formatClock(ts){let ms=null;if(ts==null)return'';if(typeof ts==='number')ms=ts;else if(typeof ts==='string'&&/^\d+$/.test(ts))ms=Number(ts);else if(typeof ts==='object'&&typeof ts.toMillis==='function')ms=ts.toMillis();else if(typeof ts==='object'&&typeof ts.seconds==='number')ms=ts.seconds*1000+Math.floor((ts.nanoseconds||0)/1e6);const d=new Date(ms);if(Number.isNaN(d.getTime()))return'';return d.toLocaleTimeString('ja-JP',{hour12:false,hour:'2-digit',minute:'2-digit'});}

  /* === モーダル === */
  function openModal(id){
    lastFocus=document.activeElement; const s=seats.find(x=>x.id===id); currentId=id;
    const nameByGroup={red:'VIP',blue:'ノーマル',vip:'超VIP'}; const num=(s.id.match(/\d+/)||[''])[0];
    title.textContent=`席を編集：${nameByGroup[s.group]||s.label} ${num}`;
    castI.value=s.cast||''; boyI.value=s.boy||''; manI.value='';
    pageRoots.forEach(el=>el.setAttribute('inert',''));
    wrap.removeAttribute('aria-hidden'); wrap.hidden=false; wrap.style.display='grid';
    fillSuggestionBlocks(); requestAnimationFrame(()=>castI.focus());
  }
  function closeModal(){
    const fallback=document.getElementById('q')||document.body;
    if(wrap.contains(document.activeElement)){ (lastFocus && document.contains(lastFocus)?lastFocus:fallback).focus(); }
    pageRoots.forEach(el=>el.removeAttribute('inert'));
    wrap.setAttribute('aria-hidden','true'); wrap.hidden=true; wrap.style.display='none';
  }
  document.addEventListener('click',e=>{ if(e.target?.id==='close' || e.target===wrap) closeModal(); });

  document.getElementById('saveMeta').addEventListener('click', ()=>{
    const s=seats.find(x=>x.id===currentId); s.cast=castI.value.trim(); s.boy=boyI.value.trim(); save(); render(); closeModal();
  });
  document.getElementById('clear').addEventListener('click', ()=>{
    const s=seats.find(x=>x.id===currentId); s.end=null; s.cast=''; s.boy=''; s.finished=false; save(); render(); castI.value=''; boyI.value=''; manI.value=''; closeModal();
  });
// 開始（手入力）
document.getElementById('start').addEventListener('click', ()=>{
  const v=Number(manI.value); if(!v||v<=0) return alert('分数を入力してください');
  const s=seats.find(x=>x.id===currentId);
  s.cast=castI.value.trim(); s.boy=boyI.value.trim();
  s.end=Date.now()+v*60*1000; s.finished=false; s.extendCount=0;   // reset
  save(); render(); closeModal();
});

// クイック開始
document.querySelectorAll('button.quick').forEach(b=>b.addEventListener('click', ()=>{
  const mins=Number(b.dataset.min); const s=seats.find(x=>x.id===currentId);
  s.cast=castI.value.trim(); s.boy=boyI.value.trim();
  s.end=Date.now()+mins*60*1000; s.finished=false; s.extendCount=0; // reset
  save(); render(); closeModal();
}));

// 延長
document.querySelectorAll('button.extend').forEach(b=>b.addEventListener('click', ()=>{
  const mins=Number(b.dataset.min); const s=seats.find(x=>x.id===currentId);
  const base=s.end && s.end>Date.now()? s.end:Date.now();
  s.end=base+mins*60*1000; s.finished=false;
  s.extendCount=(s.extendCount||0)+1;                                 // count up
  if(!s.cast) s.cast=castI.value.trim(); if(!s.boy) s.boy=boyI.value.trim();
  save(); render(); closeModal();
}));

// クリア
document.getElementById('clear').addEventListener('click', ()=>{
  const s=seats.find(x=>x.id===currentId);
  s.end=null; s.cast=''; s.boy=''; s.finished=false; s.extendCount=0; // reset
  save(); render(); castI.value=''; boyI.value=''; manI.value=''; closeModal();
});
document.getElementById('q').addEventListener('input', render);


  /* === CSV/名簿 === */
  function parseCSV(str){const rows=[];let cur=[],val='',inQ=false;for(let i=0;i<str.length;i++){const c=str[i];if(inQ){if(c=='"'){if(str[i+1]=='"'){val+='"';i++;}else inQ=false;}else val+=c;}else{if(c=='"'){inQ=true;}else if(c==','){cur.push(val);val='';}else if(c=='\n'){cur.push(val);rows.push(cur);cur=[];val='';}else if(c=='\r'){}else val+=c;}} if(val.length>0||cur.length>0){cur.push(val);rows.push(cur);} return rows;}
  function parseStaffNamesFromCSV(csv){
    const rowsRaw=parseCSV(csv); const rows=rowsRaw.filter(r=>r&&r.some(c=>(c||'').trim()!==''));
    if(!rows.length) return [];
    let headerRowIdx=-1,nameIdx=-1; const MAX_SCAN=Math.min(rows.length,10);
    for(let i=0;i<MAX_SCAN;i++){const idx=rows[i].findIndex(c=>String(c||'').trim()==='従業員'); if(idx>=0){headerRowIdx=i;nameIdx=idx;break;}}
    if(headerRowIdx<0) headerRowIdx=0; if(nameIdx<0) nameIdx=12;
    const names=rows.slice(headerRowIdx+1).map(r=>(r[nameIdx]||'').trim()).filter(v=>v&&v!=='従業員'); return [...new Set(names)];
  }
  let staff=[]; let dutyMap=JSON.parse(localStorage.getItem(LS_PREFIX+'staff.duty.map')||'{}'); window.staff=staff; window.dutyMap=dutyMap;

  async function loadStaff(){
    if(!STAFF_CSV_URL) return;
    try{
      const res=await fetch(STAFF_CSV_URL,{cache:'no-store'});
      const csv=await res.text(); const names=parseStaffNamesFromCSV(csv);
      const newStaff=names.map(n=>({name:n,duty:!!(window.dutyMap?.[n])}));
      staff.splice(0,staff.length,...newStaff); window.staff=staff;
      localStorage.setItem(LS_PREFIX+'staff.cache.names',JSON.stringify(names));
      fillDatalists(); renderRoster(); renderSalesFields();
      console.log(`[Roster] CSV読込: ${names.length}件`);
    }catch(e){
      console.error('スタッフ読み込み失敗',e);
      const cache=JSON.parse(localStorage.getItem(LS_PREFIX+'staff.cache.names')||'[]');
      staff=cache.map(n=>({name:n,duty:!!dutyMap[n]}));
      fillDatalists(); renderRoster(); renderSalesFields();
    }
  }
  function toggleDuty(name){
    dutyMap[name]=!dutyMap[name];
    localStorage.setItem(LS_PREFIX+'staff.duty.map',JSON.stringify(dutyMap));
    staff.forEach(s=>{ if(s.name===name) s.duty=!!dutyMap[name]; });
    fillDatalists(); renderRoster();
  }
  function isNameBusy(name){
    name=name.trim();
    return seats.some(s=>{
      const castNames=(s.cast||'').split(',').map(x=>x.trim()).filter(Boolean);
      if(castNames.includes(name) || (s.boy||'').trim()===name){ return !!(s.end || s.finished); }
      return false;
    });
  }
  function addCastName(name){
    const list=castI.value.split(',').map(v=>v.trim()).filter(Boolean);
    if(!list.includes(name)){ list.push(name); castI.value=list.join(', '); }
  }
// 既存 loadStaff() の後
document.getElementById('reloadStaff')?.addEventListener('click', ()=> loadStaff());

// renderRoster を本鯖式で（クリック時の挙動を切替）
function renderRoster(){
  const rosterBox=document.getElementById('roster'); if(!rosterBox) return;
  rosterBox.innerHTML='';
  if(!staff.length){
    const small=document.createElement('div'); small.style.color='#64748b'; small.style.fontSize='12px';
    small.textContent='（CSVのURLが未設定か、スプレッドシートを「ウェブに公開（CSV）」にしていない可能性があります）';
    rosterBox.appendChild(small); return;
  }
  const editSwitch=document.getElementById('editDuty');
  const addChip=(name,duty,busy)=>{
    const d=document.createElement('button'); d.type='button';
    d.className=`staffChip ${duty?(busy?'busy':'on'):'off'}`; d.textContent=name;
    if(editSwitch && editSwitch.checked){
      d.disabled=false; d.addEventListener('click',()=>toggleDuty(name));
    }else{
      if(!duty) d.disabled=true;
      else d.addEventListener('click',()=>{
        if(wrap.getAttribute('aria-hidden')==='false'){
          if(document.activeElement===boyI){ boyI.value=name; boyI.focus(); }
          else{ const list=castI.value.split(',').map(v=>v.trim()).filter(Boolean); if(!list.includes(name)) castI.value=[...list,name].join(', '); castI.focus(); }
        }
      });
    }
    rosterBox.appendChild(d);
  };
  staff.filter(s=>s.duty).forEach(s=>addChip(s.name,true,isNameBusy(s.name)));
  const off=staff.filter(s=>!s.duty);
  if(off.length){
    const title=document.createElement('div'); title.className='staffSectionTitle'; title.textContent='— 非出勤 —'; rosterBox.appendChild(title);
    off.forEach(s=>addChip(s.name,false,false));
  }
}

  function fillDatalists(){
    const castDL=document.getElementById('castList');
    const boyDL=document.getElementById('boyList');
    const onList=staff.filter(s=>s.duty).map(s=>s.name);
    castDL.innerHTML=onList.map(n=>`<option value="${n}">`).join('');
    boyDL.innerHTML =onList.map(n=>`<option value="${n}">`).join('');
  }
  function fillSuggestionBlocks(){
    const onList=staff.filter(s=>s.duty).map(s=>s.name);
    suggCast.innerHTML=onList.map(n=>`<button type="button" class="staffChip on" data-name="${n}">${n}</button>`).join('');
    suggCast.querySelectorAll('button').forEach(b=>b.addEventListener('click',()=>{
      const name=b.dataset.name; const list=castI.value.split(',').map(v=>v.trim()).filter(Boolean);
      if(!list.includes(name)) list.push(name); castI.value=list.join(', '); castI.focus();
    }));
    suggBoy.innerHTML=onList.map(n=>`<button type="button" class="staffChip on" data-name="${n}">${n}</button>`).join('');
    suggBoy.querySelectorAll('button').forEach(b=>b.addEventListener('click',()=>{ boyI.value=b.dataset.name; boyI.focus(); }));
  }

  /* === ピッカー（売上側） === */
  const boyField  = document.getElementById('boyField');
  const castField = document.getElementById('castField');
  const pickerWrap   = document.getElementById('pickerWrap');
  const pickerTitle  = document.getElementById('pickerTitle');
  const pickerList   = document.getElementById('pickerList');
  const pickerOk     = document.getElementById('pickerOk');
  const pickerClear  = document.getElementById('pickerClear');
  const pickerClose  = document.getElementById('pickerClose');

let salesBoy = '';
let salesCast = [];
window.salesBoy = salesBoy;
window.salesCast = salesCast;
 let pickerMode = null; let tmpBoy = ''; let tmpCast = [];


  function renderSalesFields(){
  if (typeof window.salesBoy !== 'undefined') salesBoy = window.salesBoy;
  if (Array.isArray(window.salesCast)) salesCast = [...window.salesCast];
  // 以下はそのまま…

    boyField.classList.toggle('empty', !salesBoy);
    boyField.innerHTML = salesBoy ? `<span class="pill">${salesBoy}</span>` : 'タップして選択';
    castField.classList.toggle('empty', salesCast.length===0);
    castField.innerHTML = salesCast.length ? salesCast.map(n=>`<span class="pill">${n}</span>`).join('') : 'タップして選択';
  }
  window.renderSalesFields = renderSalesFields;

  boyField.addEventListener('click', ()=>openPicker('boy'));
  castField.addEventListener('click', ()=>openPicker('cast'));

  function openPicker(mode){
    pickerMode = mode;
    pickerTitle.textContent = (mode==='boy') ? 'ボーイを選択（1名）' : 'キャストを選択（複数可）';
    tmpBoy  = salesBoy;
    tmpCast = [...salesCast];
    buildPickerList();
    pickerWrap.style.display='grid';
    pickerWrap.removeAttribute('aria-hidden');
  }
  function closePicker(){ pickerWrap.style.display='none'; pickerWrap.setAttribute('aria-hidden','true'); }
  pickerWrap.addEventListener('click', e=>{ if(e.target===pickerWrap) closePicker(); });
  pickerClose.addEventListener('click', closePicker);
  pickerClear.addEventListener('click', ()=>{ if(pickerMode==='boy') tmpBoy=''; else tmpCast=[]; buildPickerList(); });
  pickerOk.addEventListener('click', ()=>{
  if (pickerMode==='boy') salesBoy = tmpBoy;
  else salesCast = [...tmpCast];
  window.salesBoy = salesBoy;
  window.salesCast = salesCast;
  renderSalesFields();
  closePicker();
});


  function buildPickerList(){
    const onList=(window.staff||[]).filter(s=>s.duty).map(s=>({name:s.name, busy:isNameBusy(s.name)}));
    pickerList.innerHTML = onList.map(x=>{
      const selected = (pickerMode==='boy') ? (tmpBoy===x.name) : tmpCast.includes(x.name);
      return `<button type="button" class="staffChip ${x.busy?'busy':'on'} ${selected?'selected':''}" data-name="${x.name}">${x.name}</button>`;
    }).join('');
    pickerList.querySelectorAll('button').forEach(b=>{
      b.addEventListener('click', ()=>{
        const name=b.dataset.name;
        if(pickerMode==='boy'){ tmpBoy = (tmpBoy===name) ? '' : name; }
        else { if(tmpCast.includes(name)) tmpCast = tmpCast.filter(n=>n!==name); else tmpCast = [...tmpCast, name]; }
        buildPickerList();
      });
    });
  }

  /* === 初期化 === */
  render(); setInterval(tick,1000); window.addEventListener('resize', resizeFloor);
  loadStaff(); setInterval(loadStaff, 60000);
  </script>

  <!-- ========= 売上（商品CSV/送信） ========= -->
  <script>
  const PRODUCTS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRdLnWcNEqCfi4VVuG6k4id4JjbBkg4r9eVnRS1mEqN1XY3jz11bQkCXs9MBOkE0y4SPeMgUhHaH8_e/pub?gid=1348648909&single=true&output=csv';
  const SALES_GAS_URL    = 'https://script.google.com/macros/s/AKfycbwP_n70AlN5TrYvpVRR_tdaOJ8umm61B7bW_s-RQZ1cCeGBkIai3RlgLrbWK7ztPn5Z/exec';

  const linesBox=document.getElementById('salesLines');
  const totalEl=document.getElementById('salesTotal');
  let PRODUCTS=[], LINE_SEQ=0;

  const yen = n => new Intl.NumberFormat('ja-JP',{style:'currency',currency:'JPY'}).format(Number(n||0));

  function parseCSV(str){const rows=[];let cur=[],val='',inQ=false;for(let i=0;i<str.length;i++){const c=str[i];if(inQ){if(c=='"'){if(str[i+1]=='"'){val+='"';i++;}else inQ=false;}else val+=c;}else{if(c=='"'){inQ=true;}else if(c==','){cur.push(val);val='';}else if(c=='\n'){cur.push(val);rows.push(cur);cur=[];val='';}else if(c=='\r'){}else val+=c;}} if(val.length>0||cur.length>0){cur.push(val);rows.push(cur);} return rows;}
  function parseProductsFromCSV(csv){
    const rows = parseCSV(csv).filter(r => r && r.some(c => (c||'').trim() !== ''));
    if (!rows.length) return [];
    let nameIdx = -1, priceIdx = -1, headerRow = -1;
    for (let i = 0; i < Math.min(10, rows.length); i++){
      const rr = rows[i];
      const n  = rr.findIndex(c => /商品/.test(String(c||'')));
      const p  = rr.findIndex(c => /(値段|価格|金額)/.test(String(c||'')));
      if (n >= 0 && p >= 0){ nameIdx = n; priceIdx = p; headerRow = i; break; }
    }
    if (nameIdx < 0) nameIdx = 1;
    if (priceIdx < 0) priceIdx = 2;
    const dataRows = rows.slice(headerRow >= 0 ? headerRow + 1 : 0);
    return dataRows.map(r => ({ name: (r[nameIdx]||'').trim(), price: Number(String(r[priceIdx]||'').replace(/[^\d.-]/g,'')) || 0 })).filter(p => p.name);
  }

  async function loadProducts(){
    if(!PRODUCTS_CSV_URL) return;
    const res=await fetch(PRODUCTS_CSV_URL,{cache:'no-store'});
    const csv=await res.text(); PRODUCTS=parseProductsFromCSV(csv); rebuildAllLines();
  }

  function buildLine(init){
    const id=++LINE_SEQ; const row=document.createElement('div'); row.className='sales-row'; row.dataset.lineId=id;
    const sel=document.createElement('select');
    sel.innerHTML=`<option value="">（商品を選択）</option>`+PRODUCTS.map(p=>`<option data-price="${p.price}" value="${p.name}">${p.name}</option>`).join('');
    if(init?.product) sel.value=init.product;

    const unitEl=document.createElement('div'); unitEl.className='sales-yen'; unitEl.textContent=yen(init?.unitPrice||0);
    const qty=document.createElement('input'); qty.type='number'; qty.min='0'; qty.step='1'; qty.value=init?.qty ?? 0;
    const subEl=document.createElement('div'); subEl.className='sales-yen'; subEl.textContent=yen((init?.unitPrice||0)*(init?.qty||0));
    const del=document.createElement('button'); del.type='button'; del.className='sales-pill'; del.textContent='－ 削除'; del.addEventListener('click',()=>{ row.remove(); recalcTotal(); });

    sel.addEventListener('change',()=>{ const price=Number(sel.selectedOptions[0]?.dataset.price||0); unitEl.textContent=yen(price); subEl.textContent=yen(price*Number(qty.value||0)); recalcTotal(); });
    qty.addEventListener('input',()=>{ const price=Number(sel.selectedOptions[0]?.dataset.price||0); subEl.textContent=yen(price*Number(qty.value||0)); recalcTotal(); });

    row.appendChild(sel); row.appendChild(unitEl); row.appendChild(qty); row.appendChild(subEl); row.appendChild(del);
    linesBox.appendChild(row);
  }
  function rebuildAllLines(){ const keep=[...linesBox.querySelectorAll('.sales-row')].length || 1; linesBox.innerHTML=''; for(let i=0;i<keep;i++) buildLine(); recalcTotal(); }
  function recalcTotal(){ let sum=0; linesBox.querySelectorAll('.sales-row').forEach(row=>{ const sel=row.querySelector('select'); const unit=Number(sel.selectedOptions[0]?.dataset.price||0); const qty=Number(row.querySelector('input').value||0); sum += unit*qty; }); totalEl.textContent=yen(sum); }

  function collectPayload(){
    const rows=[...linesBox.querySelectorAll('.sales-row')].map(row=>{ const sel=row.querySelector('select'); const unit=Number(sel.selectedOptions[0]?.dataset.price||0); const qty=Number(row.querySelector('input').value||0); const product=sel.value||''; return {product,unitPrice:unit,qty,amount:unit*qty}; }).filter(r=>r.product && r.qty>0);
    const cast=[...window.salesCast||[]]; const boy=window.salesBoy||''; const total=rows.reduce((a,b)=>a+b.amount,0);
    return { rows, cast, boy, total, timestamp: Date.now() };
  }

  document.getElementById('addSalesLine').addEventListener('click',()=>buildLine());
  document.getElementById('reloadSales').addEventListener('click',()=>{ loadProducts(); window.renderSalesFields?.(); });
  document.getElementById('submitSales').addEventListener('click', async ()=>{
    const payload = collectPayload();
    if(!payload.rows.length) return alert('明細がありません');
    if(!SALES_GAS_URL) return alert('送信先URLが未設定です');

    try{
      const res = await fetch(SALES_GAS_URL, { method:'POST', headers:{ 'Content-Type':'text/plain;charset=utf-8' }, body: JSON.stringify(payload) });
      const text = await res.text();
      let json = {}; try { json = JSON.parse(text); } catch(_) {}
      if(!res.ok || json.ok === false) throw new Error(json.error || `HTTP ${res.status}`);

      alert('登録しました');
      window.salesBoy = ''; window.salesCast = []; window.renderSalesFields?.();
      linesBox.innerHTML=''; buildLine(); recalcTotal();
    }catch(e){ alert('送信エラー: ' + e.message); console.error(e); }
  });

  loadProducts(); window.renderSalesFields?.(); buildLine();
  </script>

  <!-- ========= ルーター（最後に1本だけ） ========= -->
<script>
  function route(){
    const hash = location.hash || '#timer';
    // トップレベルの表示判定
    const isAdmin = hash.startsWith('#admin');
    const isTimer = !isAdmin && hash === '#timer';
    const isSales = !isAdmin && hash === '#sales';
    const show=(id,on)=>{const el=document.getElementById(id); if(el) el.style.display=on?'block':'none';};
    const active=(id,on)=>{const el=document.getElementById(id); if(el) el.classList.toggle('active',!!on);};

    show('pageTimer',isTimer);
    show('pageSales',isSales);
    show('pageAdmin',isAdmin);

    active('navTimer',isTimer);
    active('navSales',isSales);
    active('navAdmin',isAdmin);

    window.scrollTo(0,0);
  }
  window.addEventListener('hashchange',route);
  route();
</script>

</body>
</html>
