<div style="position:fixed;right:50px;top:8px;padding:6px 10px;border:1px dashed #888;font-weight:bold;z-index:9999;">
  開発用（DEV）あ
</div>


<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>卓タイマー管理 + 控室（スプシ連携）</title>
  <link rel="icon" href="data:," />
  <style>
    :root{
      --bg:#f4f6f8; --panel:#fff; --text:#111;
      --red:#e74c3c; --blue:#2e86de; --vip:#9b59b6;
      --ok:#e7ffe7; --warn:#fff3cd; --danger:#ffe0e0; --gold:#ffdd57;
      --staff-on-bg:#e6f4ea; --staff-on-border:#34a853; --staff-on-text:#0b6630;
      --staff-busy-bg:#fff3cd; --staff-busy-border:#f59e0b; --staff-busy-text:#7a4e00;
      --staff-off-bg:#f1f5f9; --staff-off-border:#cbd5e1; --staff-off-text:#94a3b8;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Arial,sans-serif}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px 14px;background:#1f1f23;color:#fff;position:sticky;top:0;z-index:5}
    header h1{margin:0;font-size:18px}
    .toolbar{display:flex;gap:8px;align-items:center}
    .toolbar input{padding:8px;border-radius:8px;border:1px solid #ccc;min-width:220px}
    .now{opacity:.85}

    /* タブ */
    .top-tabs{display:inline-flex;gap:.5rem;margin-left:1rem}
    .top-tabs .tab{
      padding:.35rem .8rem;border:1px solid #ddd;border-radius:999px;background:#fff;
      color:#111 !important;text-decoration:none;display:inline-block
    }
    .top-tabs .tab.active{box-shadow:0 1px 4px #0001;font-weight:700}

    main{padding:12px;display:block}
    .page{display:none}

    /* Floor */
    .floor{
      position:relative;background:var(--panel);border:1px solid #ddd;border-radius:12px;
      overflow:hidden;padding:4px;min-height:750px;
    }
    .legend{position:absolute;left:8px;top:8px;display:flex;gap:10px;flex-wrap:wrap;font-size:12px;opacity:.9;background:#fff9;border-radius:8px;padding:6px}
    .dot{width:10px;height:10px;border-radius:50%;display:inline-block;border:1px solid #999}
    .dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.danger{background:var(--danger)} .dot.empty{background:#eee}
    .seat{
      position:absolute;background:#fff;border:2px solid #bbb;border-radius:10px;
      padding:6px;min-height:64px;min-width:80px;cursor:pointer;
      display:flex;flex-direction:column;gap:4px;transition:transform .05s ease, box-shadow .1s, background .2s;
      box-shadow:0 1px 0 #0001;
    }
    .seat:hover{transform:translateY(-1px)}
    .seat.red{border-color:var(--red)}
    .seat.blue{border-color:var(--blue)}
    .seat.active{background:var(--ok)} .seat.warn{background:var(--warn)} .seat.danger{background:var(--danger)}
    .seat.highlight{box-shadow:0 0 0 3px var(--gold) inset}
    .line1{display:flex;justify-content:space-between;align-items:center;font-weight:700}
    .line1 .endAt{font-weight:700;font-size:18px;opacity:.8;margin-left:10px;white-space:nowrap}
    .timer{font-size:18px;font-weight:800}
    .meta{font-size:18px;line-height:1.25;opacity:.95;overflow-wrap:anywhere}

    /* VIP row */
    .vipRow{position:absolute; left:15%; right:15%; bottom:7%; display:flex; gap:12px; z-index:2;}
    .vipSeat{
      background:#fff;border:2px dashed var(--vip);border-radius:12px;
      padding:10px;min-height:100px;flex:1;cursor:pointer;display:flex;flex-direction:column;gap:6px;
    }
    .vipSeat.active{background:var(--ok)} .vipSeat.warn{background:var(--warn)} .vipSeat.danger{background:var(--danger)}
    .vipSeat .timer{font-size:22px}

    /* Backstage */
    .backstage{background:var(--panel);border:1px solid #ddd;border-radius:12px;padding:10px;margin-top:12px}
    .backstage h2{margin:0 0 8px;font-size:16px}
    .legend-staff{font-size:12px;opacity:.8;display:flex;gap:12px;align-items:center}
    .dotS{width:10px;height:10px;border-radius:50%;display:inline-block}
    .dotS.on{background:#145768} .dotS.busy{background:#6b480a} .dotS.off{background:#9ca3af}
    .roster{display:flex;flex-wrap:wrap;gap:8px}
    .staffChip{padding:6px 10px;border-radius:999px;border:1px solid #cbd5e1;background:#f8fafc;cursor:pointer;font-size:14px}
    .staffChip.on{background:var(--staff-on-bg);border:1px solid var(--staff-on-border);color:var(--staff-on-text);box-shadow:0 0 0 1px #0e3d49 inset}
    .staffChip.busy{background:var(--staff-busy-bg);border:1px solid var(--staff-busy-border);color:var(--staff-busy-text);box-shadow:0 0 0 1px #3a2706 inset}
    .staffChip.off{background:var(--staff-off-bg);border:1px solid var(--staff-off-border);color:var(--staff-off-text)}
    .staffChip.selected{box-shadow:0 0 0 2px #111 inset;font-weight:700}
    .staffSectionTitle{flex-basis:100%;margin-top:6px;font-size:12px;color:#475569}

    /* モーダル（卓編集） */
    .modalWrap{position:fixed;inset:0;background:#0008;display:none;place-items:center;z-index:9}
    .modal{background:#fff;border-radius:14px;padding:16px;min-width:300px;max-width:92vw;box-shadow:0 20px 60px #0006}
    .modal h3{margin:0 0 10px 0}
    .row{display:flex;gap:8px;margin:8px 0}
    .row input{flex:1;padding:10px;border-radius:8px;border:1px solid #ccc}
    .btns{display:flex;flex-wrap:wrap;gap:8px}
    button{border:none;border-radius:10px;padding:10px 14px;cursor:pointer;background:#111;color:#fff}
    button.secondary{background:#e5e7eb;color:#111}
    button.danger{background:#dc2626}
    .chips button{background:#fff;border:1px solid #111;color:#111}
    .label{font-weight:700;padding:6px 10px;border-radius:999px;font-size:12px;line-height:1;align-self:center;white-space:nowrap}
    .label-extend{color:var(--vip);border:1px solid var(--vip);background:#f7ecff}
    .twoCols{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
    .suggBlock{display:flex;flex-direction:column;gap:4px;flex:1}
    .suggTitle{font-size:12px;color:#6b7280}
    .suggList{display:flex;flex-wrap:wrap;gap:6px}
    .suggList .staffChip{padding:4px 8px;font-size:12px}

    /* 売上入力 */
    #salesSection{margin-top:12px}
    .sales-card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px}
    .sales-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:8px}

    /* ← NEW: 選択“マス”と選択モーダル */
    .pickerField{
      border:1px solid #dcdfe3;background:#f9fafb;border-radius:12px;
      padding:8px; min-height:46px; display:flex; gap:6px; align-items:center; flex-wrap:wrap;
      cursor:pointer;
    }
    .pickerField.empty{color:#94a3b8}
    .pill{padding:4px 10px;border-radius:999px;border:1px solid #cbd5e1;background:#fff;font-size:12px}
    .pickerWrap{position:fixed;inset:0;background:#0008;display:none;place-items:center;z-index:10}
    .pickerPanel{background:#fff;border-radius:14px;padding:14px;max-width:92vw;max-height:80vh;overflow:auto;box-shadow:0 20px 60px #0006}
    .pickerHead{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px}
    .pickerBtns{display:flex;gap:8px;flex-wrap:wrap}
    .sales-row{display:grid;grid-template-columns:1.2fr .6fr .6fr .8fr auto;gap:8px;align-items:center;margin:6px 0}
    .sales-row select,.sales-row input{padding:.45rem;border:1px solid #dcdfe3;border-radius:.6rem}
    .sales-yen{min-width:6em;text-align:right;padding:.45rem .6rem;background:#f8fafc;border:1px solid #e5e7eb;border-radius:.6rem}
    .sales-actions{display:flex;gap:8px;margin-top:10px}
    .sales-pill{padding:.35rem .6rem;border:1px dashed #cbd5e1;border-radius:999px;background:#f9fafb;cursor:pointer}
    .sales-total{font-size:1.1rem;font-weight:700;text-align:right;margin-top:.5rem}

    @media(max-width:900px){
      .toolbar input{min-width:160px}
      .seat{min-width:72px;min-height:60px}
      .sales-grid{grid-template-columns:1fr}
    }

    /* 売上入力のボタン文字が消える問題の修正 */
    .sales-pill{ color:#111 !important; }                 /* 追加行ボタン/削除ボタン/更新ボタンの文字を黒に */
    .sales-row .sales-pill{ color:#111 !important; }      /* 各明細行の「－ 削除」を黒に */
    #submitSales.sales-pill{ background:#111; color:#fff !important; border-color:#111; } /* 送信は黒ボタンで目立たせる */

  </style>
</head>

<body>
<header>
  <h1>卓タイマー管理</h1>
  <div class="toolbar">
    <input id="q" type="search" placeholder="キャスト名で検索（例: あや）" />
    <div class="now" id="now"></div>
  </div>
  <nav class="top-tabs">
    <a id="navTimer" class="tab active" href="#timer">卓タイマー管理</a>
    <a id="navSales" class="tab" href="#sales">売上入力</a>
  </nav>
</header>

<main>

  <!-- ページ①：タイマー -->
  <section id="pageTimer" class="page">
    <section class="floor" id="floor">
      <div class="legend">
        <span><i class="dot empty"></i>空席</span>
        <span><i class="dot ok"></i>計時中</span>
        <span><i class="dot warn"></i>残り10分未満</span>
        <span><i class="dot danger"></i>残り3分未満</span>
      </div>
      <div class="vipRow" id="vip"></div>
    </section>

    <section class="backstage">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
        <h2>控室（スプレッドシート連携）</h2>
        <div style="display:flex;align-items:center;gap:12px">
          <div class="legend-staff">
            <span><i class="dotS on"></i> 出勤（空き）</span>
            <span><i class="dotS busy"></i> 接客中</span>
            <span><i class="dotS off"></i> 休み/退勤</span>
          </div>
          <label style="font-size:12px"><input type="checkbox" id="editDuty" /> 出勤を編集</label>
          <button id="reloadStaff" class="secondary" type="button">更新</button>
        </div>
      </div>
      <div id="roster" class="roster"></div>
    </section>
  </section>

  <!-- ページ②：売上入力 -->
  <section id="pageSales" class="page">
    <section id="salesSection">
      <div class="sales-card">
        <div class="sales-grid">
          <label>ボーイ（1名）
            <div id="boyField" class="pickerField empty" aria-label="ボーイを選択">タップして選択</div>
          </label>
          <label>キャスト（複数可）
            <div id="castField" class="pickerField empty" aria-label="キャストを選択">タップして選択</div>
          </label>
        </div>

        <div id="salesLines"></div>

        <div class="sales-actions">
          <button id="addSalesLine" type="button" class="sales-pill">＋ 明細行を追加</button>
          <button id="submitSales"  type="button" class="sales-pill">送信</button>
          <button id="reloadSales"  type="button" class="sales-pill">更新（商品・名簿）</button>
        </div>

        <div class="sales-total">合計：<span id="salesTotal">¥0</span></div>
      </div>
    </section>
  </section>

</main>

<!-- 卓編集モーダル（既存） -->
<div class="modalWrap" id="modalWrap" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <h3 id="modalTitle">卓を編集</h3>
    <div class="row">
      <input id="cast" placeholder="キャスト（カンマ区切り）" list="castList" />
      <input id="boy" placeholder="担当ボーイ" list="boyList" />
      <datalist id="castList"></datalist>
      <datalist id="boyList"></datalist>
    </div>
    <div class="row chips">
      <span class="label" style="color:#374151;border:1px solid #d1d5db;background:#f9fafb;">時間</span>
      <div class="btns">
        <button class="quick" data-min="15" type="button">15分</button>
        <button class="quick" data-min="30" type="button">30分</button>
        <button class="quick" data-min="45" type="button">45分</button>
        <button class="quick" data-min="60" type="button">60分</button>
      </div>
    </div>
    <div class="row chips">
      <span class="label label-extend">延長</span>
      <div class="btns">
        <button class="extend" data-min="5" type="button">+5</button>
        <button class="extend" data-min="10" type="button">+10</button>
        <button class="extend" data-min="15" type="button">+15</button>
      </div>
    </div>

    <div class="row" style="gap:12px">
      <div class="suggBlock">
        <div class="suggTitle">出勤キャスト（タップで追加）</div>
        <div id="suggCast" class="suggList"></div>
      </div>
      <div class="suggBlock">
        <div class="suggTitle">出勤ボーイ（タップで設定）</div>
        <div id="suggBoy" class="suggList"></div>
      </div>
    </div>

    <div class="row twoCols">
      <input id="manual" inputmode="numeric" placeholder="分を入力 → 開始" />
      <button id="start" type="button">開始</button>
    </div>
    <div class="row btns" style="justify-content:space-between">
      <button id="saveMeta" class="secondary" type="button">キャスト/ボーイを保存</button>
      <div>
        <button id="clear" class="danger" type="button">クリア（空席）</button>
        <button id="close" class="secondary" type="button">閉じる</button>
      </div>
    </div>
  </div>
</div>

<!-- NEW: ボーイ/キャスト ピッカーモーダル -->
<div class="pickerWrap" id="pickerWrap" aria-hidden="true">
  <div class="pickerPanel" role="dialog" aria-modal="true">
    <div class="pickerHead">
      <h3 id="pickerTitle" style="margin:0;font-size:16px">選択</h3>
      <div class="pickerBtns">
        <button id="pickerClear" class="secondary" type="button">全クリア</button>
        <button id="pickerOk" type="button">決定</button>
        <button id="pickerClose" class="secondary" type="button">キャンセル</button>
      </div>
    </div>
    <div id="pickerList" class="suggList"></div>
  </div>
</div>

<script>
/* ================= スタッフ（スプシ） ================= */
const STAFF_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRyaTH8TVNV12iTbB9I2pL65t3ImLMB4-nA2--vaHU5Gc1ok1sCSEw1FUSDfZlVO0Cs8WWMVzF_7MaR/pub?gid=1348648909&single=true&output=csv';
let staff = []; 
let dutyMap = JSON.parse(localStorage.getItem('staff.duty.map') || '{}');
window.staff = staff; window.dutyMap = dutyMap;

/* ================= 席データ ================= */
const seats = (()=>{const saved=localStorage.getItem('seats.v2');if(saved){const arr=JSON.parse(saved);arr.forEach(s=>{if(s.finished===undefined)s.finished=false});return arr;}
const a=[];for(let i=1;i<=8;i++)a.push({id:`R${i}`,label:`VIP ${i}`,group:'red',cast:'',boy:'',end:null,finished:false});
for(let i=1;i<=7;i++)a.push({id:`B${i}`,label:`ノーマル ${i}`,group:'blue',cast:'',boy:'',end:null,finished:false});
for(let i=1;i<=3;i++)a.push({id:`V${i}`,label:`超VIP ${i}`,group:'vip',cast:'',boy:'',end:null,finished:false});return a;})();
const save = () => localStorage.setItem('seats.v2', JSON.stringify(seats));

/* --------- 座席座標 --------- */
const POS={R8:{top:15,left:25,width:13},R7:{top:15,left:39,width:13},R6:{top:15,left:53,width:13},R5:{top:15,left:67,width:13},
R1:{top:30,left:67,width:13},R2:{top:45,left:67,width:13},R3:{top:30,left:18,width:13},R4:{top:45,left:18,width:13},
B1:{top:22,left:87,width:10},B2:{top:36,left:87,width:10},B3:{top:50,left:87,width:10},B4:{top:7,left:2,width:10},B5:{top:7,left:12,width:10},B6:{top:65,left:7,width:11},B7:{top:65,left:84,width:11}};

/* ================= 要素参照 ================= */
const $=s=>document.querySelector(s);
const floor=$('#floor'), vipWrap=$('#vip'), nowEl=$('#now');
const wrap=$('#modalWrap'), title=$('#modalTitle');
const castI=$('#cast'), boyI=$('#boy'), manI=$('#manual');
const suggCast=$('#suggCast'), suggBoy=$('#suggBoy');
let currentId=null, lastFocus=null;
const pageRoots=document.querySelectorAll('header, main');

/* ================= UI生成 ================= */
function cardHTML(s){
  const nameByGroup={red:'VIP',blue:'ノーマル',vip:'超VIP'};
  const num=(s.id.match(/\d+/)||[''])[0];
  const label=`${nameByGroup[s.group]||s.label} ${num}`;
  const endAt=s.end?`～ ${formatClock(s.end)}`:'';
  return `
    <div class="line1"><span>${label}</span><span class="endAt">${endAt}</span></div>
    <div class="timer">${s.end?formatRemain(s.end-Date.now()):(s.finished?'終了':'空')}</div>
    <div class="meta">${(s.cast||'')}${s.boy?' ｜ '+s.boy:''}</div>`;
}
function addVipSeat(s){const d=document.createElement('div');d.className='vipSeat';d.dataset.id=s.id;d.innerHTML=cardHTML(s);d.addEventListener('click',()=>openModal(s.id));vipWrap.appendChild(d);}
function addSeatToFloor(s){const pos=POS[s.id];if(!pos)return;const d=document.createElement('div');d.className=`seat ${s.group}`;d.dataset.id=s.id;d.style.top=pos.top+'%';d.style.left=pos.left+'%';d.style.width=pos.width+'%';d.innerHTML=cardHTML(s);d.addEventListener('click',()=>openModal(s.id));floor.appendChild(d);}

/* ================= レイアウト補正 ================= */
function resizeFloor(){const pad=12;const needed=vipWrap.offsetTop+vipWrap.offsetHeight+pad;$('#floor').style.height=needed+'px';}

/* ================= 描画 ================= */
function render(){
  floor.querySelectorAll('.seat').forEach(n=>n.remove());
  vipWrap.innerHTML='';
  const q=$('#q').value.trim();

  seats.forEach(s=>{ if(s.group==='vip') addVipSeat(s); else addSeatToFloor(s); });

  floor.querySelectorAll('[data-id]').forEach(el=>{
    const s=seats.find(x=>x.id===el.dataset.id); const t=el.querySelector('.timer');
    el.classList.remove('active','warn','danger','highlight');
    if(s.end){
      const r=s.end-Date.now();
      if(r>0){ t.textContent=formatRemain(r); el.classList.add('active'); if(r<=3*60*1000)el.classList.add('danger'); else if(r<=10*60*1000)el.classList.add('warn'); }
      else{ s.end=null; s.finished=true; save(); t.textContent='終了'; }
    }else{ t.textContent=s.finished?'終了':'空'; }
    if(q && s.cast && s.cast.includes(q)) el.classList.add('highlight');
  });
  resizeFloor(); renderRoster();
}
window.seats=seats; window.render=render;

/* ================= タイマー進行 ================= */
function tick(){
  nowEl.textContent=new Date().toLocaleString('ja-JP',{hour12:false});
  floor.querySelectorAll('[data-id]').forEach(el=>{
    const s=seats.find(x=>x.id===el.dataset.id); const t=el.querySelector('.timer');
    el.classList.remove('active','warn','danger');
    const endAtEl=el.querySelector('.endAt'); if(endAtEl) endAtEl.textContent=s.end?`～ ${formatClock(s.end)}`:'';
    if(!s.end){ t.textContent=s.finished?'終了':'空'; return; }
    const r=s.end-Date.now(); if(r<=0){ s.end=null; s.finished=true; save(); t.textContent='終了'; return; }
    t.textContent=formatRemain(r); el.classList.add('active');
    if(r<=3*60*1000) el.classList.add('danger'); else if(r<=10*60*1000) el.classList.add('warn');
  });
  if(staff.length) renderRoster();
}
function formatRemain(ms){const s=Math.floor(ms/1000),h=Math.floor(s/3600),m=Math.floor((s%3600)/60),ss=s%60;return (h?String(h).padStart(2,'0')+':':'')+String(m).padStart(2,'0')+':'+String(ss).padStart(2,'0');}
function formatClock(ts){let ms=null;if(ts==null)return'';if(typeof ts==='number')ms=ts;else if(typeof ts==='string'&&/^\d+$/.test(ts))ms=Number(ts);else if(typeof ts==='object'&&typeof ts.toMillis==='function')ms=ts.toMillis();else if(typeof ts==='object'&&typeof ts.seconds==='number')ms=ts.seconds*1000+Math.floor((ts.nanoseconds||0)/1e6);const d=new Date(ms);if(Number.isNaN(d.getTime()))return'';return d.toLocaleTimeString('ja-JP',{hour12:false,hour:'2-digit',minute:'2-digit'});}

/* ================= モーダル（卓編集） ================= */
function openModal(id){
  lastFocus=document.activeElement; const s=seats.find(x=>x.id===id); currentId=id;
  const nameByGroup={red:'VIP',blue:'ノーマル',vip:'超VIP'}; const num=(s.id.match(/\d+/)||[''])[0];
  title.textContent=`席を編集：${nameByGroup[s.group]||s.label} ${num}`;
  castI.value=s.cast||''; boyI.value=s.boy||''; manI.value='';
  pageRoots.forEach(el=>el.setAttribute('inert','')); 
  wrap.removeAttribute('aria-hidden'); wrap.hidden=false; wrap.style.display='grid';
  fillSuggestionBlocks(); requestAnimationFrame(()=>castI.focus());
}
function closeModal(){
  const fallback=document.getElementById('q')||document.body;
  if(wrap.contains(document.activeElement)){ (lastFocus && document.contains(lastFocus)?lastFocus:fallback).focus(); }
  pageRoots.forEach(el=>el.removeAttribute('inert'));
  wrap.setAttribute('aria-hidden','true'); wrap.hidden=true; wrap.style.display='none';
}
document.getElementById('close').addEventListener('click', closeModal);
wrap.addEventListener('click', e=>{ if(e.target===wrap) closeModal(); });

document.getElementById('saveMeta').addEventListener('click', ()=>{
  const s=seats.find(x=>x.id===currentId); s.cast=castI.value.trim(); s.boy=boyI.value.trim(); save(); if(window.syncSeat) window.syncSeat(s); render(); closeModal();
});
document.getElementById('clear').addEventListener('click', ()=>{
  const s=seats.find(x=>x.id===currentId); s.end=null; s.cast=''; s.boy=''; s.finished=false; save(); if(window.syncSeat) window.syncSeat(s); render(); castI.value=''; boyI.value=''; manI.value=''; closeModal();
});
document.getElementById('start').addEventListener('click', ()=>{
  const v=Number(manI.value); if(!v||v<=0) return alert('分数を入力してください');
  const s=seats.find(x=>x.id===currentId); s.cast=castI.value.trim(); s.boy=boyI.value.trim(); s.end=Date.now()+v*60*1000; s.finished=false; save(); if(window.syncSeat) window.syncSeat(s); render(); closeModal();
});
document.querySelectorAll('button.quick').forEach(b=>b.addEventListener('click', ()=>{
  const mins=Number(b.dataset.min); const s=seats.find(x=>x.id===currentId);
  s.cast=castI.value.trim(); s.boy=boyI.value.trim(); s.end=Date.now()+mins*60*1000; s.finished=false; save(); if(window.syncSeat) window.syncSeat(s); render(); closeModal();
}));
document.querySelectorAll('button.extend').forEach(b=>b.addEventListener('click', ()=>{
  const mins=Number(b.dataset.min); const s=seats.find(x=>x.id===currentId);
  const base=s.end && s.end>Date.now()? s.end:Date.now(); s.end=base+mins*60*1000; s.finished=false;
  if(!s.cast) s.cast=castI.value.trim(); if(!s.boy) s.boy=boyI.value.trim();
  save(); if(window.syncSeat) window.syncSeat(s); render(); closeModal();
}));
document.getElementById('q').addEventListener('input', render);

/* ================= CSVパース/控室 ================= */
function parseCSV(str){const rows=[];let cur=[],val='',inQ=false;for(let i=0;i<str.length;i++){const c=str[i];if(inQ){if(c=='"'){if(str[i+1]=='"'){val+='"';i++;}else inQ=false;}else val+=c;}else{if(c=='"'){inQ=true;}else if(c==','){cur.push(val);val='';}else if(c=='\n'){cur.push(val);rows.push(cur);cur=[];val='';}else if(c=='\r'){}else val+=c;}} if(val.length>0||cur.length>0){cur.push(val);rows.push(cur);} return rows;}
function parseStaffNamesFromCSV(csv){
  const rowsRaw=parseCSV(csv); const rows=rowsRaw.filter(r=>r&&r.some(c=>(c||'').trim()!==''));
  if(!rows.length) return [];
  let headerRowIdx=-1,nameIdx=-1; const MAX_SCAN=Math.min(rows.length,10);
  for(let i=0;i<MAX_SCAN;i++){const idx=rows[i].findIndex(c=>String(c||'').trim()==='従業員'); if(idx>=0){headerRowIdx=i;nameIdx=idx;break;}}
  if(headerRowIdx<0) headerRowIdx=0; if(nameIdx<0) nameIdx=12;
  const names=rows.slice(headerRowIdx+1).map(r=>(r[nameIdx]||'').trim()).filter(v=>v&&v!=='従業員'); return [...new Set(names)];
}
async function loadStaff(){
  if(!STAFF_CSV_URL) return;
  try{
    const res=await fetch(STAFF_CSV_URL,{cache:'no-store'});
    const csv=await res.text(); const names=parseStaffNamesFromCSV(csv);
    const newStaff=names.map(n=>({name:n,duty:!!(window.dutyMap?.[n])}));
    staff.splice(0,staff.length,...newStaff); window.staff=staff;
    localStorage.setItem('staff.cache.names',JSON.stringify(names));
    fillDatalists(); renderRoster(); renderSalesFields();
    console.log(`[Roster] CSV読込: ${names.length}件`);
  }catch(e){
    console.error('スタッフ読み込み失敗',e);
    const cache=JSON.parse(localStorage.getItem('staff.cache.names')||'[]');
    staff=cache.map(n=>({name:n,duty:!!dutyMap[n]}));
    fillDatalists(); renderRoster(); renderSalesFields();
  }
}
function toggleDuty(name){
  dutyMap[name]=!dutyMap[name]; localStorage.setItem('staff.duty.map',JSON.stringify(dutyMap));
  staff.forEach(s=>{ if(s.name===name) s.duty=!!dutyMap[name]; }); fillDatalists(); renderRoster();
  if(window.syncDuty) window.syncDuty(name,dutyMap[name]);
}
function isNameBusy(name){
  name=name.trim();
  return seats.some(s=>{
    const castNames=(s.cast||'').split(',').map(x=>x.trim()).filter(Boolean);
    if(castNames.includes(name) || (s.boy||'').trim()===name){ return !!(s.end || s.finished); }
    return false;
  });
}
function addCastName(name){
  const list=castI.value.split(',').map(v=>v.trim()).filter(Boolean);
  if(!list.includes(name)){ list.push(name); castI.value=list.join(', '); }
}
function renderRoster(){
  const rosterBox=document.getElementById('roster'); if(!rosterBox) return;
  rosterBox.innerHTML='';
  if(!staff.length){
    const small=document.createElement('div'); small.style.color='#64748b'; small.style.fontSize='12px';
    small.textContent='（CSVのURLが未設定か、スプレッドシートを「ウェブに公開（CSV）」にしていない可能性があります）';
    rosterBox.appendChild(small); return;
  }
  const editSwitch=document.getElementById('editDuty');
  const addChip=(name,duty,busy)=>{
    const d=document.createElement('button'); d.type='button';
    d.className=`staffChip ${duty?(busy?'busy':'on'):'off'}`; d.textContent=name;
    if(editSwitch && editSwitch.checked){ d.disabled=false; d.addEventListener('click',()=>toggleDuty(name)); }
    else{
      if(!duty) d.disabled=true;
      else d.addEventListener('click',()=>{
        if(wrap.getAttribute('aria-hidden')==='false'){
          if(document.activeElement===boyI){ boyI.value=name; boyI.focus(); }
          else{ addCastName(name); castI.focus(); }
        }
      });
    }
    rosterBox.appendChild(d);
  };
  staff.filter(s=>s.duty).forEach(s=>addChip(s.name,true,isNameBusy(s.name)));
  const off=staff.filter(s=>!s.duty);
  if(off.length){
    const title=document.createElement('div'); title.className='staffSectionTitle'; title.textContent='— 非出勤 —'; rosterBox.appendChild(title);
    off.forEach(s=>addChip(s.name,false,false));
  }
}
function fillDatalists(){
  const castDL=document.getElementById('castList');
  const boyDL=document.getElementById('boyList');
  const onList=staff.filter(s=>s.duty).map(s=>s.name);
  castDL.innerHTML=onList.map(n=>`<option value="${n}">`).join('');
  boyDL.innerHTML =onList.map(n=>`<option value="${n}">`).join('');
}
function fillSuggestionBlocks(){
  const onList=staff.filter(s=>s.duty).map(s=>s.name);
  suggCast.innerHTML=onList.map(n=>`<button type="button" class="staffChip on" data-name="${n}">${n}</button>`).join('');
  suggCast.querySelectorAll('button').forEach(b=>b.addEventListener('click',()=>{
    const name=b.dataset.name; const list=castI.value.split(',').map(v=>v.trim()).filter(Boolean);
    if(!list.includes(name)) list.push(name); castI.value=list.join(', '); castI.focus();
  }));
  suggBoy.innerHTML=onList.map(n=>`<button type="button" class="staffChip on" data-name="${n}">${n}</button>`).join('');
  suggBoy.querySelectorAll('button').forEach(b=>b.addEventListener('click',()=>{ boyI.value=b.dataset.name; boyI.focus(); }));
}

/* ==================== 売上：ピッカー（NEW） ==================== */
const boyField  = document.getElementById('boyField');
const castField = document.getElementById('castField');
const pickerWrap   = document.getElementById('pickerWrap');
const pickerTitle  = document.getElementById('pickerTitle');
const pickerList   = document.getElementById('pickerList');
const pickerOk     = document.getElementById('pickerOk');
const pickerClear  = document.getElementById('pickerClear');
const pickerClose  = document.getElementById('pickerClose');

let salesBoy = '';      // 単一
let salesCast = [];     // 複数
let pickerMode = null;  // 'boy' | 'cast'
let tmpBoy = '';
let tmpCast = [];

function renderSalesFields(){
  // Boy field
  boyField.classList.toggle('empty', !salesBoy);
  boyField.innerHTML = salesBoy ? `<span class="pill">${salesBoy}</span>` : 'タップして選択';

  // Cast field
  castField.classList.toggle('empty', salesCast.length===0);
  castField.innerHTML = salesCast.length
    ? salesCast.map(n=>`<span class="pill">${n}</span>`).join('')
    : 'タップして選択';
}
window.renderSalesFields = renderSalesFields;
// 互換（Firebaseの購読で呼ばれてもOK）
window.renderSalesStaffPickers = renderSalesFields;

boyField.addEventListener('click', ()=>openPicker('boy'));
castField.addEventListener('click', ()=>openPicker('cast'));

function openPicker(mode){
  pickerMode = mode;
  pickerTitle.textContent = (mode==='boy') ? 'ボーイを選択（1名）' : 'キャストを選択（複数可）';
  tmpBoy  = salesBoy;
  tmpCast = [...salesCast];

  buildPickerList();
  pickerWrap.style.display='grid';
  pickerWrap.removeAttribute('aria-hidden');
}
function closePicker(){
  pickerWrap.style.display='none';
  pickerWrap.setAttribute('aria-hidden','true');
}
pickerWrap.addEventListener('click', e=>{ if(e.target===pickerWrap) closePicker(); });
pickerClose.addEventListener('click', closePicker);
pickerClear.addEventListener('click', ()=>{
  if(pickerMode==='boy') tmpBoy='';
  else tmpCast=[];
  buildPickerList();
});
pickerOk.addEventListener('click', ()=>{
  if(pickerMode==='boy') salesBoy = tmpBoy;
  else salesCast = [...tmpCast];
  renderSalesFields();
  closePicker();
});

function buildPickerList(){
  const onList=(window.staff||[]).filter(s=>s.duty).map(s=>({name:s.name, busy:isNameBusy(s.name)}));
  pickerList.innerHTML = onList.map(x=>{
    const selected = (pickerMode==='boy') ? (tmpBoy===x.name) : tmpCast.includes(x.name);
    return `<button type="button" class="staffChip ${x.busy?'busy':'on'} ${selected?'selected':''}" data-name="${x.name}">${x.name}</button>`;
  }).join('');
  pickerList.querySelectorAll('button').forEach(b=>{
    b.addEventListener('click', ()=>{
      const name=b.dataset.name;
      if(pickerMode==='boy'){
        tmpBoy = (tmpBoy===name) ? '' : name;
      }else{
        if(tmpCast.includes(name)) tmpCast = tmpCast.filter(n=>n!==name);
        else tmpCast = [...tmpCast, name];
      }
      buildPickerList();
    });
  });
}

/* ================= 初期化（共通） ================= */
render(); setInterval(tick,1000); window.addEventListener('resize', resizeFloor);
if(STAFF_CSV_URL) loadStaff(); setInterval(()=>{ if(STAFF_CSV_URL) loadStaff(); },60000);
</script>

<!-- Firebase 同期（そのまま） -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getFirestore, collection, doc, setDoc, getDocs, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBru7m0EGNXBgRTzsmQMZknlAAirkTwwpw",
  authDomain: "alexandria-8d142.firebaseapp.com",
  projectId: "alexandria-8d142",
  storageBucket: "alexandria-8d142.firebasestorage.app",
  messagingSenderId: "78904719003",
  appId: "1:78904719003:web:234e7d8b0703bad614f83e",
  measurementId: "G-6TJNLEHJXQ"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const auth= getAuth(app);
const ROOM_ID="default";

signInAnonymously(auth).catch(console.error);
onAuthStateChanged(auth, async (u) => {
  if(!u) return;
  await ensureInitialSeats(); listenSeats(); listenDuty();
});

async function ensureInitialSeats(){
  const colRef=collection(db,"rooms",ROOM_ID,"seats");
  const snap=await getDocs(colRef);
  if(!snap.empty) return;
  const init=[]; for(let i=1;i<=8;i++) init.push({id:`R${i}`,label:`VIP ${i}`,group:'red',cast:'',boy:'',end:null,finished:false});
  for(let i=1;i<=7;i++) init.push({id:`B${i}`,label:`ノーマル ${i}`,group:'blue',cast:'',boy:'',end:null,finished:false});
  for(let i=1;i<=3;i++) init.push({id:`V${i}`,label:`超VIP ${i}`,group:'vip',cast:'',boy:'',end:null,finished:false});
  await Promise.all(init.map(s=> setDoc(doc(db,"rooms",ROOM_ID,"seats",s.id),{...s,updatedAt:serverTimestamp()})));
}
function listenSeats(){
  const colRef=collection(db,"rooms",ROOM_ID,"seats");
  onSnapshot(colRef,(qs)=>{
    const byId={}; qs.forEach(d=>byId[d.id]=d.data());
    const base=Array.isArray(window.seats)?window.seats:[];
    const ordered=base.map(s=>byId[s.id]??s);
    if(!ordered.length) Object.keys(byId).sort().forEach(id=>ordered.push(byId[id]));
    if(!Array.isArray(window.seats)) window.seats=[];
    window.seats.splice(0,window.seats.length,...ordered);
    if(typeof window.render==='function') window.render();
  });
}
async function saveSeatRemote(s){
  await setDoc(doc(db,"rooms",ROOM_ID,"seats",s.id),{...s,updatedAt:serverTimestamp()},{merge:true});
}
const dutyCol=collection(db,"rooms",ROOM_ID,"duty");
function listenDuty(){
  onSnapshot(dutyCol,(qs)=>{
    const remote={}; qs.forEach(d=>remote[d.id]=!!(d.data()?.duty));
    window.dutyMap={...(window.dutyMap||{}),...remote};
    localStorage.setItem('staff.duty.map',JSON.stringify(window.dutyMap));
    const arr=Array.isArray(window.staff)?window.staff:[];
    for(let i=0;i<arr.length;i++){ arr[i].duty=!!window.dutyMap[arr[i].name]; }
    window.fillDatalists && window.fillDatalists();
    window.renderRoster && window.renderRoster();
    window.renderSalesFields && window.renderSalesFields();
  });
}
async function saveDutyRemote(name,duty){
  const id=name.replace(/\//g,'／');
  await setDoc(doc(dutyCol,id),{duty:!!duty,updatedAt:serverTimestamp()},{merge:true});
}
window.syncDuty=saveDutyRemote; window.syncSeat=saveSeatRemote;
</script>

<!-- 売上入力（商品CSV/送信） -->
<script>
// ★商品はスタッフと同じCSVから取る（B:商品 / C:値段）
const PRODUCTS_CSV_URL = STAFF_CSV_URL;
const SALES_GAS_URL    = 'https://script.google.com/macros/s/AKfycbwP_n70AlN5TrYvpVRR_tdaOJ8umm61B7bW_s-RQZ1cCeGBkIai3RlgLrbWK7ztPn5Z/exec';


const linesBox=document.getElementById('salesLines');
const totalEl=document.getElementById('salesTotal');
let PRODUCTS=[], LINE_SEQ=0;

const yen = n => new Intl.NumberFormat('ja-JP',{style:'currency',currency:'JPY'}).format(Number(n||0));
const toNum = v => Number(String(v||'').replace(/[^\d.-]/g,''))||0;

function parseProductsFromCSV(csv){
  // 既存の parseCSV が使えます
  const rows = parseCSV(csv).filter(r => r && r.some(c => (c||'').trim() !== ''));
  if (!rows.length) return [];

  // 先頭～10行で「商品 / 値段|価格|金額」の見出しがあるか探す
  let nameIdx = -1, priceIdx = -1, headerRow = -1;
  for (let i = 0; i < Math.min(10, rows.length); i++){
    const rr = rows[i];
    const n  = rr.findIndex(c => /商品/.test(String(c||'')));
    const p  = rr.findIndex(c => /(値段|価格|金額)/.test(String(c||'')));
    if (n >= 0 && p >= 0){ nameIdx = n; priceIdx = p; headerRow = i; break; }
  }
  // 見出しが無い場合は B/C を使う（0始まりで1/2）
  if (nameIdx < 0) nameIdx = 1;
  if (priceIdx < 0) priceIdx = 2;

  // データ開始行（見出しが見つかったらその次の行から）
  const dataRows = rows.slice(headerRow >= 0 ? headerRow + 1 : 0);

  return dataRows
    .map(r => ({ name: (r[nameIdx]||'').trim(), price: Number(String(r[priceIdx]||'').replace(/[^\d.-]/g,'')) || 0 }))
    .filter(p => p.name);
}

async function loadProducts(){
  if(!PRODUCTS_CSV_URL) return;
  const res=await fetch(PRODUCTS_CSV_URL,{cache:'no-store'});
  const csv=await res.text(); PRODUCTS=parseProductsFromCSV(csv); rebuildAllLines();
}

function buildLine(init){
  const id=++LINE_SEQ; const row=document.createElement('div'); row.className='sales-row'; row.dataset.lineId=id;
  const sel=document.createElement('select');
  sel.innerHTML=`<option value="">（商品を選択）</option>`+PRODUCTS.map(p=>`<option data-price="${p.price}" value="${p.name}">${p.name}</option>`).join('');
  if(init?.product) sel.value=init.product;

  const unitEl=document.createElement('div'); unitEl.className='sales-yen'; unitEl.textContent=yen(init?.unitPrice||0);
  const qty=document.createElement('input'); qty.type='number'; qty.min='0'; qty.step='1'; qty.value=init?.qty ?? 0;
  const subEl=document.createElement('div'); subEl.className='sales-yen'; subEl.textContent=yen((init?.unitPrice||0)*(init?.qty||0));
  const del=document.createElement('button'); del.type='button'; del.className='sales-pill'; del.textContent='－ 削除'; del.addEventListener('click',()=>{ row.remove(); recalcTotal(); });

  sel.addEventListener('change',()=>{ const price=Number(sel.selectedOptions[0]?.dataset.price||0); unitEl.textContent=yen(price); subEl.textContent=yen(price*Number(qty.value||0)); recalcTotal(); });
  qty.addEventListener('input',()=>{ const price=Number(sel.selectedOptions[0]?.dataset.price||0); subEl.textContent=yen(price*Number(qty.value||0)); recalcTotal(); });

  row.appendChild(sel); row.appendChild(unitEl); row.appendChild(qty); row.appendChild(subEl); row.appendChild(del);
  linesBox.appendChild(row);
}
function rebuildAllLines(){ const keep=[...linesBox.querySelectorAll('.sales-row')].length || 1; linesBox.innerHTML=''; for(let i=0;i<keep;i++) buildLine(); recalcTotal(); }
function recalcTotal(){ let sum=0; linesBox.querySelectorAll('.sales-row').forEach(row=>{ const sel=row.querySelector('select'); const unit=Number(sel.selectedOptions[0]?.dataset.price||0); const qty=Number(row.querySelector('input').value||0); sum += unit*qty; }); totalEl.textContent=yen(sum); }

/* 送信 */
function collectPayload(){
  const rows=[...linesBox.querySelectorAll('.sales-row')].map(row=>{ const sel=row.querySelector('select'); const unit=Number(sel.selectedOptions[0]?.dataset.price||0); const qty=Number(row.querySelector('input').value||0); const product=sel.value||''; return {product,unitPrice:unit,qty,amount:unit*qty}; }).filter(r=>r.product && r.qty>0);
  const cast=[...salesCast]; const boy=salesBoy||''; const total=rows.reduce((a,b)=>a+b.amount,0);
  return { rows, cast, boy, total, timestamp: Date.now() };
}
document.getElementById('addSalesLine').addEventListener('click',()=>buildLine());
document.getElementById('reloadSales').addEventListener('click',()=>{ loadProducts(); renderSalesFields(); });
document.getElementById('submitSales').addEventListener('click', async ()=>{
  const payload = collectPayload();
  if(!payload.rows.length) return alert('明細がありません');
  if(!SALES_GAS_URL) return alert('送信先URLが未設定です');

  try{
    const res = await fetch(SALES_GAS_URL, {
      method:'POST',
      headers:{ 'Content-Type':'text/plain;charset=utf-8' },
      body: JSON.stringify(payload)
    });
    // 401/500 なども拾う
    const text = await res.text();
    let json = {};
    try { json = JSON.parse(text); } catch(_) {}
    if(!res.ok || json.ok === false){
      throw new Error(json.error || `HTTP ${res.status}`);
    }

    alert('登録しました');
    // 送信成功 → ボーイ/キャストをリセット
    salesBoy = ''; salesCast = []; tmpBoy = ''; tmpCast = []; renderSalesFields();
    
    linesBox.innerHTML=''; 
    buildLine(); 
    recalcTotal();

  }catch(e){
    alert('送信エラー: ' + e.message);
    console.error(e);
  }
});


/* 初期起動 */
loadProducts(); renderSalesFields(); buildLine();
</script>

<!-- ルーター -->
<script>
  function route(){
    const page=(location.hash||'#timer').replace('#','');
    const isTimer=page==='timer';
    document.getElementById('pageTimer').style.display=isTimer?'block':'none';
    document.getElementById('pageSales').style.display=isTimer?'none':'block';
    document.getElementById('navTimer').classList.toggle('active',isTimer);
    document.getElementById('navSales').classList.toggle('active',!isTimer);
    window.scrollTo(0,0);
  }
  window.addEventListener('hashchange', route);
  route();
</script>

</body>
</html>
