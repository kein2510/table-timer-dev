<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>卓タイマー管理 + 控室（スプシ連携）【DEV】</title>
  <link rel="icon" href="data:," />
  <style>
    :root{
      --bg:#f4f6f8; --panel:#fff; --text:#111;
      --red:#e74c3c; --blue:#2e86de; --vip:#9b59b6;
      --ok:#e7ffe7; --warn:#fff3cd; --danger:#ffe0e0; --gold:#ffdd57;
      --staff-on-bg:#e6f4ea; --staff-on-border:#34a853; --staff-on-text:#0b6630;
      --staff-busy-bg:#fff3cd; --staff-busy-border:#f59e0b; --staff-busy-text:#7a4e00;
      --staff-off-bg:#f1f5f9; --staff-off-border:#cbd5e1; --staff-off-text:#94a3b8;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Arial,sans-serif}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px 14px;background:#1f1f23;color:#fff;position:sticky;top:0;z-index:5}
    header h1{margin:0;font-size:18px}
    .toolbar{display:flex;gap:8px;align-items:center}
    .toolbar input{padding:8px;border-radius:8px;border:1px solid #ccc;min-width:220px}
    .now{opacity:.85}

    .top-tabs{display:inline-flex;gap:.5rem;margin-left:1rem}
    .top-tabs .tab{padding:.35rem .8rem;border:1px solid #ddd;border-radius:999px;background:#fff;color:#111!important;text-decoration:none}
    .top-tabs .tab.active{box-shadow:0 1px 4px #0001;font-weight:700}

    main{padding:12px;display:block}
    .page{display:none}
    /* ← 落ちたとき白画面を避ける */
    #pageTimer{display:block}

    /* --- 既存のスタイル（省略せず残す） --- */
    .floor{position:relative;background:var(--panel);border:1px solid #ddd;border-radius:12px;overflow:hidden;padding:4px;min-height:750px}
    .seat{position:absolute;background:#fff;border:2px solid #bbb;border-radius:10px;padding:6px;min-height:64px;min-width:80px;cursor:pointer;display:flex;flex-direction:column;gap:4px;transition:transform .05s, box-shadow .1s, background .2s;box-shadow:0 1px 0 #0001}
    .seat:hover{transform:translateY(-1px)} .seat.red{border-color:var(--red)} .seat.blue{border-color:var(--blue)}
    .seat.active{background:var(--ok)} .seat.warn{background:var(--warn)} .seat.danger{background:var(--danger)}
    .seat.highlight{box-shadow:0 0 0 3px var(--gold) inset}
    .line1{display:flex;justify-content:space-between;align-items:center;font-weight:700}
    .line1 .endAt{font-weight:700;font-size:18px;opacity:.8;margin-left:10px;white-space:nowrap}
    .timer{font-size:18px;font-weight:800} .meta{font-size:18px;line-height:1.25;opacity:.95;overflow-wrap:anywhere}
    .vipRow{position:absolute;left:15%;right:15%;bottom:7%;display:flex;gap:12px;z-index:2}
    .vipSeat{background:#fff;border:2px dashed var(--vip);border-radius:12px;padding:10px;min-height:100px;flex:1;cursor:pointer;display:flex;flex-direction:column;gap:6px}
    .vipSeat.active{background:var(--ok)} .vipSeat.warn{background:var(--warn)} .vipSeat.danger{background:var(--danger)}
    .vipSeat .timer{font-size:22px}
    .backstage{background:var(--panel);border:1px solid #ddd;border-radius:12px;padding:10px;margin-top:12px}
    .roster{display:flex;flex-wrap:wrap;gap:8px}
    .staffChip{padding:6px 10px;border-radius:999px;border:1px solid #cbd5e1;background:#f8fafc;cursor:pointer;font-size:14px}
    .staffChip.on{background:var(--staff-on-bg);border:1px solid var(--staff-on-border);color:var(--staff-on-text)}
    .staffChip.busy{background:var(--staff-busy-bg);border:1px solid var(--staff-busy-border);color:var(--staff-busy-text)}
    .staffChip.off{background:var(--staff-off-bg);border:1px solid var(--staff-off-border);color:var(--staff-off-text)}
    .modalWrap{position:fixed;inset:0;background:#0008;display:none;place-items:center;z-index:9}
    .modal{background:#fff;border-radius:14px;padding:16px;min-width:300px;max-width:92vw;box-shadow:0 20px 60px #0006}
    .sales-card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px}
    .sales-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:8px}
    .pickerField{border:1px solid #dcdfe3;background:#f9fafb;border-radius:12px;padding:8px;min-height:46px;display:flex;gap:6px;align-items:center;flex-wrap:wrap;cursor:pointer}
    .pickerField.empty{color:#94a3b8} .pill{padding:4px 10px;border-radius:999px;border:1px solid #cbd5e1;background:#fff;font-size:12px}
    .sales-row{display:grid;grid-template-columns:1.2fr .6fr .6fr .8fr auto;gap:8px;align-items:center;margin:6px 0}
    .sales-yen{min-width:6em;text-align:right;padding:.45rem .6rem;background:#f8fafc;border:1px solid #e5e7eb;border-radius:.6rem}
    .sales-actions{display:flex;gap:8px;margin-top:10px}
    .sales-pill{padding:.35rem .6rem;border:1px dashed #cbd5e1;border-radius:999px;background:#f9fafb;cursor:pointer}
    .sales-pill{color:#111!important} .sales-row .sales-pill{color:#111!important} #submitSales.sales-pill{background:#111;color:#fff!important;border-color:#111}
    @media(max-width:900px){.toolbar input{min-width:160px}.seat{min-width:72px;min-height:60px}.sales-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div style="position:fixed;right:300px;top:8px;padding:6px 10px;border:1px dashed #888;font-weight:bold;z-index:9999;color:#fff;background:#222;">
    開発用（DEV） / ROOM_ID: dev
  </div>

  <header>
    <h1>卓タイマー管理</h1>
    <div class="toolbar">
      <input id="q" type="search" placeholder="キャスト名で検索（例: あや）" />
      <div class="now" id="now"></div>
    </div>
    <nav class="top-tabs">
      <a id="navTimer" class="tab active" href="#timer">卓タイマー管理</a>
      <a id="navSales" class="tab" href="#sales">売上入力</a>
      <a id="navAdmin" class="tab" href="#admin">幹部</a>
    </nav>
  </header>

  <main>
    <!-- タイマー -->
    <section id="pageTimer" class="page">
      <div class="floor" id="floor"><div class="vipRow" id="vip"></div></div>
      <section class="backstage">
        <h2>控室（スプレッドシート連携）</h2>
        <div id="roster" class="roster"></div>
      </section>
    </section>

    <!-- 売上 -->
    <section id="pageSales" class="page">
      <section id="salesSection">
        <div class="sales-card">
          <div class="sales-grid">
            <label>ボーイ（1名）<div id="boyField" class="pickerField empty">タップして選択</div></label>
            <label>キャスト（複数可）<div id="castField" class="pickerField empty">タップして選択</div></label>
          </div>
          <div id="salesLines"></div>
          <div class="sales-actions">
            <button id="addSalesLine" type="button" class="sales-pill">＋ 明細行を追加</button>
            <button id="submitSales"  type="button" class="sales-pill">送信</button>
            <button id="reloadSales"  type="button" class="sales-pill">更新（商品・名簿）</button>
          </div>
          <div class="sales-total">合計：<span id="salesTotal">¥0</span></div>
        </div>
      </section>
    </section>

    <!-- 幹部 -->
    <section id="pageAdmin" class="page">
      <div class="sales-card" style="margin-top:12px">
        <h2 style="margin:0 0 8px">ログイン</h2>
        <div id="adminLocked">
          <input id="adminCode" type="password" placeholder="幹部用パスコード" style="margin-right:6px">
          <button id="adminEnter" class="sales-pill">入室</button>
          <div style="font-size:12px;color:#64748b;margin-top:6px">* 店舗で共有する1つのパスコードだけで入室します</div>
        </div>
        <div id="adminUnlocked" style="display:none">
          <span style="font-size:12px;color:#64748b">幹部モード</span>
          <button id="adminLock" class="sales-pill" style="margin-left:8px">ロック</button>
        </div>
        <div id="adminWrong" style="display:none;color:#b91c1c;margin-top:6px">パスコードが違います</div>
      </div>

      <div id="panelStaff" class="sales-card" style="display:none">
        <h2 style="margin:0 0 8px">メンバー管理</h2>
        <div class="sales-grid">
          <label>名前<input id="stName" placeholder="例: あやか"></label>
          <label>役職
            <select id="stRole"><option value="cast">キャスト</option><option value="boy">ボーイ</option></select>
          </label>
          <label>出勤
            <select id="stDuty"><option value="false">false</option><option value="true">true</option></select>
          </label>
          <label>有効
            <select id="stActive"><option value="true">true</option><option value="false">false</option></select>
          </label>
        </div>
        <button id="stAdd" class="sales-pill">＋ 追加</button>
        <div id="stList" style="margin-top:8px"></div>
      </div>

      <div id="panelProd" class="sales-card" style="display:none">
        <h2 style="margin:0 0 8px">商品管理</h2>
        <div class="sales-grid">
          <label>商品名<input id="pdName" placeholder="例: 生ビール"></label>
          <label>価格（円）<input id="pdPrice" type="number" min="0" step="1" placeholder="例: 700"></label>
          <label>有効
            <select id="pdActive"><option value="true">true</option><option value="false">false</option></select>
          </label>
        </div>
        <button id="pdAdd" class="sales-pill">＋ 追加</button>
        <div id="pdList" style="margin-top:8px"></div>
      </div>

      <!-- 幹部用ロジック（module） -->
      <script type="module">
        import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
        const ROOM_ID = "dev";
        const ADMIN_PASS_PLAIN = "test";
        const LS_PREFIX = window.LS_PREFIX || "tt-dev-";
        const $ = s => document.querySelector(s);
        const esc = s => String(s).replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));
        async function sha256Hex(text){const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(text));return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');}
        const KEY=LS_PREFIX+"admin.unlocked";
        const $locked=$('#adminLocked'),$unlocked=$('#adminUnlocked'),$wrong=$('#adminWrong'),$code=$('#adminCode');
        function applyState(open){$locked.style.display=open?'none':'block';$unlocked.style.display=open?'block':'none';$wrong.style.display='none';$('#panelStaff').style.display=open?'block':'none';$('#panelProd').style.display=open?'block':'none';}
        applyState(sessionStorage.getItem(KEY)==='1');
        document.getElementById('adminEnter').addEventListener('click',async()=>{const input=($code.value||'').trim();if(!input)return;const ok=(await sha256Hex(input))===(await sha256Hex(ADMIN_PASS_PLAIN)); if(ok){sessionStorage.setItem(KEY,'1');applyState(true);$code.value='';}else{$wrong.style.display='block';}});
        document.getElementById('adminLock').addEventListener('click',()=>{sessionStorage.removeItem(KEY);applyState(false);});
        const app=getApps().length?getApps()[0]:initializeApp({apiKey:"AIzaSyBru7m0EGNXBgRTzsmQMZknlAAirkTwwpw",authDomain:"alexandria-8d142.firebaseapp.com",projectId:"alexandria-8d142",storageBucket:"alexandria-8d142.firebasestorage.app",messagingSenderId:"78904719003",appId:"1:78904719003:web:234e7d8b0703bad614f83e",measurementId:"G-6TJNLEHJXQ"});
        const db=getFirestore(app);

        // staff CRUD
        const stCol=collection(db,'rooms',ROOM_ID,'staff');
        $('#stAdd').onclick=async()=>{const name=($('#stName').value||'').trim();const role=$('#stRole').value;const duty=$('#stDuty').value==='true';const active=$('#stActive').value==='true';if(!name)return alert('名前を入力');const id=name.replace(/\//g,'／');await setDoc(doc(stCol,id),{name,role,duty,active,updatedAt:serverTimestamp()},{merge:true});$('#stName').value='';};
        onSnapshot(stCol,(qs)=>{const rows=[];qs.forEach(d=>rows.push({id:d.id,...(d.data()||{})}));rows.sort((a,b)=>String(a.name||'').localeCompare(String(b.name||''),'ja'));$('#stList').innerHTML=rows.map(s=>`
          <div style="display:grid;grid-template-columns:2fr 1fr 1fr auto;gap:8px;align-items:center;border-top:1px dashed #e5e7eb;padding:6px 0">
            <input class="nm" value="${esc(s.name||'')}" placeholder="名前">
            <select class="rl"><option value="cast" ${s.role==='cast'?'selected':''}>キャスト</option><option value="boy" ${s.role==='boy'?'selected':''}>ボーイ</option></select>
            <div>
              <select class="dt"><option value="false" ${!s.duty?'selected':''}>duty:false</option><option value="true" ${s.duty?'selected':''}>duty:true</option></select>
              <select class="ac"><option value="true" ${s.active!==false?'selected':''}>active:true</option><option value="false" ${s.active===false?'selected':''}>false</option></select>
            </div>
            <div style="text-align:right">
              <button class="sv sales-pill">保存</button>
              <button class="dl sales-pill">削除</button>
            </div>
          </div>`).join('');
          [...document.querySelectorAll('#stList > div')].forEach((row,i)=>{const rec=rows[i];row.querySelector('.sv').onclick=async()=>{const name=row.querySelector('.nm').value.trim();const role=row.querySelector('.rl').value;const duty=row.querySelector('.dt').value==='true';const active=row.querySelector('.ac').value==='true';if(!name)return alert('名前は必須');const newId=name.replace(/\//g,'／');if(newId!==rec.id){await setDoc(doc(stCol,newId),{name,role,duty,active,updatedAt:serverTimestamp()},{merge:true});await deleteDoc(doc(stCol,rec.id));}else{await setDoc(doc(stCol,rec.id),{name,role,duty,active,updatedAt:serverTimestamp()},{merge:true});}};row.querySelector('.dl').onclick=async()=>{if(confirm('削除しますか？')) await deleteDoc(doc(stCol,rec.id));};});
        // products CRUD
        const pdCol=collection(db,'rooms',ROOM_ID,'products');
        $('#pdAdd').onclick=async()=>{const name=($('#pdName').value||'').trim();const price=Number($('#pdPrice').value||0);const active=$('#pdActive').value==='true';if(!name)return alert('商品名を入力');const id=name.replace(/\//g,'／');await setDoc(doc(pdCol,id),{name,price,active,updatedAt:serverTimestamp()},{merge:true});$('#pdName').value='';$('#pdPrice').value='';};
        onSnapshot(pdCol,(qs)=>{const rows=[];qs.forEach(d=>rows.push({id:d.id,...(d.data()||{})}));rows.sort((a,b)=>String(a.name||'').localeCompare(String(b.name||''),'ja'));$('#pdList').innerHTML=rows.map(p=>`
          <div style="display:grid;grid-template-columns:2fr 1fr 1fr auto;gap:8px;align-items:center;border-top:1px dashed #e5e7eb;padding:6px 0">
            <input class="nm" value="${esc(p.name||'')}" placeholder="商品名">
            <input class="pr" type="number" min="0" step="1" value="${Number(p.price||0)}">
            <select class="ac"><option value="true" ${p.active!==false?'selected':''}>active:true</option><option value="false" ${p.active===false?'selected':''}>false</option></select>
            <div style="text-align:right">
              <button class="sv sales-pill">保存</button>
              <button class="dl sales-pill">削除</button>
            </div>
          </div>`).join('');
          [...document.querySelectorAll('#pdList > div')].forEach((row,i)=>{const rec=rows[i];row.querySelector('.sv').onclick=async()=>{const name=row.querySelector('.nm').value.trim();const price=Number(row.querySelector('.pr').value||0);const active=row.querySelector('.ac').value==='true';if(!name)return alert('商品名は必須');const newId=name.replace(/\//g,'／');if(newId!==rec.id){await setDoc(doc(pdCol,newId),{name,price,active,updatedAt:serverTimestamp()},{merge:true});await deleteDoc(doc(pdCol,rec.id));}else{await setDoc(doc(pdCol,rec.id),{name,price,active,updatedAt:serverTimestamp()},{merge:true});}};row.querySelector('.dl').onclick=async()=>{if(confirm('削除しますか？')) await deleteDoc(doc(pdCol,rec.id));};});
      </script>
    </section>
  </main>

  <!-- ここに、あなたの既存の「タイマー/控室/売上」用の大きな <script> ブロック（render/tick/loadStaff 等）を入れる（※今のままでOK） -->
  <!-- ここに、売上（商品CSV・送信）の <script> も入れる（※今のままでOK） -->

  <!-- ルーターは1本だけ -->
  <script>
    function route(){
      const page=(location.hash||'#timer').replace('#','');
      const isTimer=page==='timer', isSales=page==='sales', isAdmin=page==='admin';
      const show=(id,on)=>{const el=document.getElementById(id); if(el) el.style.display=on?'block':'none';};
      const active=(id,on)=>{const el=document.getElementById(id); if(el) el.classList.toggle('active',!!on);};
      show('pageTimer',isTimer); show('pageSales',isSales); show('pageAdmin',isAdmin);
      active('navTimer',isTimer); active('navSales',isSales); active('navAdmin',isAdmin);
      window.scrollTo(0,0);
    }
    window.addEventListener('hashchange',route);
    route();
  </script>
</body>
</html>
