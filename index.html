<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>卓タイマー管理 + 控室（スプシ連携）【DEV】</title>
  <link rel="icon" href="data:," />
  <style>
    :root{
      --bg:#f4f6f8; --panel:#fff; --text:#111;
      --red:#e74c3c; --blue:#2e86de; --vip:#9b59b6;
      --ok:#e7ffe7; --warn:#fff3cd; --danger:#ffe0e0; --gold:#ffdd57;
      --staff-on-bg:#e6f4ea; --staff-on-border:#34a853; --staff-on-text:#0b6630;
      --staff-busy-bg:#fff3cd; --staff-busy-border:#f59e0b; --staff-busy-text:#7a4e00;
      --staff-off-bg:#f1f5f9; --staff-off-border:#cbd5e1; --staff-off-text:#94a3b8;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Arial,sans-serif}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px 14px;background:#1f1f23;color:#fff;position:sticky;top:0;z-index:5}
    header h1{margin:0;font-size:18px}
    .toolbar{display:flex;gap:8px;align-items:center}
    .toolbar input{padding:8px;border-radius:8px;border:1px solid #ccc;min-width:220px}
    .now{opacity:.85}

    .top-tabs{display:inline-flex;gap:.5rem;margin-left:1rem}
    .top-tabs .tab{padding:.35rem .8rem;border:1px solid #ddd;border-radius:999px;background:#fff;color:#111!important;text-decoration:none}
    .top-tabs .tab.active{box-shadow:0 1px 4px #0001;font-weight:700}

    main{padding:12px;display:block}
    .page{display:none}
    /* ← JSが落ちても白画面にしない保険 */
    #pageTimer{display:block}

    /* ====== Floor / VIP / Roster（本鯖UI） ====== */
.floor{
  position:relative;background:var(--panel);border:1px solid #ddd;border-radius:12px;
  overflow:hidden;padding:4px;min-height:750px;
}
.legend{position:absolute;left:8px;top:8px;display:flex;gap:10px;flex-wrap:wrap;font-size:12px;opacity:.9;background:#fff9;border-radius:8px;padding:6px}
.dot{width:10px;height:10px;border-radius:50%;display:inline-block;border:1px solid #999}
.dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.danger{background:var(--danger)} .dot.empty{background:#eee}

.seat{
  position:absolute;background:#fff;border:2px solid #bbb;border-radius:10px;
  padding:6px;min-height:64px;min-width:80px;cursor:pointer;
  display:flex;flex-direction:column;gap:4px;transition:transform .05s, box-shadow .1s, background .2s;
  box-shadow:0 1px 0 #0001;
}
.seat:hover{transform:translateY(-1px)}
.seat.red{border-color:var(--red)} .seat.blue{border-color:var(--blue)}
.seat.active{background:var(--ok)} .seat.warn{background:var(--warn)} .seat.danger{background:var(--danger)}
.seat.highlight{box-shadow:0 0 0 3px var(--gold) inset}
.line1{display:flex;justify-content:space-between;align-items:center;font-weight:700}
.line1 .endAt{font-weight:700;font-size:18px;opacity:.8;margin-left:10px;white-space:nowrap}
.timer{font-size:18px;font-weight:800}
.meta{font-size:18px;line-height:1.25;opacity:.95;overflow-wrap:anywhere}

/* VIP row */
.vipRow{position:absolute; left:15%; right:15%; bottom:7%; display:flex; gap:12px; z-index:2;}
.vipSeat{
  background:#fff;border:2px dashed var(--vip);border-radius:12px;
  padding:10px;min-height:100px;flex:1;cursor:pointer;display:flex;flex-direction:column;gap:6px;
}
.vipSeat.active{background:var(--ok)} .vipSeat.warn{background:var(--warn)} .vipSeat.danger{background:var(--danger)}
.vipSeat .timer{font-size:22px}

/* Backstage */
.backstage{background:var(--panel);border:1px solid #ddd;border-radius:12px;padding:10px;margin-top:12px}
.backstage h2{margin:0 0 8px;font-size:16px}
.legend-staff{font-size:12px;opacity:.8;display:flex;gap:12px;align-items:center}
.dotS{width:10px;height:10px;border-radius:50%;display:inline-block}
.dotS.on{background:#145768} .dotS.busy{background:#6b480a} .dotS.off{background:#9ca3af}
.roster{display:flex;flex-wrap:wrap;gap:8px}
.staffChip{padding:6px 10px;border-radius:999px;border:1px solid #cbd5e1;background:#f8fafc;cursor:pointer;font-size:14px}
.staffChip.on{background:var(--staff-on-bg);border:1px solid var(--staff-on-border);color:var(--staff-on-text);box-shadow:0 0 0 1px #0e3d49 inset}
.staffChip.busy{background:var(--staff-busy-bg);border:1px solid var(--staff-busy-border);color:var(--staff-busy-text);box-shadow:0 0 0 1px #3a2706 inset}
.staffChip.off{background:var(--staff-off-bg);border:1px solid var(--staff-off-border);color:var(--staff-off-text)}
.staffChip.selected{box-shadow:0 0 0 2px #111 inset;font-weight:700}
.staffSectionTitle{flex-basis:100%;margin-top:6px;font-size:12px;color:#475569}

/* Modal（本鯖UI） */
.modalWrap{position:fixed;inset:0;background:#0008;display:none;place-items:center;z-index:9}
.modal{background:#fff;border-radius:14px;padding:16px;min-width:300px;max-width:92vw;box-shadow:0 20px 60px #0006}
.modal h3{margin:0 0 10px 0}
.row{display:flex;gap:8px;margin:8px 0}
.row input{flex:1;padding:10px;border-radius:8px;border:1px solid #ccc}
.btns{display:flex;flex-wrap:wrap;gap:8px}
button{border:none;border-radius:10px;padding:10px 14px;cursor:pointer;background:#111;color:#fff}
button.secondary{background:#e5e7eb;color:#111}
button.danger{background:#dc2626}
.chips button{background:#fff;border:1px solid #111;color:#111}
.label{font-weight:700;padding:6px 10px;border-radius:999px;font-size:12px;line-height:1;align-self:center;white-space:nowrap}
.label-extend{color:var(--vip);border:1px solid var(--vip);background:#f7ecff}
.twoCols{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
.suggBlock{display:flex;flex-direction:column;gap:4px;flex:1}
.suggTitle{font-size:12px;color:#6b7280}
.suggList{display:flex;flex-wrap:wrap;gap:6px}
.suggList .staffChip{padding:4px 8px;font-size:12px}

/* 売上入力ピッカー（本鯖UI） */
.pickerField{border:1px solid #dcdfe3;background:#f9fafb;border-radius:12px;padding:8px;min-height:46px;display:flex;gap:6px;align-items:center;flex-wrap:wrap;cursor:pointer}
.pickerField.empty{color:#94a3b8}
.pill{padding:4px 10px;border-radius:999px;border:1px solid #cbd5e1;background:#fff;font-size:12px}
.pickerWrap{position:fixed;inset:0;background:#0008;display:none;place-items:center;z-index:10}
.pickerPanel{background:#fff;border-radius:14px;padding:14px;max-width:92vw;max-height:80vh;overflow:auto;box-shadow:0 20px 60px #0006}
.pickerHead{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px}
.pickerBtns{display:flex;gap:8px;flex-wrap:wrap}

/* 延長回数バッジ（本鯖UI） */
.extBadge{
  display:inline-block;margin-left:8px;padding:2px 6px;border-radius:999px;border:1px solid #6b7280;
  font-size:12px;line-height:1;opacity:.85;background:#fff;
}

/* 売上のボタン文字が薄くなる問題の固定（本鯖と同じ） */
.sales-pill{ color:#111 !important; }
.sales-row .sales-pill{ color:#111 !important; }


    /* === sales-pill を白地・黒字に統一 === */
    button.sales-pill{
      background:#fff !important;
      color:#111 !important;
      border:1px solid #cbd5e1 !important;
    }

    /* 触感ちょいUP（任意） */
    button.sales-pill:hover{
      background:#f8fafc !important;
    }


    /* 売上（席モーダル内タブ） */
.salesTabHead{ display:flex; gap:8px; margin:8px 0 4px; }
.salesTabBtn{ padding:6px 10px; border-radius:999px; border:1px solid #cbd5e1; background:#fff; color:#111; cursor:pointer; }
.salesTabBtn.active{ background:#111; color:#fff; }

.seatSales{ display:none; }
.seatSales.show{ display:block; }
    /* 売上タブ表示中は、後続の（時間/キャスト/ボーイ等の）行を隠す */
.seatSales.show ~ *{
  display:none !important;
}
    /* --- 席モーダルの売上タブを“上：検索+商品 / 中：明細(スクロール) / 下：合計+登録(固定)”の3分割に --- */
#seatSales { display: none; }
#seatSales.show { display: flex; flex-direction: column; max-height: 72vh; } /* モーダル内での高さ上限 */
#seatSalesList{ flex:1 1 auto; overflow:auto; overscroll-behavior:contain; } /* ここだけスクロール */
.salesFoot{ flex:0 0 auto; background:#fff; border-top:1px solid #e5e7eb; padding-top:8px; }

/* 明細は8行まで可視、それ以上はスクロール（JSで行高を入れるfallback） */
#seatSalesList{ max-height:calc(var(--rowH,48px)*8 + 8px); }

/* トップの「売上入力」ページも同様にスクロール化 */
#salesLines{ max-height:calc(var(--rowH,48px)*8 + 8px); overflow:auto; overscroll-behavior:contain; }

/* スクロールバー（任意・お好み） */
#seatSalesList::-webkit-scrollbar, #salesLines::-webkit-scrollbar{ width:10px; }
#seatSalesList::-webkit-scrollbar-thumb, #salesLines::-webkit-scrollbar-thumb{ background:#cbd5e1; border-radius:8px; }


.prodSearch{ padding:8px; border:1px solid #cbd5e1; border-radius:10px; width:100%; }
.prodGrid{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
.prodChip{
  padding:6px 10px; border-radius:999px; border:1px solid #cbd5e1; background:#fff; cursor:pointer;
  font-size:13px; white-space:nowrap;
}
    /* 商品チップは白地・黒字で固定 */
.prodChip{
  color:#111 !important;
  background:#fff !important;
  border:1px solid #cbd5e1 !important;
}

.salesList{ margin-top:10px; border-top:1px dashed #e5e7eb; }
.salesItem{
  display:grid; grid-template-columns: 1fr auto auto auto; gap:8px; align-items:center;
  padding:8px 0; border-bottom:1px dashed #f0f2f4;
}
.salesItem .yen{ min-width:72px; text-align:right; }
.qtyCtrl{ display:inline-flex; border:1px solid #cbd5e1; border-radius:10px; overflow:hidden; }
.qtyCtrl button{ background:#fff; color:#111; padding:6px 10px; border-radius:0; }
.qtyCtrl input{ width:48px; text-align:center; border:none; outline:none; }

.salesFoot{ display:flex; gap:8px; align-items:center; justify-content:space-between; margin-top:10px; }
.salesTotalBig{ font-size:18px; font-weight:800; }


    

/* ←既存の<style>のどこでもOK */

/* 従業員リスト（幹部） */
.admin-st-list{ display:grid; gap:12px; }
.stRow{
  display:grid;
  grid-template-columns: 2fr 1fr auto auto;
  gap:16px; align-items:center;
  padding:8px 0; border-top:1px dashed #e5e7eb;
}
.stRow input, .stRow select{
  padding:12px; border:1px solid #cbd5e1; border-radius:12px;
  background:#fff; font-size:14px; width:100%;
}
.stRow input[disabled], .stRow select[disabled]{
  background:#f8fafc; color:#475569; opacity:.9;
}
.stBtn{ white-space:nowrap; }

    /* 商品行（従業員と同じUI・列幅だけ違う） */
/* 追加：商品追加フォーム専用のレイアウト */
.pdRowAdd{
  display:grid;
  grid-template-columns: 2fr 1fr auto; /* 商品名 / 価格 / ボタン（空枠） */
  gap:16px; align-items:center;
  padding:8px 0; border-top:1px dashed #e5e7eb;
}
.pdRowAdd input{
  padding:12px; border:1px solid #cbd5e1; border-radius:12px;
  background:#fff; font-size:14px; width:100%;
}

    /* 商品一覧（名前 / 価格 / ボタン） */
.pdRowList{
  display:grid;
  grid-template-columns: 2fr 1fr auto;
  gap:16px; align-items:center;
  padding:8px 0; border-top:1px dashed #e5e7eb;
}
.pdRowList input{
  padding:12px; border:1px solid #cbd5e1; border-radius:12px;
  background:#fff; font-size:14px; width:100%;
}






    @media(max-width:900px){
      .toolbar input{min-width:160px}
      .seat{min-width:72px;min-height:60px}
      .sales-grid{grid-template-columns:1fr}
    }

    /* 控室を左右2カラムに分割 */
.rosterHead{ justify-content:space-between; }
.rosterGrid{
  display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:8px;
}
.rosterCol{ display:flex; flex-direction:column; gap:6px; }
.rosterHead{
  font-size:12px; color:#475569; font-weight:700;
  display:flex; align-items:center; gap:8px;
}
    .rosterSearch{
  padding:6px 8px; border:1px solid #cbd5e1; border-radius:8px; min-width:140px;
  background:#fff; font-size:13px;
    }
.rosterCol .staffSectionTitle{ margin-top:4px; } /* 既存を流用 */
@media(max-width:900px){
  .rosterGrid{ grid-template-columns:1fr; }
}

  </style>
</head>

  
<body>
  <!-- DEVバナー -->
  <div style="position:fixed;right:300px;top:8px;padding:6px 10px;border:1px dashed #888;font-weight:bold;z-index:9999;color:#fff;background:#222;">
    開発用（DEV） / ROOM_ID: dev
  </div>

  <header>
    <h1>卓タイマー管理</h1>
    <div class="toolbar">
      <input id="q" type="search" placeholder="キャスト名で検索（例: あや）" />
      <div class="now" id="now"></div>
    </div>
    <nav class="top-tabs"> 
      <a id="navTimer" class="tab active" href="#timer">卓タイマー管理</a> 
      
      <a id="navAdmin" class="tab" href="#admin">幹部</a> </nav>

  </header>

  <main>
    <!-- タイマー -->
<section id="pageTimer" class="page">
  <section class="floor" id="floor">
    <div class="legend">
      <span><i class="dot empty"></i>空席</span>
      <span><i class="dot ok"></i>計時中</span>
      <span><i class="dot warn"></i>残り10分未満</span>
      <span><i class="dot danger"></i>残り3分未満</span>
    </div>
    <div class="vipRow" id="vip"></div>
  </section>

    <section class="backstage">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
      <h2>控室</h2>
      <div style="display:flex;align-items:center;gap:12px">
        <div class="legend-staff">
          <span><i class="dotS on"></i> 出勤（空き）</span>
          <span><i class="dotS busy"></i> 接客中</span>
          <span><i class="dotS off"></i> 休み/退勤</span>
        </div>
        
        <button id="reloadStaff" class="secondary" type="button">更新</button>
      </div>
    </div>

    <!-- ▼ここを新しい2カラムUIに -->
<div class="rosterGrid">
  <div class="rosterCol">
    <div class="rosterHead">
      <span>キャスト</span>
      <div class="rosterCtrl">
        <label class="mini"><input type="checkbox" id="editDutyCast"> 出勤を編集</label>
        <input id="searchCast" class="rosterSearch" placeholder="検索">
      </div>
    </div>
    <div id="rosterCast" class="roster"></div>
  </div>

  <div class="rosterCol">
    <div class="rosterHead">
      <span>ボーイ・スタッフ</span>
      <div class="rosterCtrl">
        <label class="mini"><input type="checkbox" id="editDutyBoy"> 出勤を編集</label>
        <input id="searchBoy" class="rosterSearch" placeholder="検索">
      </div>
    </div>
    <div id="rosterBoy" class="roster"></div>
  </div>
</div>


  </section>
</section>



<!-- 幹部 -->
<section id="pageAdmin" class="page">

  <!-- ログインカード -->
  <div class="sales-card" style="margin-top:12px">
    <h2 style="margin:0 0 8px">ログイン</h2>
    <div id="adminLocked">
      <input id="adminCode" type="password" placeholder="幹部用パスコード" style="margin-right:6px">
      <button id="adminEnter" class="sales-pill">入室</button>
      <div style="font-size:12px;color:#64748b;margin-top:6px">* 店舗で共有する1つのパスコードだけで入室します</div>
    </div>
    <div id="adminUnlocked" style="display:none;align-items:center;gap:8px">
      <span style="font-size:12px;color:#64748b">幹部モード</span>
      <button id="adminLock" class="sales-pill">ロック</button>
    </div>

    <div id="adminWrong" style="display:none;color:#b91c1c;margin-top:6px">パスコードが違います</div>
  </div>

  <!-- ホーム（4ボタン） -->
  <div id="adminHome" class="sales-card" style="display:none">
    <h2 style="margin:0 0 8px">幹部メニュー</h2>
    <div style="display:flex;flex-wrap:wrap;gap:8px">
      <button type="button" class="sales-pill" onclick="location.hash='#admin-staff-list'">従業員管理（一覧）</button>
      <button type="button" class="sales-pill" onclick="location.hash='#admin-staff-add'">従業員管理（追加）</button>
      <button type="button" class="sales-pill" onclick="location.hash='#admin-prod-list'">商品管理（一覧）</button>
      <button type="button" class="sales-pill" onclick="location.hash='#admin-prod-add'">商品管理（追加）</button>
      <button type="button" class="sales-pill" onclick="location.hash='#admin-sales'">売上一覧</button>
    </div>
  </div>

  <!-- ===== 従業員：一覧 ===== -->
  <div id="adminStaffList" class="sales-card" style="display:none">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
      <button type="button" class="sales-pill" onclick="location.hash='#admin'">← 戻る</button>
      <h2 style="margin:0">従業員リスト</h2>
      <button type="button" class="sales-pill" style="margin-left:auto" onclick="location.hash='#admin-staff-add'">＋ 追加ページへ</button>
    </div>
    <div id="stList" style="margin-top:8px"></div>
  </div>

  <!-- ===== 従業員：追加 ===== -->
<!-- ===== 従業員：追加（複数行入力） ===== -->
<div id="adminStaffAdd" class="sales-card" style="display:none">
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
    <button type="button" class="sales-pill" onclick="location.hash='#admin-staff-list'">← 一覧へ</button>
    <h2 style="margin:0">従業員の追加</h2>
  </div>

  <!-- ここに “従業員リスト風の行” を 5 行 初期表示 -->
  <div id="stAddList" class="admin-st-list"></div>

  <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
    
    <button id="stAddClear" type="button" class="sales-pill secondary">行をクリア</button>
    <div style="margin-left:auto;font-size:12px;color:#64748b">* 最大5行まで</div>
    <button id="stAddBulk"  type="button" class="sales-pill">まとめて追加</button>
  </div>

  <div style="font-size:12px;color:#64748b;margin-top:6px">
    * 名前を入力して役職を選び、「まとめて追加」を押します（空行は無視）<br>
    * 追加時は「出勤:false / 有効:true」で登録（必要なら一覧で編集）
  </div>
</div>


  </div>

  <!-- ===== 商品：一覧 ===== -->
<div id="adminProdList" class="sales-card" style="display:none">
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
    <button type="button" class="sales-pill" onclick="location.hash='#admin'">← 戻る</button>
    <h2 style="margin:0">商品リスト</h2>
    <button type="button" class="sales-pill" style="margin-left:auto" onclick="location.hash='#admin-prod-add'">＋ 追加ページへ</button>
  </div>
  <div id="pdList" style="margin-top:8px"></div>
</div>


  <!-- ===== 商品：追加 ===== -->
<div id="adminProdAdd" class="sales-card" style="display:none">
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
    <button type="button" class="sales-pill" onclick="location.hash='#admin-prod-list'">← 一覧へ</button>
    <h2 style="margin:0">商品の追加</h2>
  </div>

  <!-- 従業員追加と同じ “行ベース” UI（5行） -->
  <div id="pdAddList" class="admin-st-list"></div>

  <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
    <button id="pdAddClear" type="button" class="sales-pill secondary">行をクリア</button>
    <div style="margin-left:auto;font-size:12px;color:#64748b">* 最大5行まで</div>
    <button id="pdAddBulk"  type="button" class="sales-pill">まとめて追加</button>
  </div>

  <div style="font-size:12px;color:#64748b;margin-top:6px">
    * 商品名と価格を入力し、「まとめて追加」を押します（空行は無視）<br>
    * 追加時は「有効:true」で登録（必要なら一覧で編集）
  </div>
</div>


  
  <div id="adminSales" class="sales-card" style="display:none">
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
    <button type="button" class="sales-pill" onclick="location.hash='#admin'">← 戻る</button>
    <h2 style="margin:0">売上一覧</h2>
  </div>



  <div id="salesListBox" style="font-size:14px"></div>
</div>



</section>


<!-- 幹部ロジック（Firestore は既存のまま） -->
<script type="module">
  import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import {
   getFirestore, collection, doc, setDoc, serverTimestamp,
   onSnapshot, deleteDoc
   } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  // ---- Firebase init（重複なし）----
  const app = getApps().length ? getApps()[0] : initializeApp({
    apiKey:"AIzaSyBru7m0EGNXBgRTzsmQMZknlAAirkTwwpw",
    authDomain:"alexandria-8d142.firebaseapp.com",
    projectId:"alexandria-8d142",
    storageBucket:"alexandria-8d142.firebasestorage.app",
    messagingSenderId:"78904719003",
    appId:"1:78904719003:web:234e7d8b0703bad614f83e",
    measurementId:"G-6TJNLEHJXQ"
  });

  const db   = getFirestore(app);
  const auth = getAuth(app);

  // ---- 匿名サインイン：1回だけ ----
  // window.__authReady を一度だけ作る
  if (!window.__authReady) {
    window.__authReady = new Promise((resolve, reject) => {
      onAuthStateChanged(auth, (user) => { if (user) resolve(user); }, reject);
    });
    try {
      await signInAnonymously(auth);
      console.log('[auth] anonymous signed in');
    } catch (e) {
      console.error('[auth] signInAnonymously failed', e);
    }
  }

  // ---- 共通定義（この module でも使うなら保持）----
  const ROOM_ID = "dev";
  const seatsCol = collection(db, 'rooms', ROOM_ID, 'seats');
  const dutyCol  = collection(db, 'rooms', ROOM_ID, 'duty');

  // 席書き込み（この module 内で使うなら残す／別moduleで使うなら window へ出す）
  

  // 他の module から必要なら公開しておく（任意）
  window.firebaseApp = app;
  window.db = db;
  window.ROOM_ID = ROOM_ID;
  window.pushSeatToFS = pushSeatToFS;



  // ==== Firestore ====




  // ↓↓↓ ここから先はあなたの既存コード（ROOM_ID/パスコード、applyState/showAdminSub、
  //      staff/products の CRUD/onSnapshot、イベントハンドラなど）を
  //      そのまま続けて置いてください。db は上で定義済みです。

  const ADMIN_PASS_PLAIN = "test";
  const LS_PREFIX = window.LS_PREFIX || "tt-dev-";
  const $ = s => document.querySelector(s);
  const esc = s => String(s).replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));
  async function sha256Hex(text){const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(text));return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');}

  const KEY = LS_PREFIX + "admin.unlocked";

  // ===== 幹部UI：ログイン/表示コントロール（唯一の定義） =====

  function showAdminSub(hash) {
    const h = hash || '#admin';
    // いったん全部隠す
    ['adminHome','adminStaffList','adminStaffAdd','adminProdList','adminProdAdd','adminSales'].forEach(id=>{
      const el = document.getElementById(id);
      if (el) el.style.display = 'none';
    });
    // どれを出すか
    let target = 'adminHome';
    if (h.startsWith('#admin-staff-list')) target = 'adminStaffList';
    else if (h.startsWith('#admin-staff-add')) target = 'adminStaffAdd';
    else if (h.startsWith('#admin-prod-list')) target = 'adminProdList';
    else if (h.startsWith('#admin-prod-add')) target = 'adminProdAdd';
    else if (h.startsWith('#admin-sales')) target = 'adminSales';


    const el = document.getElementById(target);
    if (el) el.style.display = 'block';
  }

  function applyState(open){
    const $locked   = document.getElementById('adminLocked');
    const $unlocked = document.getElementById('adminUnlocked');
    const $wrong    = document.getElementById('adminWrong');

    if ($locked)   $locked.style.display   = open ? 'none'  : 'block';
    if ($unlocked) $unlocked.style.display = open ? 'flex'  : 'none';
    if ($wrong)    $wrong.style.display    = 'none';

    if (open) {
      showAdminSub(location.hash);
    } else {
      ['adminHome','adminStaffList','adminStaffAdd','adminProdList','adminProdAdd','adminSales'].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
      });
    }
  }

// Firestoreへ席状態を書き込む（1卓分）
async function pushSeatToFS(s){
  try{
    await setDoc(
      doc(seatsCol, s.id),
      {
        id: s.id,
        group: s.group,
        label: s.label || '',
        cast: s.cast || '',
        boy:  s.boy  || '',
        end:  s.end ?? null,
        finished: !!s.finished,
        extendCount: Number(s.extendCount||0),
        updatedAt: serverTimestamp(),
      },
      { merge: true }
    );
  }catch(e){
    console.error('[seats] write failed', e);
  }
}




  // 初期反映（セッションの継続対応）
  applyState(sessionStorage.getItem(KEY) === '1');

  // 入室
  document.getElementById('adminEnter')?.addEventListener('click', async ()=>{
    const inputEl = document.getElementById('adminCode');
    const input   = (inputEl?.value || '').trim();
    if (!input) return;

    const ok = (await sha256Hex(input)) === (await sha256Hex(ADMIN_PASS_PLAIN));
    if (ok) {
      sessionStorage.setItem(KEY, '1');
      if (!location.hash.startsWith('#admin')) location.hash = '#admin';
      applyState(true);
      if (inputEl) inputEl.value = '';
    } else {
      const $wrong = document.getElementById('adminWrong');
      if ($wrong) $wrong.style.display = 'block';
    }
  });

  // ロック（ログアウト）
  document.getElementById('adminLock')?.addEventListener('click', ()=>{
    sessionStorage.removeItem(KEY);
    applyState(false);
  });

  // ハッシュ変化でサブページ切替（ログイン時のみ）
  window.addEventListener('hashchange', ()=>{
    if (sessionStorage.getItem(KEY) === '1' && location.hash.startsWith('#admin')) {
      showAdminSub(location.hash);
    }
  });

  // URL直打ちで #admin-* のとき
  if (sessionStorage.getItem(KEY) === '1' && location.hash.startsWith('#admin')) {
    showAdminSub(location.hash);
  }

  /* ====== staff CRUD（一覧に描画） ====== */
  const stCol = collection(db,'rooms',ROOM_ID,'staff');

  const renderStaffRows = (rows)=>{
    const root = document.getElementById('stList');
    if(!root) return;

    root.classList.add('admin-st-list'); // スタイル適用
    root.innerHTML = rows.map(s=>`
      <div class="stRow" data-id="${esc(s.id)}">
        <input class="nm" value="${esc(s.name||'')}" placeholder="名前　例: あやか" disabled>
        <select class="rl" disabled>
          <option value="cast"  ${s.role==='cast' ?'selected':''}>キャスト</option>
            <option value="boy"   ${s.role==='boy'  ?'selected':''}>ボーイ</option>
            <option value="staff" ${s.role==='staff'?'selected':''}>スタッフ</option>
            <option value="fired" ${s.role==='fired'?'selected':''}>解雇</option>
          </select>
        <button class="edit stBtn sales-pill" type="button">編集</button>
        <button class="dl   stBtn sales-pill" type="button">削除</button>
      </div>
    `).join('');

    // 行ごとのイベント
    [...root.querySelectorAll('.stRow')].forEach((row,i)=>{
      const rec = rows[i];
      const $nm = row.querySelector('.nm');
      const $rl = row.querySelector('.rl');
      const $edit = row.querySelector('.edit');
      const $del  = row.querySelector('.dl');

      // 編集トグル：閲覧→編集→保存
      $edit.addEventListener('click', async ()=>{
        const isView = $nm.disabled;
        if (isView){
          // 編集モードへ
          $nm.disabled = false;
          $rl.disabled = false;
          $nm.focus();
          $edit.textContent = '保存';
          row.dataset.editing = '1';
        }else{
          // 保存して閲覧モードへ
          const name  = ($nm.value||'').trim();
          const role  = $rl.value || 'cast';
          // 役職が解雇なら duty は落とす
          const duty  = (role==='fired') ? false : !!rec.duty;
          const active= rec.active!==false;   // 既存値を温存

          if(!name){ alert('名前は必須です'); $nm.focus(); return; }

          const newId = name.replace(/\//g,'／');

          try{
            if(newId !== rec.id){
              // ドキュメント名変更（コピー→元削除）
              await setDoc(doc(stCol,newId), {name,role,duty,active,updatedAt:serverTimestamp()},{merge:true});
              await deleteDoc(doc(stCol,rec.id));
            }else{
              await setDoc(doc(stCol,rec.id), {name,role,updatedAt:serverTimestamp()},{merge:true});
            }
            // ローカルUIを閲覧状態に戻す
            $nm.disabled = true;
            $rl.disabled = true;
            $edit.textContent = '編集';
            row.dataset.editing = '';
          }catch(e){
            console.error(e);
            alert('保存に失敗しました: ' + (e?.message || e));
          }
       

        }
      });

      // 削除
      $del.addEventListener('click', async ()=>{
        if(confirm('削除しますか？')) await deleteDoc(doc(stCol, rec.id));
      });
    });
  };

  // ===== staff: 追加（従業員追加ページの［追加］ボタン）===== ＊外に1回だけ定義
  // ===== 追加ページ（複数行）UI =====
const stAddList   = document.getElementById('stAddList');
const btnAddRow   = document.getElementById('stAddRow');
const btnAddClear = document.getElementById('stAddClear');
const btnAddBulk  = document.getElementById('stAddBulk');

const MAX_ADD_ROWS = 5;

function makeAddRow(init){
  const row = document.createElement('div');
  row.className = 'stRow';
  row.innerHTML = `
    <input class="nm" placeholder="名前　例: あやか">
    <select class="rl">
      <option value="cast"  ${init?.role==='cast' ?'selected':''}>キャスト</option>
      <option value="boy"   ${init?.role==='boy'  ?'selected':''}>ボーイ</option>
      <option value="staff" ${init?.role==='staff'?'selected':''}>スタッフ</option>
      <option value="fired" ${init?.role==='fired'?'selected':''}>解雇</option>
    </select>
    <div></div>
    <div></div>
  `;
  if (init?.name) row.querySelector('.nm').value = init.name;
  return row;
}


function ensureRows(){
  const cur = stAddList.querySelectorAll('.stRow').length;
  if (cur === 0) stAddList.appendChild(makeAddRow());
  if (btnAddRow) {
     btnAddRow.disabled = stAddList.querySelectorAll('.stRow').length >= MAX_ADD_ROWS;
   }
}

function seedAddRows(){
  stAddList.innerHTML = '';
  for(let i=0;i<MAX_ADD_ROWS;i++){
    stAddList.appendChild(makeAddRow());
  }
  ensureRows();
}

btnAddRow?.addEventListener('click', ()=>{
  if (stAddList.querySelectorAll('.stRow').length >= MAX_ADD_ROWS) return;
  stAddList.appendChild(makeAddRow());
  ensureRows();
});

btnAddClear?.addEventListener('click', seedAddRows);

btnAddBulk?.addEventListener('click', async ()=>{
  const rows = [...stAddList.querySelectorAll('.stRow')].map(r=>{
    const name = (r.querySelector('.nm').value||'').trim();
    const role = (r.querySelector('.rl').value)||'cast';
    return { name, role };
  }).filter(r=>r.name);

  if (!rows.length){
    alert('入力が空です');
    stAddList.querySelector('.nm')?.focus();
    return;
  }

  const seen = new Set();
  const uniqueRows = rows.filter(r=>{
    if (seen.has(r.name)) return false;
    seen.add(r.name);
    return true;
  });

  btnAddBulk.disabled = true;
  btnAddBulk.textContent = '追加中…';

  try{
    await Promise.all(uniqueRows.map(async ({name, role})=>{
      const id = name.replace(/\//g, '／');
      await setDoc(doc(stCol, id), {
        name, role, duty: false, active: true, updatedAt: serverTimestamp()
      }, { merge: true });
    }));

    alert(`${uniqueRows.length}名を追加しました`);
    seedAddRows();
    location.hash = '#admin-staff-list';
  }catch(e){
    console.error('bulk add failed:', e);
    alert('追加に失敗しました: ' + (e?.message || e));
  }finally{
    btnAddBulk.disabled = false;
    btnAddBulk.textContent = 'まとめて追加';
  }
});

// 初期5行を用意（ページ読み込み時に1回でOK）
seedAddRows();


  // staff リアルタイム購読（1つだけ）
onSnapshot(stCol, (qs)=>{
  const rows = [];
  qs.forEach(docSnap=>{
    rows.push({ id: docSnap.id, ...(docSnap.data() || {}) });
  });
  // 役職順: cast/boy/staff(=0) → fired(=1) の優先度で、同順位は名前昇順
  const prio = (r)=> r.role==='fired' ? 1 : 0;
  rows.sort((a,b)=>{
    const pa = prio(a), pb = prio(b);
    if (pa!==pb) return pa-pb;
    return String(a.name||'').localeCompare(String(b.name||''), 'ja');
  });
  renderStaffRows(rows);   // ← これで一覧に描画される
});



  /* ====== products CRUD（一覧に描画） ====== */
/* ===== products CRUD（従業員と同じUI） ===== */
const pdCol = collection(db,'rooms',ROOM_ID,'products');

/** 一覧レンダリング（“有効”を廃止して名前・価格のみ） */
const renderProdRows = (rows)=>{
  const root = document.getElementById('pdList');
  if(!root) return;

  root.innerHTML = rows.map(p=>`
    <div class="pdRowList" data-id="${esc(p.id)}">
      <input class="nm" value="${esc(p.name||'')}" placeholder="商品名" disabled>
      <input class="pr" type="number" min="0" step="1" value="${Number(p.price||0)}" disabled>
      <div style="text-align:right">
        <button class="edit stBtn sales-pill" type="button">編集</button>
        <button class="dl   stBtn sales-pill" type="button">削除</button>
      </div>
    </div>
  `).join('');

  [...root.querySelectorAll('.pdRowList')].forEach((row,i)=>{
    const rec = rows[i];
    const $nm = row.querySelector('.nm');
    const $pr = row.querySelector('.pr');
    const $edit = row.querySelector('.edit');
    const $del  = row.querySelector('.dl');

    // 編集→保存トグル
    $edit.addEventListener('click', async ()=>{
      const isView = $nm.disabled;
      if (isView){
        $nm.disabled=false; $pr.disabled=false;
        $nm.focus(); $edit.textContent='保存'; row.dataset.editing='1';
      }else{
        const name = ($nm.value||'').trim();
        const price= Number($pr.value||0);
        if(!name){ alert('商品名は必須です'); $nm.focus(); return; }

        // “active”は表示しないので既存値を温存
        const active = rec.active !== false;

        const newId = name.replace(/\//g,'／');
        try{
          if(newId !== rec.id){
            await setDoc(doc(pdCol,newId), {name,price,active,updatedAt:serverTimestamp()},{merge:true});
            await deleteDoc(doc(pdCol,rec.id));
          }else{
            await setDoc(doc(pdCol,rec.id), {name,price,updatedAt:serverTimestamp()},{merge:true});
          }
          $nm.disabled=true; $pr.disabled=true;
          $edit.textContent='編集'; row.dataset.editing='';
        }catch(e){
          console.error(e); alert('保存に失敗しました: ' + (e?.message || e));
        }
      }
    });

    // 削除
    $del.addEventListener('click', async ()=>{
      if(confirm('削除しますか？')) await deleteDoc(doc(pdCol, rec.id));
    });
  });
};


// リアルタイム購読
onSnapshot(pdCol,(qs)=>{
  const rows=[]; qs.forEach(d=>rows.push({id:d.id,...(d.data()||{})}));
  rows.sort((a,b)=>String(a.name||'').localeCompare(String(b.name||''),'ja'));
  renderProdRows(rows);
});


/** ===== 追加ページ（複数行） ===== */
const pdAddList   = document.getElementById('pdAddList');
const btnPdAddClear = document.getElementById('pdAddClear');
const btnPdAddBulk  = document.getElementById('pdAddBulk');

const MAX_PD_ADD_ROWS = 5;

function makePdAddRow(init){
  const row = document.createElement('div');
  row.className = 'pdRowAdd';
  row.innerHTML = `
    <input class="nm" placeholder="商品名">
    <input class="pr" type="number" min="0" step="1" placeholder="価格（円）">
    <div></div>
  `;
  if (init?.name)  row.querySelector('.nm').value = init.name;
  if (init?.price) row.querySelector('.pr').value = Number(init.price||0);
  return row;
}


function seedPdAddRows(){
  pdAddList.innerHTML = '';
  for(let i=0;i<MAX_PD_ADD_ROWS;i++) pdAddList.appendChild(makePdAddRow());
}

btnPdAddClear?.addEventListener('click', seedPdAddRows);
seedPdAddRows();

btnPdAddBulk?.addEventListener('click', async ()=>{
  const rows = [...pdAddList.querySelectorAll('.pdRowAdd')].map(r=>{
    const name  = (r.querySelector('.nm').value||'').trim();
    const price = Number(r.querySelector('.pr').value||0);
    return { name, price };
  }).filter(r=>r.name);

  if (!rows.length){
    alert('入力が空です'); pdAddList.querySelector('.nm')?.focus(); return;
  }

  const seen = new Set();
  const uniqueRows = rows.filter(r=>{ if(seen.has(r.name)) return false; seen.add(r.name); return true; });

  btnPdAddBulk.disabled = true; btnPdAddBulk.textContent = '追加中…';
  try{
    await Promise.all(uniqueRows.map(async ({name, price})=>{
      const id = name.replace(/\//g, '／');
      await setDoc(doc(pdCol, id), {
        name, price, active: true, updatedAt: serverTimestamp()
      }, { merge: true });
    }));
    alert(`${uniqueRows.length}件を追加しました`);
    seedPdAddRows();
    location.hash = '#admin-prod-list';
  }catch(e){
    console.error('product bulk add failed:', e);
    alert('追加に失敗しました: ' + (e?.message || e));
  }finally{
    btnPdAddBulk.disabled = false; btnPdAddBulk.textContent = 'まとめて追加';
  }
});

  // ===== 売上一覧（幹部） =====
const salesCol = collection(db,'rooms',ROOM_ID,'sales');

  // --- 幹部側でも商品リストを使えるように購読 ---
const pdColAdmin = collection(db,'rooms',ROOM_ID,'products');
const yen = n => new Intl.NumberFormat('ja-JP',{style:'currency',currency:'JPY'}).format(Number(n||0));
let PRODUCTS_MASTER = [];
onSnapshot(pdColAdmin,(qs)=>{
  const rows=[]; qs.forEach(d=>rows.push({id:d.id,...(d.data()||{})}));
  PRODUCTS_MASTER = rows
    .filter(p=>p.active!==false)
    .map(p=>({name:p.name, price:Number(p.price||0)}))
    .sort((a,b)=> String(a.name).localeCompare(String(b.name),'ja'));
});


// ===== 「2:00〜翌2:00」を1日として日別セクションにまとめて表示 =====

  // --- 追加：ハッシュから日付キーを取得（#admin-sales/2025-10-30 など） ---
function getSalesDayFromHash(){
  const m = location.hash.match(/^#admin-sales\/(\d{4}-\d{2}-\d{2})$/);
  return m ? m[1] : null;
}
// 最新の売上スナップショットを保持
let SALES_ROWS_CACHE = [];

// Firestore Timestamp -> JS Date 変換の安全関数
function tsToDate(ts){
  if (!ts) return null;
  if (typeof ts.toDate === 'function') return ts.toDate();
  if (typeof ts.seconds === 'number') return new Date(ts.seconds * 1000);
  if (ts instanceof Date) return ts;
  return null;
}

// 2:00を境に営業日キー（YYYY-MM-DD）を返す
function bizDayKeyFromDate(d){
  const x = new Date(d.getTime());
  if (x.getHours() < 2) {
    // 2時前は前日の営業日扱い
    x.setDate(x.getDate() - 1);
  }
  const y = x.getFullYear();
  const m = String(x.getMonth()+1).padStart(2,'0');
  const day = String(x.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}

// 見出し用のラベル（YYYY/MM/DD + 範囲注記）
function bizDayLabel(key){
  if (key === 'unknown') return '未分類（日時なし）';
  const [y,m,d] = key.split('-');
  return `${y}/${m}/${d}（2:00〜翌2:00）`;
}



// 個別行のHTML
function salesRowHTML(r){
  const when = r.createdAt
      ? (r.createdAt.toDate?.() || new Date(r.createdAt.seconds*1000))
          .toLocaleString('ja-JP',{hour12:false})
      : '';
  const lines = (r.rows||[])
    .map(it => `${esc(it.product)} × ${Number(it.qty||0)} （${Number(it.unitPrice||0).toLocaleString()}円）`)
    .join('、 ');
  return `
    <div class="salesRow" data-id="${esc(r.id)}"
         style="padding:8px 0; border-top:1px dashed #e5e7eb; display:grid; grid-template-columns:auto 1fr auto; gap:8px; align-items:start;">
      <div style="padding-top:3px"><input type="checkbox" class="sel"></div>
      <div>
        <div><b>${esc(r.seatLabel||r.seatId||'')}</b>｜合計 <b>¥${Number(r.total||0).toLocaleString()}</b>｜${when}</div>
        <div style="color:#475569">キャスト：${esc((r.cast||[]).join(', ')||'なし')}　/　ボーイ：${esc(r.boy||'')}</div>
        <div style="color:#111">${lines}</div>
      </div>
      <div style="display:flex; gap:8px">
        <button type="button" class="sales-pill edit">編集</button>
        <button type="button" class="sales-pill danger dl">削除</button>
      </div>
    </div>
  `;
}

// 日別にまとめて描画
function renderSalesGroupedByBizDay(rows, filterDay /* 'YYYY-MM-DD' or null */){
  const root = document.getElementById('salesListBox');
  if(!root) return;

  // グルーピング
  const groups = {};
  for (const r of rows){
    const d = tsToDate(r.createdAt);
    const key = d ? bizDayKeyFromDate(d) : 'unknown';
    (groups[key] ||= []).push(r);
  }

  // 表示するキー（filterDayがあればその日のみ）
  let keys = Object.keys(groups).sort().reverse();
  if (filterDay) keys = keys.filter(k => k === filterDay);

  // 0件なら空表示
  if(!keys.length){
    root.innerHTML = '<div style="color:#64748b">（データがありません）</div>';
    return;
  }

  // 見出しリンク：日別ページへ遷移できるように
  const daySectionHTML = (key) => {
    const listHTML = groups[key].map(salesRowHTML).join('');
    const dayHref = `#admin-sales/${key}`; // ← 日別ページ
    return `
      <section class="salesDay" data-day="${key}"
        style="margin:10px 0 16px; padding:10px; border:1px solid #e5e7eb; border-radius:12px; background:#fff;">
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px">
          <h3 style="margin:0; font-size:14px">
            <a href="${dayHref}" style="text-decoration:none; color:inherit">${bizDayLabel(key)}</a>
          </h3>
          ${
            filterDay
              ? `<span style="font-size:12px; color:#64748b; margin-left:6px">（この日のページ）</span>`
              : ''
          }
        </div>

        <!-- この日の一括削除バー：文言を「この日の選択を削除」に -->
        <div class="salesBulkDay" style="display:flex; gap:8px; align-items:center; margin:4px 0 8px;">
          <button class="sales-pill danger dayBulkDelete" type="button" disabled>この日の選択を削除</button>
          <span class="dayBulkCount" style="font-size:12px; color:#64748b">0件選択中</span>
          ${
            filterDay
              ? `<button class="sales-pill" type="button" onclick="location.hash='#admin-sales'">← 日一覧へ</button>`
              : ''
          }
        </div>

        <div class="dayList">
          ${listHTML}
        </div>
      </section>
    `;
  };

  root.innerHTML = keys.map(daySectionHTML).join('');

  // 行動作（各セクションごと）
  const salesCol = collection(db,'rooms',ROOM_ID,'sales');
  root.querySelectorAll('.salesDay').forEach(section=>{
    const bulkBtn   = section.querySelector('.dayBulkDelete');
    const bulkCount = section.querySelector('.dayBulkCount');

    // 選択数更新
    const updateBulk = ()=>{
      const n = section.querySelectorAll('.sel:checked').length;
      bulkBtn.disabled = n===0;
      bulkCount.textContent = `${n}件選択中`;
    };
    section.querySelectorAll('.sel').forEach(chk => chk.addEventListener('change', updateBulk));
    updateBulk();

    // 単体削除
    section.querySelectorAll('.dl').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const row = btn.closest('.salesRow');
        const id  = row?.dataset.id;
        if(!id) return;
        if(!confirm('この売上を削除しますか？')) return;
        try{ await deleteDoc(doc(salesCol, id)); }catch(e){ alert('削除に失敗しました: ' + (e?.message||e)); }
      });
    });

    // この日の“選択分だけ”一括削除
    bulkBtn?.addEventListener('click', async ()=>{
      const ids = [...section.querySelectorAll('.sel:checked')]
        .map(chk => chk.closest('.salesRow')?.dataset.id)
        .filter(Boolean);
      if(!ids.length) return;
      if(!confirm(`${ids.length}件を削除します。よろしいですか？`)) return;

      bulkBtn.disabled = true;
      const oldTxt = bulkBtn.textContent;
      bulkBtn.textContent = '削除中…';
      try{ await Promise.all(ids.map(id => deleteDoc(doc(salesCol, id)))); }
      catch(e){ alert('一括削除に失敗しました: ' + (e?.message||e)); }
      finally{ bulkBtn.textContent = oldTxt; }
    });
  });
}



// 新しい順で表示
onSnapshot(salesCol, (qs)=>{
  const rows=[];
  qs.forEach(d=>{
    const data = d.data() || {};
    rows.push({
      id: d.id,
      ...data,
      createdAt: data.createdAt || null
    });
  });
  rows.sort((a,b)=>{
    const ta = a.createdAt?.seconds || 0;
    const tb = b.createdAt?.seconds || 0;
    return tb - ta;
  });

  SALES_ROWS_CACHE = rows; // キャッシュ
  renderSalesGroupedByBizDay(SALES_ROWS_CACHE, getSalesDayFromHash());
});

  // ===== 売上レコード 編集モーダル =====
function openSalesEditModal(rec){
  // 既存があれば消す
  document.getElementById('salesEditWrap')?.remove();

  // 編集用のローカル状態
  let items = (rec.rows||[]).map(it=>({
    product: String(it.product||''),
    unitPrice: Number(it.unitPrice||0),
    qty: Number(it.qty||0)
  })).filter(it=>it.product);

  // 合計
  const calcTotal = () => items.reduce((a,b)=> a + Number(b.unitPrice||0)*Number(b.qty||0), 0);

  // 1商品追加（同一商品＆単価は数量+1）
  function addItem(pName, price){
    const found = items.find(x=>x.product===pName && Number(x.unitPrice)===Number(price));
    if(found){ found.qty = Number(found.qty||0)+1; }
    else{ items.push({ product:pName, unitPrice:Number(price||0), qty:1 }); }
    renderList();
  }

  // 数量変更/削除
  function setQty(idx, qty){
    if (qty<=0){ items.splice(idx,1); }
    else { items[idx].qty = qty; }
    renderList();
  }

  // モーダル本体
  const wrap = document.createElement('div');
  wrap.id = 'salesEditWrap';
  wrap.className = 'modalWrap';
  wrap.style.display = 'grid';
  wrap.innerHTML = `
    <div class="modal" role="dialog" aria-modal="true" style="max-width:920px;">
      <h3 style="margin:0 0 10px">売上を編集</h3>

      <div class="row">
        <input id="se-seat"  placeholder="席ラベル" value="${esc(rec.seatLabel||rec.seatId||'')}">
        <input id="se-boy"   placeholder="ボーイ"    value="${esc(rec.boy||'')}">
      </div>
      <div class="row">
        <input id="se-cast"  placeholder="キャスト（カンマ区切り）" value="${esc((rec.cast||[]).join(', '))}">
      </div>

      <!-- 席の売上UIと同じ3分割：検索＋商品 / 明細スクロール / 合計＋保存 -->
      <div class="row">
        <input id="seSearch" class="prodSearch" placeholder="商品を検索（例: 指名, ボトル, 同伴）">
      </div>
      <div id="seProdGrid" class="prodGrid" style="margin-bottom:4px"></div>

      <div class="salesList" id="seList" style="max-height:calc(var(--rowH,48px)*8 + 8px); overflow:auto; overscroll-behavior:contain;"></div>

      <div class="salesFoot">
        <div class="salesTotalBig">合計：<span id="seTotal">${yen(calcTotal())}</span></div>
        <div class="btns">
          <button id="se-save"   class="sales-pill" type="button">保存</button>
          <button id="se-cancel" class="sales-pill secondary" type="button">キャンセル</button>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(wrap);

  const close = ()=>wrap.remove();
  wrap.addEventListener('click', e=>{ if(e.target===wrap) close(); });
  wrap.querySelector('#se-cancel').addEventListener('click', close);

  const seSearch   = wrap.querySelector('#seSearch');
  const seProdGrid = wrap.querySelector('#seProdGrid');
  const seList     = wrap.querySelector('#seList');
  const seTotal    = wrap.querySelector('#seTotal');

  // 商品チップ描画
  function buildProdGrid(q=''){
    const list = (PRODUCTS_MASTER||[]).filter(p => !q || p.name.includes(q));
    seProdGrid.innerHTML = list.map(p => `
      <button type="button" class="prodChip" data-name="${esc(p.name)}" data-price="${p.price}">
        ${esc(p.name)}（${yen(p.price)}）
      </button>
    `).join('');
    seProdGrid.querySelectorAll('.prodChip').forEach(btn=>{
      btn.addEventListener('click',()=>{
        addItem(btn.dataset.name, Number(btn.dataset.price));
      });
    });
  }
  buildProdGrid();
  seSearch?.addEventListener('input', e => buildProdGrid((e.target.value||'').trim()));

  // 明細描画
  function renderList(){
    seList.innerHTML = items.map((it,i)=>`
      <div class="salesItem" data-idx="${i}">
        <div>${esc(it.product)}</div>
        <div class="yen">${yen(it.unitPrice)}</div>
        <div class="qtyCtrl">
          <button type="button" class="qminus">－</button>
          <input type="number" min="0" step="1" value="${Number(it.qty||0)}">
          <button type="button" class="qplus">＋</button>
        </div>
        <div class="yen">${yen(Number(it.unitPrice||0) * Number(it.qty||0))}</div>
      </div>
    `).join('');

    // 行高を測って8行スクロールの高さを安定化
    const firstRow = seList.querySelector('.salesItem');
    if (firstRow){
      const h = Math.ceil(firstRow.getBoundingClientRect().height);
      seList.style.setProperty('--rowH', h + 'px');
    }

    seList.querySelectorAll('.salesItem').forEach(row=>{
      const idx = Number(row.dataset.idx||0);
      const input = row.querySelector('input');
      row.querySelector('.qminus').addEventListener('click',()=>{
        const v = Math.max(0, Number(input.value||0)-1);
        input.value = v; setQty(idx, v);
      });
      row.querySelector('.qplus').addEventListener('click',()=>{
        const v = Number(input.value||0)+1;
        input.value = v; setQty(idx, v);
      });
      input.addEventListener('input',()=>{
        const v = Math.max(0, Number(input.value||0));
        setQty(idx, v);
      });
    });

    seTotal.textContent = yen(calcTotal());
  }
  renderList();

  // 保存（Firestore へ書き戻し）
  wrap.querySelector('#se-save').addEventListener('click', async ()=>{
    const seatLabel = (wrap.querySelector('#se-seat').value||'').trim();
    const boy  = (wrap.querySelector('#se-boy').value||'').trim();
    const cast = (wrap.querySelector('#se-cast').value||'')
                  .split(',')
                  .map(v=>v.trim())
                  .filter(Boolean);

    const cleanRows = items
      .filter(it => it.product && Number(it.qty)>0)
      .map(it => ({
        product: it.product,
        unitPrice: Number(it.unitPrice||0),
        qty: Number(it.qty||0)
      }));

    const total = cleanRows.reduce((a,b)=> a + Number(b.unitPrice||0)*Number(b.qty||0), 0);

    try{
      await setDoc(
        doc(salesCol, rec.id),
        {
          seatLabel, boy, cast,
          rows: cleanRows,
          total: total,
          updatedAt: serverTimestamp()
        },
        { merge: true }
      );
      close();
    }catch(e){
      alert('保存に失敗しました: ' + (e?.message || e));
    }
  });
}





</script>


  </main>

  <!-- 卓編集モーダル -->




<div class="modalWrap" id="modalWrap" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <h3 id="modalTitle">卓を編集</h3>

        <div class="salesTabHead">
      <button id="tabTimer" class="salesTabBtn active" type="button">タイマー</button>
      <button id="tabSales" class="salesTabBtn" type="button">売上</button>
    </div>

    <div id="seatSales" class="seatSales" aria-hidden="true">
      <div class="row">
        <input id="prodSearch" class="prodSearch" placeholder="商品を検索（例: 指名, ボトル, 同伴）">
      </div>
      <div id="prodGrid" class="prodGrid"></div>
      <div class="salesList" id="seatSalesList"></div>
      <div class="salesFoot">
        <div class="salesTotalBig">合計：<span id="seatSalesTotal">¥0</span></div>
        <div class="btns">
          <button id="seatSalesSend" class="sales-pill" type="button">登録</button>
          <button id="seatSalesBack" class="sales-pill secondary" type="button">← タイマーに戻る</button>
        </div>
      </div>
    </div>

    <div class="row">
      <input id="cast" placeholder="キャスト（カンマ区切り）" list="castList" />
      <input id="boy"  placeholder="担当ボーイ"            list="boyList" />
      <datalist id="castList"></datalist>
      <datalist id="boyList"></datalist>
    </div>

    <div class="row chips">
      <span class="label" style="color:#374151;border:1px solid #d1d5db;background:#f9fafb;">時間</span>
      <div class="btns">
        <button class="quick" data-min="15" type="button">15分</button>
        <button class="quick" data-min="30" type="button">30分</button>
        <button class="quick" data-min="45" type="button">45分</button>
        <button class="quick" data-min="60" type="button">60分</button>
      </div>
    </div>

    <div class="row chips">
      <span class="label label-extend">延長</span>
      <div class="btns">
        <button class="extend" data-min="5"  type="button">+5</button>
        <button class="extend" data-min="10" type="button">+10</button>
        <button class="extend" data-min="15" type="button">+15</button>
      </div>
    </div>

    <div class="row" style="gap:12px">
      <div class="suggBlock">
        <div class="suggTitle">出勤キャスト（タップで追加）</div>
        <div id="suggCast" class="suggList"></div>
      </div>
      <div class="suggBlock">
        <div class="suggTitle">出勤ボーイ（タップで設定）</div>
        <div id="suggBoy" class="suggList"></div>
      </div>
    </div>

    <div class="row twoCols">
      <input id="manual" inputmode="numeric" placeholder="分を入力 → 開始" />
      <button id="start" type="button">開始</button>
    </div>

    <div class="row btns" style="justify-content:space-between">
      <button id="saveMeta" class="secondary" type="button">キャスト/ボーイを保存</button>
      <div>
        <button id="seatClear" class="danger" type="button">クリア（空席）</button>
        <button id="close" class="secondary" type="button">閉じる</button>
      </div>
    </div>
  </div>
</div>

<!-- ボーイ/キャスト ピッカーモーダル -->
<div class="pickerWrap" id="pickerWrap" aria-hidden="true">
  <div class="pickerPanel" role="dialog" aria-modal="true">
    <div class="pickerHead">
      <h3 id="pickerTitle" style="margin:0;font-size:16px">選択</h3>
      <div class="pickerBtns">
        <button id="pickerClear" class="secondary" type="button">全クリア</button>
        <button id="pickerOk"    type="button">決定</button>
        <button id="pickerClose" class="secondary" type="button">キャンセル</button>
      </div>
    </div>
    <div id="pickerList" class="suggList"></div>
  </div>
</div>


<!-- ========= タイマー/控室/名簿 & ピッカー ========= -->
<script type="module">
  import { getApps } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import {
    getFirestore, collection, doc, setDoc, onSnapshot, serverTimestamp, addDoc
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
  // 文字エスケープ（このモジュール用に定義）
const esc = s => String(s).replace(/[&<>"']/g, m => ({
  "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
}[m]));


  // すでに初期化済みの app を取得
   // 先に「幹部ロジック」側の初期化/認証完了を待つ
   if (window.__authReady) await window.__authReady;
   // それでも間に合わない場合に備えて、getApps() が埋まるまで待機
   if (!getApps().length) {
     await new Promise(res => {
       const id = setInterval(() => {
         if (getApps().length) { clearInterval(id); res(); }
       }, 30);
     });
   }
   const app = getApps()[0] || window.firebaseApp;  // 念のためフォールバック
   const db  = getFirestore(app);
  const ROOM_ID = "dev";
  const seatsCol = collection(db, 'rooms', ROOM_ID, 'seats');
  const dutyCol  = collection(db, 'rooms', ROOM_ID, 'duty');

  // このブロックでも pushSeatToFS が必要（別スコープなので再定義）
  async function pushSeatToFS(s){
    try{
      await setDoc(
        doc(seatsCol, s.id),
        {
          id:s.id, group:s.group, label:s.label||'',
          cast:s.cast||'', boy:s.boy||'',
          end: s.end ?? null, finished: !!s.finished,
          extendCount: Number(s.extendCount||0),
          updatedAt: serverTimestamp(),
        },
        { merge:true }
      );
    }catch(e){ console.error('[seats] write failed', e); }
  }

  /* ←以下、あなたの既存コード（座席・UI 等）をそのまま続ける */

  /* === 設定 ほか（ここは従来どおり）=== */

  const LS_PREFIX = 'tt-dev-';
  window.LS_PREFIX = LS_PREFIX;

  /* === 席データ === */
  const seats = (()=>{ 
    const saved=localStorage.getItem(LS_PREFIX+'seats.v2');
    if(saved){
      const arr=JSON.parse(saved);
      arr.forEach(s=>{
        if(s.finished===undefined) s.finished=false;
        if(s.extendCount===undefined) s.extendCount=0;
      });
      return arr;
    }
    const a=[];
    for(let i=1;i<=8;i++) a.push({id:`R${i}`,group:'red',label:`VIP ${i}`,cast:'',boy:'',end:null,finished:false,extendCount:0});
    for(let i=1;i<=7;i++) a.push({id:`B${i}`,group:'blue',label:`ノーマル ${i}`,cast:'',boy:'',end:null,finished:false,extendCount:0});
    for(let i=1;i<=3;i++) a.push({id:`V${i}`,group:'vip',label:`超VIP ${i}`,cast:'',boy:'',end:null,finished:false,extendCount:0});
    return a;
  })();

  const save = () => localStorage.setItem(LS_PREFIX+'seats.v2', JSON.stringify(seats));

  /* === 座標 / 要素参照 / UI生成群（元コードそのまま）=== */
  const POS={R8:{top:15,left:25,width:13},R7:{top:15,left:39,width:13},R6:{top:15,left:53,width:13},R5:{top:15,left:67,width:13},
    R1:{top:30,left:67,width:13},R2:{top:45,left:67,width:13},R3:{top:30,left:18,width:13},R4:{top:45,left:18,width:13},
    B1:{top:22,left:87,width:10},B2:{top:36,left:87,width:10},B3:{top:50,left:87,width:10},B4:{top:7,left:2,width:10},B5:{top:7,left:12,width:10},B6:{top:65,left:7,width:11},B7:{top:65,left:84,width:11}};

  const $=s=>document.querySelector(s);
  const floor=$('#floor'), vipWrap=$('#vip'), nowEl=$('#now');
  const wrap=$('#modalWrap'), title=$('#modalTitle');
  const castI=$('#cast'), boyI=$('#boy'), manI=$('#manual');
  const suggCast=$('#suggCast'), suggBoy=$('#suggBoy');
  let currentId=null, lastFocus=null;
  const pageRoots=document.querySelectorAll('header, main');

  function cardHTML(s){
    const nameByGroup={red:'VIP',blue:'ノーマル',vip:'超VIP'};
    const num=(s.id.match(/\d+/)||[''])[0];
    const label=`${nameByGroup[s.group]||s.label} ${num}`;
    const endAt=s.end?`～ ${formatClock(s.end)}`:'';
    const ext = (s.extendCount||0)>0 ? `<span class="extBadge">延×${s.extendCount}</span>` : '';
    return `
      <div class="line1">
        <span>${label}</span>
        <span class="endAt">${endAt}</span>
      </div>
      <div class="timer"><span class="remain">${
        s.end ? formatRemain(s.end-Date.now()) : (s.finished ? '終了' : '空')
      }</span>${ext}</div>
      <div class="meta">${(s.cast||'')}${s.boy?' ｜ '+s.boy:''}</div>`;
  }
  function addVipSeat(s){
    const d=document.createElement('div');
    d.className='vipSeat';
    d.dataset.id=s.id;
    d.innerHTML=cardHTML(s);
    d.addEventListener('click',()=>openModal(s.id));
    vipWrap.appendChild(d);
  }
  function addSeatToFloor(s){
    const pos=POS[s.id]; if(!pos) return;
    const d=document.createElement('div');
    d.className=`seat ${s.group}`;
    d.dataset.id=s.id;
    d.style.top=pos.top+'%';
    d.style.left=pos.left+'%';
    d.style.width=pos.width+'%';
    d.innerHTML=cardHTML(s);
    d.addEventListener('click',()=>openModal(s.id));
    floor.appendChild(d);
  }
  function resizeFloor(){
    const pad=12;
    const needed=vipWrap.offsetTop+vipWrap.offsetHeight+pad;
    floor.style.height=needed+'px';
  }

  // === Firestoreから座席状態を購読して seats[] に反映 ===
onSnapshot(seatsCol, (qs)=>{
  const byId = new Map(seats.map(x => [x.id, x]));  // 既存配列をベースに上書き
  qs.forEach(docSnap=>{
    const d = docSnap.data() || {};
    const target = byId.get(docSnap.id);
    if (target){
      target.cast = d.cast || '';
      target.boy  = d.boy  || '';
      target.end  = (typeof d.end === 'number' || d.end === null) ? d.end : null;
      target.finished    = !!d.finished;
      target.extendCount = Number(d.extendCount||0);
    }
  });
  save();     // ローカル保持（復帰用）
  render();   // UI更新
});


  function render(){
    floor.querySelectorAll('.seat').forEach(n=>n.remove());
    vipWrap.innerHTML='';
    const q=$('#q').value.trim();

    seats.forEach(s=>{ if(s.group==='vip') addVipSeat(s); else addSeatToFloor(s); });

    floor.querySelectorAll('[data-id]').forEach(el=>{
      const s=seats.find(x=>x.id===el.dataset.id); const t=el.querySelector('.remain');
      el.classList.remove('active','warn','danger','highlight');
      if(s.end){
        const r=s.end-Date.now();
        if(r>0){ t.textContent=formatRemain(r); el.classList.add('active'); if(r<=3*60*1000)el.classList.add('danger'); else if(r<=10*60*1000)el.classList.add('warn'); }
        else { s.end=null; s.finished=true; save(); t.textContent='終了'; }
      }else{ t.textContent=s.finished?'終了':'空'; }
      if(q && s.cast && s.cast.includes(q)) el.classList.add('highlight');
    });
    resizeFloor(); renderRoster();
  }

  function tick(){
    nowEl.textContent=new Date().toLocaleString('ja-JP',{hour12:false});
    floor.querySelectorAll('[data-id]').forEach(el=>{
      const s=seats.find(x=>x.id===el.dataset.id); const t=el.querySelector('.remain');
      el.classList.remove('active','warn','danger');
      const endAtEl=el.querySelector('.endAt'); if(endAtEl) endAtEl.textContent=s.end?`～ ${formatClock(s.end)}`:'';
      if(!s.end){ t.textContent=s.finished?'終了':'空'; return; }
      const r=s.end-Date.now(); if(r<=0){ s.end=null; s.finished=true; save(); t.textContent='終了'; return; }
      t.textContent=formatRemain(r); el.classList.add('active');
      if(r<=3*60*1000) el.classList.add('danger'); else if(r<=10*60*1000) el.classList.add('warn');
    });
    if(staff.length) renderRoster();
  }

  function formatRemain(ms){const s=Math.floor(ms/1000),h=Math.floor(s/3600),m=Math.floor((s%3600)/60),ss=s%60;return (h?String(h).padStart(2,'0')+':':'')+String(m).padStart(2,'0')+':'+String(ss).padStart(2,'0');}
  function formatClock(ts){let ms=null;if(ts==null)return'';if(typeof ts==='number')ms=ts;else if(typeof ts==='string'&&/^\d+$/.test(ts))ms=Number(ts);else if(typeof ts==='object'&&typeof ts.toMillis==='function')ms=ts.toMillis();else if(typeof ts==='object'&&typeof ts.seconds==='number')ms=ts.seconds*1000+Math.floor((ts.nanoseconds||0)/1e6);const d=new Date(ms);if(Number.isNaN(d.getTime()))return'';return d.toLocaleTimeString('ja-JP',{hour12:false,hour:'2-digit',minute:'2-digit'});}

  /* === モーダル === */
  function openModal(id){
    lastFocus=document.activeElement; const s=seats.find(x=>x.id===id); currentId=id;
    const nameByGroup={red:'VIP',blue:'ノーマル',vip:'超VIP'}; const num=(s.id.match(/\d+/)||[''])[0];
    title.textContent=`席を編集：${nameByGroup[s.group]||s.label} ${num}`;
    castI.value=s.cast||''; boyI.value=s.boy||''; manI.value='';
    pageRoots.forEach(el=>el.setAttribute('inert',''));
    wrap.removeAttribute('aria-hidden'); wrap.hidden=false; wrap.style.display='grid';
    fillSuggestionBlocks(); requestAnimationFrame(()=>castI.focus());
  }
  function closeModal(){
    const fallback=document.getElementById('q')||document.body;
    if(wrap.contains(document.activeElement)){ (lastFocus && document.contains(lastFocus)?lastFocus:fallback).focus(); }
    pageRoots.forEach(el=>el.removeAttribute('inert'));
    wrap.setAttribute('aria-hidden','true'); wrap.hidden=true; wrap.style.display='none';
  }
  document.addEventListener('click',e=>{ if(e.target?.id==='close' || e.target===wrap) closeModal(); });

  document.getElementById('saveMeta').addEventListener('click', ()=>{
    const s=seats.find(x=>x.id===currentId); s.cast=castI.value.trim(); s.boy=boyI.value.trim(); save(); render(); closeModal();
  });

// 開始（手入力）
document.getElementById('start').addEventListener('click', async ()=>{
  const v=Number(manI.value); if(!v||v<=0) return alert('分数を入力してください');
  const s=seats.find(x=>x.id===currentId);
  s.cast=castI.value.trim(); s.boy=boyI.value.trim();
  s.end=Date.now()+v*60*1000; s.finished=false; s.extendCount=0;
  save(); render();
  await pushSeatToFS(s);   // ← await OK
  closeModal();
});

// クイック開始
document.querySelectorAll('button.quick').forEach(b=>b.addEventListener('click', async ()=>{
  const mins=Number(b.dataset.min); const s=seats.find(x=>x.id===currentId);
  s.cast=castI.value.trim(); s.boy=boyI.value.trim();
  s.end=Date.now()+mins*60*1000; s.finished=false; s.extendCount=0;
  save(); render();
  await pushSeatToFS(s);   // ← await OK
  closeModal();
}));

// 延長
document.querySelectorAll('button.extend').forEach(b=>b.addEventListener('click', async ()=>{
  const mins=Number(b.dataset.min); const s=seats.find(x=>x.id===currentId);
  const base=s.end && s.end>Date.now()? s.end:Date.now();
  s.end=base+mins*60*1000; s.finished=false;
  s.extendCount=(s.extendCount||0)+1;
  if(!s.cast) s.cast=castI.value.trim(); if(!s.boy) s.boy=boyI.value.trim();
  save(); render();
  await pushSeatToFS(s);   // ← await OK
  closeModal();
}));

// クリア
document.getElementById('seatClear')?.addEventListener('click', async ()=>{
  if (!currentId) return;
  const s = seats.find(x => x.id === currentId);
  if (!s) return;

  // この席だけを空席に
  s.end = null;
  s.cast = '';
  s.boy  = '';
  s.finished = false;
  s.extendCount = 0;

  // ローカルとFirestoreもこの席だけ更新
  save();
  render();
  await pushSeatToFS(s);
  closeModal();
});



/* ====== 席モーダル：売上タブ ====== */
const SALES_GAS_URL = 'https://script.google.com/macros/s/AKfycbwP_n70AlN5TrYvpVRR_tdaOJ8umm61B7bW_s-RQZ1cCeGBkIai3RlgLrbWK7ztPn5Z/exec';
const yen = n => new Intl.NumberFormat('ja-JP',{style:'currency',currency:'JPY'}).format(Number(n||0));

const tabTimer = document.getElementById('tabTimer');
const tabSales = document.getElementById('tabSales');
const seatSalesEl = document.getElementById('seatSales');
const prodGrid = document.getElementById('prodGrid');
const prodSearch = document.getElementById('prodSearch');
const seatSalesList = document.getElementById('seatSalesList');
const seatSalesTotal = document.getElementById('seatSalesTotal');
const seatSalesSend = document.getElementById('seatSalesSend');
const seatSalesBack = document.getElementById('seatSalesBack');

let PRODUCTS_ON = []; // Firestore products（active!==false）
const pdColForTimer = collection(db,'rooms',ROOM_ID,'products');
onSnapshot(pdColForTimer,(qs)=>{
  const rows=[]; qs.forEach(d=>rows.push({id:d.id,...(d.data()||{})}));
  PRODUCTS_ON = rows.filter(p=>p.active!==false).map(p=>({name:p.name, price:Number(p.price||0)}))
                    .sort((a,b)=> String(a.name).localeCompare(String(b.name),'ja'));
  buildProdGrid();
});

function buildProdGrid(q=''){
  const list = PRODUCTS_ON.filter(p => !q || p.name.includes(q));
  prodGrid.innerHTML = list.map(p => `
    <button type="button" class="prodChip" data-name="${esc(p.name)}" data-price="${p.price}">
      ${esc(p.name)}（${yen(p.price)}）
    </button>
  `).join('');
  prodGrid.querySelectorAll('.prodChip').forEach(btn=>{
    btn.addEventListener('click',()=>{
      addItemToSeat(currentId, { product: btn.dataset.name, unitPrice: Number(btn.dataset.price) });
      renderSeatSales(currentId);
    });
  });
}
prodSearch?.addEventListener('input', e => buildProdGrid((e.target.value||'').trim()));

/* 1席ごとの仮売上をローカル保持 */
const SALES_LS_PREFIX = LS_PREFIX + 'seat.sales.';
function loadSeatSales(seatId){
  try{ return JSON.parse(localStorage.getItem(SALES_LS_PREFIX+seatId)||'{}'); }catch(_){ return {}; }
}
function saveSeatSales(seatId, data){
  localStorage.setItem(SALES_LS_PREFIX+seatId, JSON.stringify(data||{}));
}

/* 商品追加（同一商品は数量+1） */
function addItemToSeat(seatId, {product, unitPrice}){
  const data = loadSeatSales(seatId);
  data.items = Array.isArray(data.items) ? data.items : [];
  const found = data.items.find(x=>x.product===product && Number(x.unitPrice)===Number(unitPrice));
  if(found){ found.qty = Number(found.qty||0)+1; }
  else{ data.items.push({product, unitPrice:Number(unitPrice||0), qty:1}); }
  saveSeatSales(seatId, data);
}

/* 数量変更・削除 */
function setQty(seatId, idx, qty){
  const data = loadSeatSales(seatId);
  if(!Array.isArray(data.items)) return;
  if(qty<=0){ data.items.splice(idx,1); }
  else{ data.items[idx].qty = qty; }
  saveSeatSales(seatId, data);
}

/* 合計計算＋描画 */
function renderSeatSales(seatId){
  const data = loadSeatSales(seatId);
  const items = Array.isArray(data.items) ? data.items : [];
  seatSalesList.innerHTML = items.map((it, i)=>`
    <div class="salesItem" data-idx="${i}">
      <div>${esc(it.product)}</div>
      <div class="yen">${yen(it.unitPrice)}</div>
      <div class="qtyCtrl">
        <button type="button" class="qminus">－</button>
        <input type="number" min="0" step="1" value="${Number(it.qty||0)}">
        <button type="button" class="qplus">＋</button>
      </div>
      <div class="yen">${yen(it.unitPrice * Number(it.qty||0))}</div>
    </div>
  `).join('');

  seatSalesList.querySelectorAll('.salesItem').forEach(row=>{
    const idx = Number(row.dataset.idx||0);
    const input = row.querySelector('input');
    row.querySelector('.qminus').addEventListener('click',()=>{
      const v = Math.max(0, Number(input.value||0)-1);
      input.value = v; setQty(seatId, idx, v); renderSeatSales(seatId);
    });
    row.querySelector('.qplus').addEventListener('click',()=>{
      const v = Number(input.value||0)+1;
      input.value = v; setQty(seatId, idx, v); renderSeatSales(seatId);
    });
    input.addEventListener('input',()=>{
      const v = Math.max(0, Number(input.value||0));
      setQty(seatId, idx, v); renderSeatSales(seatId);
    });
  });

  const total = items.reduce((a,b)=> a + Number(b.unitPrice||0)*Number(b.qty||0), 0);
  seatSalesTotal.textContent = yen(total);
}

/* タブ切替 */
function useTimerTab(){ tabTimer.classList.add('active'); tabSales.classList.remove('active'); seatSalesEl.classList.remove('show'); seatSalesEl.setAttribute('aria-hidden','true'); }
function useSalesTab(){ tabSales.classList.add('active'); tabTimer.classList.remove('active'); seatSalesEl.classList.add('show'); seatSalesEl.removeAttribute('aria-hidden'); buildProdGrid(); renderSeatSales(currentId); }
tabTimer?.addEventListener('click', useTimerTab);
tabSales?.addEventListener('click', useSalesTab);
seatSalesBack?.addEventListener('click', useTimerTab);

/* モーダルを開いた時点で売上タブを初期化できるように openModal の末尾に1行足す */
const _openModalOrig = openModal;
openModal = function(id){
  _openModalOrig(id);
  // タブ初期位置はタイマー
  useTimerTab();
  // 商品検索をリセット
  if(prodSearch) prodSearch.value='';

  const firstRow = seatSalesList.querySelector('.salesItem');
if (firstRow) {
  const h = Math.ceil(firstRow.getBoundingClientRect().height);
  seatSalesList.style.setProperty('--rowH', h + 'px'); // 8行分に効く
}
};


/* 送信（Firestoreへ保存） */
seatSalesSend?.addEventListener('click', async ()=>{
  const seat = seats.find(x=>x.id===currentId);
  const data = loadSeatSales(currentId);
  const items = (data.items||[]).filter(it=>it.product && Number(it.qty)>0);
  if(items.length===0){ alert('明細がありません'); return; }

  const cast = (castI.value||'').split(',').map(v=>v.trim()).filter(Boolean);
  const boy  = (boyI.value||'').trim();
  const total = items.reduce((a,b)=>a + Number(b.unitPrice||0)*Number(b.qty||0), 0);

  const payload = {
    seatId: seat?.id || '',
    seatLabel: seat?.label || '',
    rows: items.map(it=>({
      product: it.product,
      unitPrice: Number(it.unitPrice||0),
      qty: Number(it.qty||0),
      amount: Number(it.unitPrice||0)*Number(it.qty||0)
    })),
    cast, boy, total,
    createdAt: serverTimestamp()
  };

  try{
    const salesCol = collection(db,'rooms',ROOM_ID,'sales');
    await addDoc(salesCol, payload);
    alert('登録しました（幹部→売上一覧に反映）');

    // この席の仮売上はクリア
    saveSeatSales(currentId, { items:[] });
    renderSeatSales(currentId);
    useTimerTab();
  }catch(e){
    console.error(e);
    alert('保存エラー: ' + (e?.message || e));
  }
});




  document.getElementById('q').addEventListener('input', render);

  /* === CSV/名簿 === */
  function parseCSV(str){const rows=[];let cur=[],val='',inQ=false;for(let i=0;i<str.length;i++){const c=str[i];if(inQ){if(c=='"'){if(str[i+1]=='"'){val+='"';i++;}else inQ=false;}else val+=c;}else{if(c=='"'){inQ=true;}else if(c==','){cur.push(val);val='';}else if(c=='\n'){cur.push(val);rows.push(cur);cur=[];val='';}else if(c=='\r'){}else val+=c;}} if(val.length>0||cur.length>0){cur.push(val);rows.push(cur);} return rows;}
  function parseStaffNamesFromCSV(csv){
    const rowsRaw=parseCSV(csv); const rows=rowsRaw.filter(r=>r&&r.some(c=>(c||'').trim()!==''));
    if(!rows.length) return [];
    let headerRowIdx=-1,nameIdx=-1; const MAX_SCAN=Math.min(rows.length,10);
    for(let i=0;i<MAX_SCAN;i++){const idx=rows[i].findIndex(c=>String(c||'').trim()==='従業員'); if(idx>=0){headerRowIdx=i;nameIdx=idx;break;}}
    if(headerRowIdx<0) headerRowIdx=0; if(nameIdx<0) nameIdx=12;
    const names=rows.slice(headerRowIdx+1).map(r=>(r[nameIdx]||'').trim()).filter(v=>v&&v!=='従業員'); return [...new Set(names)];
  }
  let staff=[]; let dutyMap=JSON.parse(localStorage.getItem(LS_PREFIX+'staff.duty.map')||'{}'); window.staff=staff; window.dutyMap=dutyMap;

  // staff コレクション購読（控室の名簿はここから作る）


const stColForRoster = collection(db, 'rooms', ROOM_ID, 'staff');

onSnapshot(stColForRoster, (qs)=>{
  const next = [];

  qs.forEach(docSnap=>{
    const d = docSnap.data() || {};
    // active=false は表示しない（既定は true 扱い）
    if (d.active === false) return;

    const name = (d.name || docSnap.id || '').trim();
    if (!name) return;

    const role = d.role || 'cast';
    // 解雇は現場UIから除外（控室・ピッカー等に出さない）
    if (role === 'fired') return;
    // staffドキュメントの duty は boolean想定（省略可）
    // 役職ごとに {cast,boy} へマップ（cast: true/false, boy: true/false）
    const dutyBool = !!d.duty;
    const fallbackDuty =
      role === 'boy'  ? { cast:false, boy:dutyBool }
    : role === 'cast' ? { cast:dutyBool, boy:false }
                      : { cast:false,   boy:false };

    // dutyCol の最新があればそれを優先
    const dutyObj = dutyMap[name] ?? fallbackDuty;

    next.push({ name, role, duty: dutyObj });
  });

  // 表示用に名前順
  next.sort((a,b)=> String(a.name||'').localeCompare(String(b.name||''), 'ja'));

  // staff[] を差し替え
  staff.splice(0, staff.length, ...next);
  window.staff = staff;

  // 既存UIを更新
  fillDatalists();
  renderRoster();
  if (typeof window.renderSalesFields === 'function') window.renderSalesFields();
});


  // === Firestoreから出勤フラグ(duty)を購読 ===
  let salesUIReady = false;
onSnapshot(dutyCol, (qs)=>{
  const next = {};
  qs.forEach(docSnap=>{
    const d = docSnap.data() || {};
    const dutyObj =
      (typeof d.duty === 'object' && d.duty)
        ? { cast: !!d.duty.cast, boy: !!d.duty.boy }
        : (typeof d.duty === 'boolean'
            ? { cast: d.duty, boy: d.duty }   // 後方互換：boolean は両方ON扱い（運用に合わせて調整OK）
            : { cast:false, boy:false });
    next[docSnap.id] = dutyObj;
  });
  dutyMap = next;
  localStorage.setItem(LS_PREFIX+'staff.duty.map', JSON.stringify(dutyMap));
  staff.forEach(s => { s.duty = dutyMap[s.name] || {cast:false,boy:false}; });
  fillDatalists(); renderRoster();
  if (salesUIReady && typeof window.renderSalesFields === 'function') window.renderSalesFields();
});



  
async function toggleDuty(name){
  const next = !dutyMap[name];
  dutyMap[name] = next;
  localStorage.setItem(LS_PREFIX+'staff.duty.map', JSON.stringify(dutyMap)); // 一応ローカルも更新
  // 画面先行更新
  staff.forEach(s=>{ if(s.name===name) s.duty=next; });
  fillDatalists(); renderRoster();

  try{
    await setDoc(
      doc(dutyCol, name.replace(/\//g,'／')),
      { duty: next, updatedAt: serverTimestamp() },
      { merge: true }
    );
  }catch(e){
    console.error('[duty] write failed', e);
  }
}

  async function toggleDutyRole(name, role /* 'cast' | 'boy' */){
  const cur = dutyMap[name] || {cast:false,boy:false};
  const next = { ...cur, [role]: !cur[role] };
  dutyMap[name] = next;
  localStorage.setItem(LS_PREFIX+'staff.duty.map', JSON.stringify(dutyMap));
  staff.forEach(s=>{ if(s.name===name) s.duty = next; });
  fillDatalists(); renderRoster();
  try{
    await setDoc(
      doc(dutyCol, name.replace(/\//g,'／')),
      { duty: next, updatedAt: serverTimestamp() },
      { merge: true }
    );
  }catch(e){ console.error('[duty] write failed', e); }
}


  function isNameBusy(name){
    name=name.trim();
    return seats.some(s=>{
      const castNames=(s.cast||'').split(',').map(x=>x.trim()).filter(Boolean);
      if(castNames.includes(name) || (s.boy||'').trim()===name){ return !!(s.end || s.finished); }
      return false;
    });
  }
  function addCastName(name){
    const list=castI.value.split(',').map(v=>v.trim()).filter(Boolean);
    if(!list.includes(name)){ list.push(name); castI.value=list.join(', '); }
  }


  // Roster（本鯖式）
function renderRoster(){
  const boxCast = document.getElementById('rosterCast');
  const boxBoy  = document.getElementById('rosterBoy');
  if(!boxCast || !boxBoy) return;

  boxCast.innerHTML = '';
  boxBoy.innerHTML  = '';

  if(!staff.length){
    const small = document.createElement('div');
    small.style.color = '#64748b';
    small.style.fontSize = '12px';
    small.textContent = '（従業員が未登録です。幹部→従業員管理から追加してください）';
    boxCast.appendChild(small.cloneNode(true));
    boxBoy.appendChild(small);
    return;
  }

  const isEditCast = !!document.getElementById('editDutyCast')?.checked;
  const isEditBoy  = !!document.getElementById('editDutyBoy')?.checked;
  const qCast = (document.getElementById('searchCast')?.value || '').trim();
  const qBoy  = (document.getElementById('searchBoy') ?.value || '').trim();

  const addChip = (root, name, {on, busy, role, isEdit})=>{
    const b = document.createElement('button');
    b.type = 'button';
    b.className = `staffChip ${on ? (busy ? 'busy' : 'on') : 'off'}`;
    b.textContent = name;

    if(isEdit){
      // 出勤編集：列に応じた duty をトグル
      b.disabled = false;
      b.addEventListener('click', ()=>toggleDutyRole(name, role));
    }else{
      // 通常：席モーダル割当（モーダルが開いてる時のみ）
      if(!on){ b.disabled = true; }
      else{
        b.addEventListener('click', ()=>{
          const open = (document.getElementById('modalWrap')?.getAttribute('aria-hidden') === 'false');
          if(!open) return;
          if(role === 'boy'){ boyI.value = name; boyI.focus(); }
          else{
            const list = castI.value.split(',').map(v=>v.trim()).filter(Boolean);
            if(!list.includes(name)) castI.value = [...list, name].join(', ');
            castI.focus();
          }
        });
      }
    }
    root.appendChild(b);
  };

  // 検索関数
  const byQuery = (q) => (s) => !q || s.name.includes(q);

  // 左カラム（キャスト）
  const onCast  = staff.filter(s => s.duty?.cast === true).filter(byQuery(qCast));
  const offCast = isEditCast ? staff.filter(s => s.duty?.cast !== true).filter(byQuery(qCast)) : [];

  onCast.forEach(s => addChip(boxCast, s.name, {on:true, busy:isNameBusy(s.name), role:'cast', isEdit:isEditCast}));
  if(offCast.length){
    const t = document.createElement('div'); t.className='staffSectionTitle'; t.textContent='— 非出勤 —';
    boxCast.appendChild(t);
    offCast.forEach(s => addChip(boxCast, s.name, {on:false, busy:false, role:'cast', isEdit:isEditCast}));
  }

  // 右カラム（ボーイ/スタッフ）
  const onBoy  = staff.filter(s => s.duty?.boy === true).filter(byQuery(qBoy));
  const offBoy = isEditBoy ? staff.filter(s => s.duty?.boy !== true).filter(byQuery(qBoy)) : [];

  onBoy.forEach(s => addChip(boxBoy, s.name, {on:true, busy:isNameBusy(s.name), role:'boy', isEdit:isEditBoy}));
  if(offBoy.length){
    const t = document.createElement('div'); t.className='staffSectionTitle'; t.textContent='— 非出勤 —';
    boxBoy.appendChild(t);
    offBoy.forEach(s => addChip(boxBoy, s.name, {on:false, busy:false, role:'boy', isEdit:isEditBoy}));
  }
}



function fillDatalists(){
  const castDL=document.getElementById('castList');
  const boyDL =document.getElementById('boyList');
  const castOn=(staff||[]).filter(s=>s.duty?.cast).map(s=>s.name);
  const boyOn =(staff||[]).filter(s=>s.duty?.boy ).map(s=>s.name);
  castDL.innerHTML=castOn.map(n=>`<option value="${n}">`).join('');
  boyDL .innerHTML=boyOn .map(n=>`<option value="${n}">`).join('');
}
function fillSuggestionBlocks(){
  const castOn=(staff||[]).filter(s=>s.duty?.cast).map(s=>s.name);
  const boyOn =(staff||[]).filter(s=>s.duty?.boy ).map(s=>s.name);

  // キャスト（チップ描画）
  suggCast.innerHTML = castOn
    .map(n => `<button type="button" class="staffChip on" data-name="${n}">${n}</button>`)
    .join('');
  // クリック → キャスト欄へ追加（重複は入れない）
  suggCast.querySelectorAll('button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const name = btn.dataset.name || '';
      const list = castI.value.split(',').map(v=>v.trim()).filter(Boolean);
      if (!list.includes(name)) {
        list.push(name);
        castI.value = list.join(', ');
      }
      castI.focus();
    });
  });

  // ボーイ（チップ描画）
  suggBoy.innerHTML = boyOn
    .map(n => `<button type="button" class="staffChip on" data-name="${n}">${n}</button>`)
    .join('');
  // クリック → ボーイ欄へセット（1人だけ）
  suggBoy.querySelectorAll('button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const name = btn.dataset.name || '';
      boyI.value = name;
      boyI.focus();
    });
  });
}




/* === 売上ピッカー（UI側の選択だけ）=== 
   ※ boyField / castField が無い画面（今回の構成）では何もしないようにガードする
*/
(() => {
  const boyField    = document.getElementById('boyField');
  const castField   = document.getElementById('castField');
  const pickerWrap  = document.getElementById('pickerWrap');
  const pickerTitle = document.getElementById('pickerTitle');
  const pickerList  = document.getElementById('pickerList');
  const pickerOk    = document.getElementById('pickerOk');
  const pickerClear = document.getElementById('pickerClear');
  const pickerClose = document.getElementById('pickerClose');

  // 外で参照しているフラグと関数（存在しないUIなら安全にno-op）
  if (!boyField || !castField) {
    window.renderSalesFields = () => {};
    // dutyスナップショット側で呼ぶ「準備OKフラグ」も false のままにする
    // （上流で let salesUIReady = false; と宣言されている前提）
    return; 
  }

  // ここから先はフィールドがある場合のみ有効化
  let salesBoy = '';
  let salesCast = [];
  window.salesBoy = salesBoy;
  window.salesCast = salesCast;

  let pickerMode = null;
  let tmpBoy = '';
  let tmpCast = [];

  function renderSalesFields(){
    // 上流の window から値を拾う（他所で変更されている可能性に対応）
    if (typeof window.salesBoy !== 'undefined') salesBoy = window.salesBoy;
    if (Array.isArray(window.salesCast)) salesCast = [...window.salesCast];

    // ピル表示
    boyField.classList.toggle('empty', !salesBoy);
    boyField.innerHTML = salesBoy ? `<span class="pill">${salesBoy}</span>` : 'タップして選択';

    castField.classList.toggle('empty', salesCast.length===0);
    castField.innerHTML = salesCast.length 
      ? salesCast.map(n=>`<span class="pill">${n}</span>`).join('')
      : 'タップして選択';
  }
  window.renderSalesFields = renderSalesFields;

  // 準備OK（dutyスナップショット側で renderSalesFields を呼べるように）
  salesUIReady = true;

  // フィールドクリックでピッカーを開く
  boyField.addEventListener('click', ()=>openPicker('boy'));
  castField.addEventListener('click', ()=>openPicker('cast'));

  function openPicker(mode){
    pickerMode = mode;
    pickerTitle.textContent = (mode==='boy') ? 'ボーイを選択（1名）' : 'キャストを選択（複数可）';
    tmpBoy  = salesBoy;
    tmpCast = [...salesCast];
    buildPickerList();
    pickerWrap.style.display='grid';
    pickerWrap.removeAttribute('aria-hidden');
  }
  function closePicker(){ pickerWrap.style.display='none'; pickerWrap.setAttribute('aria-hidden','true'); }
  pickerWrap.addEventListener('click', e=>{ if(e.target===pickerWrap) closePicker(); });
  pickerClose.addEventListener('click', closePicker);
  pickerClear.addEventListener('click', ()=>{
    if(pickerMode==='boy') tmpBoy=''; else tmpCast=[];
    buildPickerList();
  });
  pickerOk.addEventListener('click', ()=>{
    if (pickerMode==='boy') salesBoy = tmpBoy;
    else salesCast = [...tmpCast];
    window.salesBoy = salesBoy;
    window.salesCast = salesCast;
    renderSalesFields();
    closePicker();
  });

  function isNameBusy(name){
    name=name.trim();
    return seats.some(s=>{
      const castNames=(s.cast||'').split(',').map(x=>x.trim()).filter(Boolean);
      if(castNames.includes(name) || (s.boy||'').trim()===name){ return !!(s.end || s.finished); }
      return false;
    });
  }

  function buildPickerList(){
    let onList=[];
    if (pickerMode==='boy'){
      onList=(window.staff||[]).filter(s=>s.duty?.boy).map(s=>({name:s.name, busy:isNameBusy(s.name)}));
    }else{
      onList=(window.staff||[]).filter(s=>s.duty?.cast).map(s=>({name:s.name, busy:isNameBusy(s.name)}));
    }
    pickerList.innerHTML = onList.map(x=>{
      const selected = (pickerMode==='boy') ? (tmpBoy===x.name) : tmpCast.includes(x.name);
      return `<button type="button" class="staffChip ${x.busy?'busy':'on'} ${selected?'selected':''}" data-name="${x.name}">${x.name}</button>`;
    }).join('');
    pickerList.querySelectorAll('button').forEach(b=>{
      b.addEventListener('click', ()=>{
        const name=b.dataset.name;
        if(pickerMode==='boy'){ tmpBoy = (tmpBoy===name) ? '' : name; }
        else { if(tmpCast.includes(name)) tmpCast = tmpCast.filter(n=>n!==name); else tmpCast = [...tmpCast, name]; }
        buildPickerList();
      });
    });
  }
})();



function buildPickerList(){
  let onList=[];
  if (pickerMode==='boy'){
    onList=(window.staff||[]).filter(s=>s.duty?.boy).map(s=>({name:s.name, busy:isNameBusy(s.name)}));
  }else{
    onList=(window.staff||[]).filter(s=>s.duty?.cast).map(s=>({name:s.name, busy:isNameBusy(s.name)}));
  }
  pickerList.innerHTML = onList.map(x=>{
    const selected = (pickerMode==='boy') ? (tmpBoy===x.name) : tmpCast.includes(x.name);
    return `<button type="button" class="staffChip ${x.busy?'busy':'on'} ${selected?'selected':''}" data-name="${x.name}">${x.name}</button>`;
  }).join('');
  pickerList.querySelectorAll('button').forEach(b=>{
    b.addEventListener('click', ()=>{
      const name=b.dataset.name;
      if(pickerMode==='boy'){ tmpBoy = (tmpBoy===name) ? '' : name; }
      else { if(tmpCast.includes(name)) tmpCast = tmpCast.filter(n=>n!==name); else tmpCast = [...tmpCast, name]; }
      buildPickerList();
    });
  });
}


  /* === 初期化 === */
  render(); setInterval(tick,1000); window.addEventListener('resize', resizeFloor);
  
</script>




  <!-- ========= ルーター（最後に1本だけ） ========= -->
<script>
  function route(){
    let hash = location.hash || '#timer';
    // 旧URLの #sales で来た場合は #timer へ誘導
    if (hash === '#sales') {
      location.hash = '#timer';
      hash = '#timer';
    }
    const isAdmin = hash.startsWith('#admin');
    const isTimer = !isAdmin;  // それ以外は全部タイマー扱い

    const show=(id,on)=>{const el=document.getElementById(id); if(el) el.style.display=on?'block':'none';};
    const active=(id,on)=>{const el=document.getElementById(id); if(el) el.classList.toggle('active',!!on);};

    show('pageTimer', isTimer);
    show('pageAdmin', isAdmin);

    active('navTimer', isTimer);
    active('navAdmin', isAdmin);

    window.scrollTo(0,0);
  }
window.addEventListener('hashchange', ()=>{
  route();  // ←これが抜けていた！
  if (location.hash.startsWith('#admin-sales')) {
    // これらがグローバルで未定義の環境でも落ちないようガード
    if (window.renderSalesGroupedByBizDay && window.getSalesDayFromHash) {
      renderSalesGroupedByBizDay(SALES_ROWS_CACHE, getSalesDayFromHash());
    }
  }
});
route();
</script>


</body>
</html>
